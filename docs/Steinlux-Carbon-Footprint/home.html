<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>居住</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/all.css" />
    <link rel="stylesheet" href="css/story.css" />
    <style>

      /* 第一頁 */

      .home-card {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 2rem;
      }

      .toggle-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.65rem;
      }

      .toggle-card .question-title {
        font-family: "GenSenRounded2TW-R", sans-serif;
        color: #9c7a5c;
        margin-bottom: 1rem;
        line-height: 1.2;
        white-space: nowrap;
      }

      /* input 框樣式 */

      .toggle-card .input-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      /* 切換單位按鈕 */
      .toggle-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        max-width: 70%;
        border-radius: 1rem;
        padding: 1.5rem 3rem;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.4);
        box-shadow: -4pt -4pt 5pt #ffffff46, 5pt 5pt 10pt #c3cadb76;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }

      span.label {
        font-family: "GenSenRounded2TW-R", sans-serif;
        color: #9c7a5c;
        white-space: nowrap;
        text-align: left;
        width: 48px;
      }

      .nowrap-text {
        color: #6c808f;
        font-family: "GenSenRounded2TW-L", sans-serif;
        font-size: 0.75rem;
        letter-spacing: 2px;
        white-space: nowrap;
      }

      /* 第二頁 */
      .scene-2 .toggle-card {
        flex-wrap: wrap;
        flex-direction: row;
        justify-content: space-evenly;
      }

      #circular-range {
        user-select: none;
      }

      .circle-container {
        margin: 0 2rem;
      }

      .circle-container .range-thumb {
        cursor: pointer;
      }

      .circular-value {
        font-family: "GenSenRounded2TW-L", sans-serif;
        font-size: 1.2rem;
        color: #6c808f;
      }

      @media (max-width: 1024px) {
        .home-card .toggle-card {
          width: 70%;
          gap: 0;
        }

        .scene-2 .toggle-card {
          justify-content: center;
        }

        span.label {
          text-align: center;
        }
      }

      @media (max-width: 768px) {
        .home-card,
        .input-container {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- 故事劇情 -->
    <div class="story-body">
      <div class="story-container">
      <header class="story-header">
        <div class="story-header-title">
          <h1>Neo(2)</h1>
        </div>
      </header>

      <div class="story-chat-container" id="chatContainer"></div>

      <div class="input-container">
        <div class="input-wrapper">
          <input
            type="text"
            class="message-input"
            placeholder="請輸入訊息..."
            aria-label="Message input"
          />
          <div class="action-buttons">
            <button id="send-button" class="send-button" >
              <span>出發</span>
              <i class="fa-regular fa-font-awesome"></i>
            </button>
          </div>
        </div>
      </div>
      </div>
    </div>

      <div class="chapter-bar">
    <div class="chapter-button" onclick="window.location.href='traffic-daily.html'">
      <div class="chapter-icon"><i class="fa-solid fa-car-side"></i></div>
      <div class="chapter-label">日常</div>
    </div>
    <div class="chapter-button" onclick="window.location.href='home.html'">
      <div class="chapter-icon"><i class="fa-solid fa-house-chimney"></i></div>
      <div class="chapter-label">居住</div>
    </div>
    <div class="chapter-button" onclick="window.location.href='traffic.html'">
      <div class="chapter-icon"><i class="fa-solid fa-plane-departure"></i></div>
      <div class="chapter-label">旅遊</div>
    </div>
    <div class="chapter-button" onclick="window.location.href='food.html'">
      <div class="chapter-icon"><i class="fa-solid fa-drumstick-bite"></i></div>
      <div class="chapter-label">飲食</div>
    </div>
    <div class="chapter-button" onclick="window.location.href='fashion.html'">
      <div class="chapter-icon"><i class="fa-solid fa-shirt"></i></div>
      <div class="chapter-label">時尚</div>
    </div>
    <div class="chapter-button" onclick="window.location.href='entertainment.html'">
      <div class="chapter-icon"><i class="fa-solid fa-wifi"></i></div>
      <div class="chapter-label">娛樂</div>
    </div>
  </div>

    <!-- 第一頁：問人數 -->
    <section id="scene-home-1" class="scene scene-1">
      <h1>每個月大約使用多少能源資源？</h1>
      <div class="page-indicator">
        <div class="bar-container">
          <div class="bar-hit-area">
            <span class="bar active" onclick="goToScene('scene-home-1')"></span>
          </div>
          <div class="bar-hit-area">
            <span class="bar" onclick="goToScene('scene-home-2')"></span>
          </div>
        </div>
      </div>
      <div class="home-card">
        <div class="toggle-card">
          <span class="question-title">家中有幾位成員?</span>
          <div class="custom-number-input">
            <button type="button" class="btn-decrement">
              <span class="decrement">-</span>
            </button>
            <input type="number" value="0" min="0" />
            <button type="button" class="btn-increment">
              <span class="increment">+</span>
            </button>
          </div>
        </div>
        <div class="toggle-card">
          <div class="input-container">
            <span class="label">電</span>
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" />
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
            </div>
            <div class="toggle-row">
              <span class="nowrap-text">度 Kwh​</span>
              <label class="toggle-switch">
                <input type="checkbox" id="fuelToggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">元(NTD)​</span>
            </div>
          </div>
          <div class="input-container">
            <span class="label">水</span>
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" />
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
            </div>
            <div class="toggle-row">
              <span class="nowrap-text">度 Kwh​</span>
              <label class="toggle-switch">
                <input type="checkbox" id="fuelToggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">元(NTD)​</span>
            </div>
          </div>
          <div class="input-container">
            <span class="label">瓦斯</span>
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" />
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
            </div>
            <div class="toggle-row">
              <span class="nowrap-text">度 Kwh​</span>
              <label class="toggle-switch">
                <input type="checkbox" id="fuelToggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">元(NTD)​</span>
            </div>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToScene('scene-home-1')">
        ‹
      </button>
      <button class="nav-btn next-btn" onclick="goToScene('scene-home-2')">
        ›
      </button>
    </section>

    <!-- 第二頁：問用電水瓦斯與垃圾袋大小和倒垃圾頻率 -->
    <section id="scene-home-2" class="scene scene-2">
      <h1>每個月家中倒垃圾情況如何 ?</h1>
      <div class="page-indicator">
        <div class="bar-container">
          <span class="bar" onclick="goToScene('scene-home-1')"></span>
          <span class="bar active" onclick="goToScene('scene-home-2')"></span>
        </div>
      </div>
      <div class="home-card">
        <div class="toggle-card">
          <div class="circle-container">
            <span class="label">垃圾袋容量​</span>
            <div
              class="circular-range"
              data-unit="L"
              data-initial="3"
              data-min="3"
              data-max="25"
              data-step="1"
            ></div>
          </div>
          <div class="circle-container">
            <span class="label">倒垃圾頻率</span>
            <div
              class="circular-range"
              data-unit="次"
              data-initial="1"
              data-min="1"
              data-max="7"
              data-step="1"
            ></div>
          </div>
        </div>
      </div>

      <button class="nav-btn prev-btn" onclick="goToScene('scene-home-1')">
        ‹
      </button>
      <button class="nav-btn next-btn" onclick="goToScene('scene-home-2')">
        ›
      </button>
    </section>

    <script>
      const containers = document.querySelectorAll(".custom-number-input");

      containers.forEach((container) => {
        const input = container.querySelector('input[type="number"]');
        const btnDec = container.querySelector(".btn-decrement");
        const btnInc = container.querySelector(".btn-increment");

        btnDec.addEventListener("click", () => {
          let current = parseInt(input.value) || 0;
          let min = input.min !== "" ? parseInt(input.min) : -Infinity;
          if (current > min) {
            input.value = current - 1;
            input.dispatchEvent(new Event("change"));
          }
        });

        btnInc.addEventListener("click", () => {
          let current = parseInt(input.value) || 0;
          let max = input.max !== "" ? parseInt(input.max) : Infinity;
          if (current < max) {
            input.value = current + 1;
            input.dispatchEvent(new Event("change"));
          }
        });
      });

      let currentScene = "scene-home-1";

      function goToScene(targetId) {
        document.getElementById(currentScene).classList.remove("active");
        document.getElementById(targetId).classList.add("active");
        currentScene = targetId;
      }

      function prevScene() {
        document.getElementById(currentScene).classList.remove("active");
        document.getElementById("scene-entertain").classList.add("active");
        currentScene = "scene-entertain";
      }

      function createCircularSlider(container) {
        const centerX = 100,
          centerY = 100,
          radius = 80;
        const min = parseInt(container.dataset.min || 3);
        const max = parseInt(container.dataset.max || 25);
        const step = parseInt(container.dataset.step || 1);

        let lastAngle = 0,
          dragging = false;

        container.innerHTML = `
    <svg viewBox="0 0 200 200" width="200" height="200">
      <circle cx="100" cy="100" r="80" stroke="#E4ECF1" stroke-width="14" fill="none"/>
      <path class="range-arc" stroke="#6c808f" stroke-width="10" fill="none"/>
      <circle class="range-thumb" r="12" fill="#B5C1C6" style="filter: drop-shadow(1pt 1pt 1pt #7F7F7F60);" cx="100" cy="20" />
    </svg>
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px;">
      <span class="circular-value"></span>
    </div>
  `;
        container.style.position = "relative";
        container.style.width = "200px";
        container.style.height = "200px";

        const thumb = container.querySelector(".range-thumb");
        const arc = container.querySelector(".range-arc");
        const valueText = container.querySelector(".circular-value");
        const unit = container.dataset.unit || "L";
        const initial = parseInt(container.dataset.initial || min);

        function angleToValue(angle) {
          const ratio = angle / 360;
          const rawValue = min + (max - min) * ratio;
          return Math.round(rawValue / step) * step;
        }

        function valueToAngle(value) {
          return ((value - min) / (max - min)) * 360;
        }

        function polarToCartesian(cx, cy, r, angleDeg) {
          const angleRad = ((angleDeg - 90) * Math.PI) / 180;
          return {
            x: cx + r * Math.cos(angleRad),
            y: cy + r * Math.sin(angleRad),
          };
        }

        function describeArc(cx, cy, r, endAngle) {
          if (endAngle >= 359.99) {
            return `
        M ${cx} ${cy - r}
        A ${r} ${r} 0 1 1 ${cx} ${cy + r}
        A ${r} ${r} 0 1 1 ${cx} ${cy - r}
      `;
          }
          const start = polarToCartesian(cx, cy, r, 0);
          const end = polarToCartesian(cx, cy, r, endAngle);
          const largeArc = endAngle > 180 ? 1 : 0;
          return `M ${start.x} ${start.y} A ${r} ${r} 0 ${largeArc} 1 ${end.x} ${end.y}`;
        }

        function updateUI(value, round = true) {
          const shownValue = round ? Math.round(value / step) * step : value;
          const angle = valueToAngle(shownValue);
          const thumbPos = polarToCartesian(centerX, centerY, radius, angle);
          thumb.setAttribute("cx", thumbPos.x);
          thumb.setAttribute("cy", thumbPos.y);
          arc.setAttribute("d", describeArc(centerX, centerY, radius, angle));
          valueText.textContent = `${Math.round(shownValue)}${unit}`;
        }

        let currentRawValue = initial;

        function handleMove(e) {
          if (!dragging) return;
          const rect = container.querySelector("svg").getBoundingClientRect();
          const x = (e.clientX || e.touches[0].clientX) - rect.left;
          const y = (e.clientY || e.touches[0].clientY) - rect.top;
          const dx = x - centerX;
          const dy = y - centerY;
          let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
          if (angle < 0) angle += 360;

          const angleDiff = angle - lastAngle;
          if (angleDiff < -300 || angleDiff > 300) return;
          lastAngle = angle;

          currentRawValue = min + (max - min) * (angle / 360);
          updateUI(currentRawValue, false);
        }

        // 滑鼠事件
        thumb.addEventListener("mousedown", () => {
          dragging = true;
        });
        window.addEventListener("mousemove", handleMove);
        window.addEventListener("mouseup", () => {
          if (dragging) {
            dragging = false;
            const snappedValue = Math.round(currentRawValue / step) * step;
            updateUI(snappedValue, true);
          }
        });

        // 觸控事件，加入 preventDefault() 禁止頁面滑動
        thumb.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            dragging = true;
          },
          { passive: false }
        );

        window.addEventListener(
          "touchmove",
          (e) => {
            if (dragging) {
              e.preventDefault();
              handleMove(e);
            }
          },
          { passive: false }
        );

        window.addEventListener(
          "touchend",
          (e) => {
            if (dragging) {
              e.preventDefault();
              dragging = false;
              const snappedValue = Math.round(currentRawValue / step) * step;
              updateUI(snappedValue, true);
            }
          },
          { passive: false }
        );

        updateUI(initial);
      }

      // 初始化所有 circular-range
      document.querySelectorAll(".circular-range").forEach((el) => {
        createCircularSlider(el);
      });

    const messages = [
        {
          type: "time",
          text: "上午 9:30",
          time: 1000,
        },
        { text: "接下來我們來到19世紀末。城市發展越來越快，電力開始普及，工廠林立、摩天大樓拔地而起。", 
          from: "cat",
          time: 1500 ,
        },
        {
          text: "所以...碳排放也不只來自交通了？",
          from: "user",
          time: 1500,
        },
        {
          text: "就是這樣。從「移動產生碳」，變成「住也在排碳」。無論是蓋房子、照明、冷暖氣，每一樣都需要消耗龐大的能源。",
          from: "cat",
          time: 2000,
        },
        { text: "鋼筋混凝土、電梯、電燈、電器——這些都讓生活更方便，也讓能源使用進一步上升。這是人類首次進入「大量電氣化生活」的時代。",
          from: "cat", 
          time: 5000 
        }
      ];

      const chatContainer = document.getElementById("chatContainer");

      function createMessageElement(message) {
        if (message.type === "time") {
          const timeEl = document.createElement("div");
          timeEl.classList.add("home-story-time-stamp");
          timeEl.textContent = message.text;
          return timeEl;
        }

        const wrapper = document.createElement("div");
        wrapper.classList.add(
          "story-message",
          message.from === "user"
            ? "story-user-message"
            : "story-cat-message"
        );

        const avatar = document.createElement("div");
        avatar.classList.add("story-avatar");
        avatar.textContent = message.from === "user" ? "U" : "A";

        const bubble = document.createElement("div");
        bubble.classList.add("story-message-bubble");
        bubble.textContent = message.text;

        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
        return wrapper;
      }

    async function playIntroMessages() {
      for (let i = 0; i < messages.length; i++) {
        const el = createMessageElement(messages[i]);
        const messageTime = messages[i].time;
        chatContainer.appendChild(el);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        await new Promise((resolve) => setTimeout(resolve, messageTime));
      }
    }

      const sendButton = document.getElementById("send-button")

    function StartQuestionnaire() {
      document.querySelector(".chapter-bar").style.display = "flex"
      document.querySelector(".story-container").style.display = "none";
      document.querySelector("body").style.display = "flex"
      document.getElementById("scene-home-1").classList.add("active");
      currentScene = "scene-home-1";
    }

    sendButton.addEventListener("click", () => {
      StartQuestionnaire()
    })

      window.addEventListener("DOMContentLoaded", playIntroMessages);
    </script>
  </body>
</html>
