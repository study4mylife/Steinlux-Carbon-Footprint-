<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>星際碳險 - 碳足跡分析</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
    
    <style>
    @font-face {
      font-family: "GenSenRounded2TW-R";
      src: url("./font/GenSenRounded2TW-R.otf") format("opentype"),
          url("./font/GenSenRounded2TW-R.woff") format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "GenSenRounded2TW-L";
      src: url("./font/GenSenRounded2TW-L.otf") format("opentype"),
          url("./font/GenSenRounded2TW-L.woff") format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    @media (max-width: 480px) {
      html { font-size: 14px; }
    }

    @media (min-width: 1200px) {
      html { font-size: 18px; }
    }

    @media (min-width: 1600px) {
      html { font-size: 28px; }
    }

      html {
        font-family: "GenSenRounded2TW-R", sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      }

      p {
        margin: 0.5rem 0;
      }

      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(158, 240, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 1;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        transition: opacity 0.5s ease;
      }

      .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes rubberBand {
        0% {
          transform: scale3d(1, 1, 1);
        }
        30% {
          transform: scale3d(1.15, 0.85, 1);
        }
        40% {
          transform: scale3d(0.85, 1.15, 1);
        }
        50% {
          transform: scale3d(1.05, 0.95, 1);
        }
        65% {
          transform: scale3d(0.975, 1.02, 1);
        }
        75% {
          transform: scale3d(1.025, 0.975, 1);
        }
        100% {
          transform: scale3d(1, 1, 1);
        }
      }

      .index-btn {
        position: fixed;
        width: fit-content;
        height: fit-content;
        left: 0;
        bottom: 0;
        z-index: 9999;
      }

      .index-btn a svg {
        width: 2.5rem;
        height: 2.5rem;
        margin: 1rem;
        fill: #ffffff75;
      }

      .index-btn:hover {
        animation: rubberBand 0.75s ease;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .scroll-container {
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        scroll-snap-type: y mandatory;
        scroll-behavior: smooth;
        z-index: 999;
        width: 100vw;
        overflow: hidden;
      }

      @keyframes switchOn {
        0% {
          transform: translateX(20%);
        }
        20% {
          transform: translateX(182%);
        }
        40% {
          transform: translateX(158%);
        }
        60% {
          transform: translateX(178%);
        }
        80% {
          transform: translateX(172%);
        }
        100% {
          transform: translateX(175%);
        }
      }

      @keyframes switchOff {
        0% {
          transform: translateX(120%);
        }
        20% {
          transform: translateX(-2%);
        }
        40% {
          transform: translateX(22%);
        }
        60% {
          transform: translateX(2%);
        }
        80% {
          transform: translateX(8%);
        }
        100% {
          transform: translateX(5%);
        }
      }

      .toggle-row {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.25rem;
        font-weight: normal;
        color: #f5f5f5;
        margin-top: 1.1671875rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        letter-spacing: 0.75rem;
        border-bottom: 1.5pt solid #ffffff60;
      }

      .toggle-switch {
        position: relative;
        min-width: 3.75rem;
        min-height: 1.5rem;
        margin: 0 1.5rem;
      }

      .toggle-row .nowrap-text {
        height: fit-content;
        font-size: 1.5rem;
        color: #6D808F;
        letter-spacing: 0.125rem;
        text-shadow: 3pt 3pt 5pt #7F7F7F40;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-switch .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #eff3f990;
        border: none;
        box-shadow: 2pt 2.5pt 3pt #6d808f50 inset;
        border-radius: 24px;
        transition: 0.75s;
      }

      .toggle-switch .slider:before {
        position: absolute;
        content: "";
        height: 1.25rem;
        width: 1.25rem;
        left: 2px;
        bottom: 2.3px;
        background: #fff;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 5pt 5pt 10pt #c3cadb76;
      }


      .toggle-switch input:checked + .slider {
        background: #d0d2d6;
      }

      .toggle-switch input:checked + .slider:before {
        animation: switchOn 1s linear forwards;
      }

      .toggle-switch input:not(:checked) + .slider:before {
        animation: switchOff 1s linear forwards;
      }

      .scene {
        position: relative;
        height: 100vh;
        scroll-snap-align: start;
        z-index: 999;
      }

      .scene.active {
        pointer-events: auto;
      }
      
      @media (max-width: 1024px) {
        body {
          height: auto;
        }
        
        .scroll-container {
          position: static !important;
          overflow-y: visible !important;
          scroll-snap-type: none !important;
          scroll-behavior: auto !important;
          overflow-x: hidden !important;
        }

        .scene {
          position: static !important;
          scroll-snap-align: none !important;
          height: auto !important;
          overflow-x: hidden;
        }

        .scene-2 {
          height: auto !important;
          min-height: 100vh;
          pointer-events: initial !important;
        }
      }

      .scene-1 {
        background: url("images/0813修01.jpg") no-repeat 0 0;
        background-size: 100% 200%;
        pointer-events: initial;
      }

      .scene-2 {
        background: url("images/0813修01.jpg") no-repeat 0 -100vh;
        background-size: 100% 200%;
        pointer-events: none;
      }

      @media (max-width: 1024px) {
        .scene-1, .scene-2 {
          background: none
        }

        .scroll-container {
          background: url("images/0813修03.jpg") no-repeat 0 0;
          background-size: 100% 100%;
        }
      }

      .scene-1 .sealevel-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 30vw;
        height: max-content;
        min-width: min-content;
        font-size: 1.75rem;
        letter-spacing: 0.375rem;
        color: #F5F5F5;
        text-shadow: 2pt 2pt 3pt #7F7F7F40;
        top: 5%;
        left: 4.5%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 100;
      }

      .scene-1 .sealevel-container p {
        text-wrap:  nowrap;
      }

      .scene-1 .iframemap-container {
        display: flex;
        align-items: end;
        height: 30vh;
      }

      .scene-1 .iframe-container {
        display: flex;
        gap: 1rem;
        align-items: stretch;
        width: 27.5vw;
        height: max-content;
      }

      .scene-1 .sealevel-container iframe {
        width: 100%;
        max-height: 30vh;
        aspect-ratio: 4/3;
        border: none;
        border-radius: 8px;
      }

      .scene-1 .map-buttons {
        display: flex;
        gap: 0.5rem;
        flex-direction: column;
        justify-content: space-between;
        flex: 1;
      }

      .scene-1 .map-buttons button {
        font-family: "GenSenRounded2TW-R", sans-serif;
        background: rgba(255,255,255,0.5);
        border: none;
        width: max-content;
        min-height: min-content;
        height: 1.25rem;
        padding: 0.25rem;
        border: 0.25pt solid #fff;
        border-radius: 2px;
        color: #6D808F;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.5rem;
        text-shadow: 2pt 2pt 3pt #7F7F7F40;
      }

      .scene-1 .map-buttons button.active-btn {
        border: 0.25pt solid #AD967C;
        color: #AD967C;
      }

      .scene-1 .carbon-footprint-emissions-container {
        display: flex;
        align-items: flex-end;
        flex-direction: column;
        position: fixed;
        width: 30vw;
        min-width: min-content;
        font-size: 1.75rem;
        letter-spacing: 0.375rem;
        color: #F5F5F5;
        text-shadow: 2pt 2pt 3pt #7F7F7F40;
        top: 5%;
        right: 4.5%;
        z-index: 2;
        opacity: 1;
      }

      .scene-1 .carbon-footprint-emissions-container .emissions-text {
        width: 100%;
        text-align-last: justify;
        text-wrap: nowrap;
      }

      .scene-1 .carbon-footprint-emissions-container .emissions-value-text {
        margin-right: auto;
      }

      .scene-1 #carbon-footprint-emissions-value {
        font-size: 1.75rem;
        color: #6D808F;
      }

      .scene-1 .emissions-unit {
        font-size: 0.8rem;
        letter-spacing: 0.25rem;
      }

      .scene-1 .carbon-footprint-emissions-neutrality {
        width: 65%;
        font-size: 0.8rem;
        text-align: justify;
        letter-spacing: 4px;
        line-height: 1.8;
        margin-right: auto;
        margin-top: 0;
      }

      .neutrality-value {
        color: #6D808F;
      }

      .scene-1 .carbon-footprint-temperature-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 40vw;
        font-size: 1.75rem;
        letter-spacing: 0.375rem;
        color: #F5F5F5;
        text-shadow: 2pt 2pt 3pt #7F7F7F40;
        top: 37%;
        right: 4.5%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      .scene-1 .temperature-text {
        text-align: right;
      }

      .scene-1 #carbon-footprint-temperature-value {
        color: #C00000;
      }

      .scene-2 .carbon-footprint-status-container {
        position: fixed;
        top: 50%;
        left: 25%;
        transform: translate(-50%, -50%);
        width: 40vw;
        height: 85vh;
        background: rgba(255, 255, 255, 0.35);
        border-radius: 20px;
        border: 0.25px solid rgba(255, 255, 255);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        padding: 1rem 2rem;
        box-sizing: border-box;
        opacity: 0;
        overflow-y: auto;
        scrollbar-color: rgba(0,0,0,0.4) transparent;
      }

      .analysis-title {
        text-align: center;
        font-size: 1.25rem;
        font-weight: normal;
        color: #f5f5f5;
        margin-top: 0;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        letter-spacing: 0.75rem;
        border-bottom: 1.5pt solid #ffffff60;
      }

      .total-emissions {
        text-align: center;
        margin-bottom: 3rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .total-value {
        font-size: 3rem;
        color: #ff6b6b;
        font-weight: bold;
        display: block;
      }

      .total-unit {
        font-size: 1rem;
        color: #cccccc;
        margin-top: 0.5rem;
      }

      .categories-grid {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .category-card {
        border-radius: 8px;
      }

      .category-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding: 0.5rem 1rem 0.5rem 0.55rem;
        border-radius: 8px;
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.15);
      }

      .category-title {
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-align: center;
        letter-spacing: 0.125rem;
      }

      .category-value {
        font-size: 0.9rem;
        letter-spacing: 0.05rem;
        text-align: center;
      }

      .category-unit {
        font-size: 0.9rem;
        color: #cccccc;
        text-align: center;
      }

      .category-percentage {
        font-size: 0.8rem;
        color: #ffb347;
        text-align: center;
        margin-top: 0.5rem;
      }

      .breakdown-item {
        font-family: "GenSenRounded2TW-L", sans-serif;
        font-weight: bold;
        display:flex;
        justify-content:space-between;
        padding: 0.5rem 1rem;
      }

      .breakdown-item .item-info {
        letter-spacing: 0.075rem;
      }

      .breakdown-item .item-info .item-name {
        font-size: 0.8rem;
      }

      .breakdown-item .item-info .item-details {
        font-size: 0.5rem;
        color: #A6A6A6;
      }

      .item-emission {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8rem;
        letter-spacing: 0.05rem;
      }

      .recommendations {
        position: fixed;
        top: 50%;
        right: -15%;
        transform: translate(-50%, -50%);
        width: 40vw;
        height: 85vh;
        background: rgba(255, 255, 255, 0.35);
        border-radius: 20px;
        border: 0.25px solid rgba(255, 255, 255);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        padding: 1rem 2rem;
        opacity: 0;
        box-sizing: border-box;
        overflow-y: auto;
        scrollbar-color: rgba(0,0,0,0.4) transparent;
      }

      ::-webkit-scrollbar-track {
        background: none;
      }

      .recommendation-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        margin-top: 1rem;
      }

      #recommendations-list {
        width: 100%;
        padding-left: 0;
      }
      
      .recommendation-item {
        margin-bottom: 1rem;
        color: #000;
        list-style: none;
        font-size: 0.9rem;
      }

      .recommendation-item.no-category {
        color: #555;
      }

      .recommendation-title {
        font-weight: bold;
        display: flex;
        align-items: start;
        gap: 0.5rem;
        letter-spacing: 0.125rem;
        line-height: 1.8;
      }

      .marker {
        display: inline-block;
        min-width: 0.75rem;
        min-height: 0.75rem;
        border-radius: 50%;
        margin-top: 4px;
      }

      .marker-gray {
        background-color: #555;
      }

      .recommendation-content {
        margin-left: 0.5rem;
        margin-top: 0.5rem;
        color: #000;
        line-height: 1.8;
        letter-spacing: 0.125rem;
      }

      .recommendation-content li {
        list-style: disc;
      }
      
      .emissions-legend-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-wrap: wrap;
        list-style:none;
        text-align: center;
        gap: 1.25rem;
        padding:0; 
        margin:0;
      }

      .chart-container {
        display:flex;
        justify-content: space-evenly;
        align-items: center;
        width: 100%;
        height: 250px;
      }

      #emissions-chart {
        max-width: 50%;
        max-height: 250px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        letter-spacing: 0.0625rem;
        text-wrap: nowrap;
      }

      .advice-summary-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2rem 1rem;
        width: 100%;
      }

      @media (max-width: 1200px) {
        .advice-summary-container {
          grid-template-columns: repeat(2, 1fr);
          justify-items: center;
        }

        .advice-summary-card {
          min-width: 60%;
        }
      }

      @media (max-width: 600px) {

        .advice-summary-container {
          grid-template-columns: 1fr;
        }

        .advice-summary-card {
          min-width: 80%;
        }
      }

      .advice-summary-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px;
        padding: 0rem 0.25rem;
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.15);
        letter-spacing: 0.03rem;
        min-height: 2.25rem;
        min-width: 80%;
      }

      .advice-name {
        font-size: 0.85rem;
        font-weight: 600;
        text-wrap: nowrap;
      }

      .advice-value {
        font-size: 0.85rem;
        font-weight: bold;
      }

      .advice-dot {
        display: inline-block;
        min-width: 0.75rem;
        min-height: 0.75rem;
        max-width: 0.75rem;
        max-height: 0.75rem;
        border-radius: 50%;
        margin: 10px 8px 0 0;
        vertical-align: middle;
      }

      .advice-section {
        line-height: 1.8;
      }

      .advice-section p {
        display: flex;
        align-items: flex-start;
        font-weight: bold;
        margin-bottom: 0.5rem;
        letter-spacing: 0.1875rem;
      }

      .advice-section ul {
          margin-left: 1rem;
          color: #333;
      }

      .advice-section li {
          margin-bottom: 0.5rem;
      }

      .no-data-advice p {
          color: #999;
          font-weight: bold;
      }

      .legend-color {
        min-width: 1rem;
        min-height: 1rem;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.75rem;
      }

      .scene-1 .scroll-mouse {
        position: absolute;
        bottom: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        width: 18px;
        height: 26px;
        opacity: 1;
        cursor: pointer;
      }

      .scene-2 .scroll-mouse {
        position: absolute;
        top: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        width: 18px;
        height: 26px;
        opacity: 0;
        cursor: pointer;
      }

      @media (max-width: 1024px) {
        .scroll-mouse {
          display: none !important;
        }
      }

      .border-anim {
        stroke-dasharray: 90;
        stroke-dashoffset: 90;
        cursor: pointer;
        transition: stroke-dashoffset 1s linear;
      }
      
      .mouse-line {
        position: absolute;
        width: 0.05rem;
        height: 0.4rem;
        background-color: #fff;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: translateY 0.3s linear;
        animation: none;
      }

      .scroll-mouse:not(:hover) .border-anim {
        stroke-dashoffset: 90;
      }

      .scroll-mouse:hover .border-anim {
        stroke-dashoffset: 0;
      }


      .error-message {
        color: #ff6b6b;
        text-align: center;
        font-size: 1.2rem;
        padding: 2rem;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(255, 107, 107, 0.3);
        margin: 1rem 0;
      }

      @media (min-width: 1600px) {

      .scene-1 .map-buttons button {
        font-size: 0.75rem;
      }

      .scene-1 .carbon-footprint-emissions-container {
        max-width: 500px;
      }
      }

      @media (min-width: 1800px) {
      .scene-1 .sealevel-container {
          width: 30vw;
        }

      }

      @media (max-width: 1024px) {
        .index-btn a svg {
          width: 2rem;
          height: 2rem;
        }

        .scene-1, .scene-2 {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
        }

        .climate-wrapper {
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          width: 90vw;
          margin-top: 2rem;
          background: rgba(255, 255, 255, 0.3);
          border-radius: 20px;
          border: 0.25px solid rgba(255, 255, 255);
          backdrop-filter: blur(15px);
          -webkit-backdrop-filter: blur(15px);
        }

        .scene-1 .sealevel-container,
        .scene-1 .carbon-footprint-emissions-container,
        .scene-1 .carbon-footprint-temperature-container {
          position: static !important;
          width: 90%;
          height: auto;
          font-size: 1.25rem;
          text-align: center;
          translate: none;
        }

        .scene-1 .sealevel-container, .carbon-footprint-emissions-container {
          border-bottom: 1.5px solid #fff;
        }

        .scene-1 .sealevel-container{
          margin: 1rem 0 0 0;
        }

        .carbon-footprint-emissions-container {
          margin: 0;
        }

        .carbon-footprint-temperature-container {
          margin: 0 0 1rem 0;
        }

        .scene-1 .carbon-footprint-emissions-container .emissions-text, .scene-1 .temperature-text {
          padding-top: 0.5rem;
        }

        .scene-1 .iframemap-container {
          height: fit-content;
          justify-content: center;
        }

        .scene-1 .iframe-container {
          width: 90%;
          padding: 1rem 0 1.5rem 0;
          justify-content: center;
        }

        .scene-1 .sealevel-container iframe {
          width: 60%;
          max-width: 350px;
        }

        .scene-1 .map-buttons {
          display: flex;
          flex-direction: column;
          justify-content: space-between;
          flex: none;
        }

        .scene-1 #carbon-footprint-emissions-value {
          font-size: 1.25rem;
        }

        .scene-1 .carbon-footprint-emissions-container .emissions-text {
          text-align-last: center;
        }

        .scene-1 .carbon-footprint-emissions-container .emissions-value-text {
          margin-left: auto;
        }

        .scene-1 .carbon-footprint-emissions-neutrality {
          width: 100%;
          text-align: center;
        }

        .scene-1 .temperature-text {
          text-align: center;
          line-height: 1.8;
        }

        .scene-2 {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .toggle-switch {
          margin: 0 1rem;
        }

        .toggle-row .nowrap-text {
          font-size: 1.25rem;
        }

        .scene-2 .carbon-footprint-status-container {
          position: static !important;
          width: 90vw;
          height: auto;
          max-height: none;
          margin: 2rem 0;
          transform: none;
          opacity: 1 !important;
        }

        .scene-2 .recommendations {
          position: static !important;
          width: 90vw;
          height: auto;
          max-height: none;
          margin-bottom: 2rem;
          transform: none;
          opacity: 1 !important;
        }

        .categories-grid {
          grid-template-columns: 1fr;
        }

        .analysis-title {
          font-size: 1.5rem;
          line-height: 1.8;
        }

        .total-value {
          font-size: 2rem;
        }

        .chart-container {
          flex-direction: column;
          height: fit-content;
        }

        #emissions-chart {
          max-width: 80%;
          max-height: 250px;
          margin-bottom: 1.5rem;
        }

        .emissions-legend-container {
          align-items: flex-start;
        }

        .legend-item {
          display: flex;
          align-items: center;
          justify-content: center;
          box-sizing: border-box;
          padding: 0.25rem;
        }
      }

      @media (max-width: 600px) {
        .scene-1 .sealevel-container iframe {
          width: 80%;
        }

        .scene-1 .carbon-footprint-emissions-container .emissions-text {
          text-align-last: center;
          line-height: 1.8;
        }

        .legend-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            box-sizing: border-box;
            width: 100%;
            padding: 0.25rem;
          }
      }
    </style>
</head>
<body>
    <!-- loading畫面 -->
    <div class="loading-screen">
        <div class="spinner"></div>
    </div>

    <div class="index-btn">
      <a href="index.html">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 56 56">
          <path class="house-path" d="M .6249 27.8242 C .6249 28.9492 1.5155 29.6289 2.6171 29.6289 C 3.2968 29.6289 3.8358 29.3008 4.3046 28.8320 L 27.1796 7.9961 C 27.4374 7.7383 27.7187 7.6445 28.0233 7.6445 C 28.3046 7.6445 28.5624 7.7383 28.8436 7.9961 L 51.6954 28.8320 C 52.1874 29.3008 52.7264 29.6289 53.3826 29.6289 C 54.4842 29.6289 55.3751 28.9492 55.3751 27.8242 C 55.3751 27.1211 55.1173 26.6758 54.6719 26.2774 L 46.5623 18.8945 L 46.5623 5.0430 C 46.5623 4.0117 45.9061 3.3555 44.8751 3.3555 L 41.8046 3.3555 C 40.7968 3.3555 40.0936 4.0117 40.0936 5.0430 L 40.0936 13.0117 L 30.8124 4.5274 C 29.9921 3.7539 28.9843 3.3789 27.9999 3.3789 C 27.0155 3.3789 26.0312 3.7539 25.1874 4.5274 L 1.3280 26.2774 C .9062 26.6758 .6249 27.1211 .6249 27.8242 Z M 7.3280 47.4883 C 7.3280 50.7461 9.2968 52.6445 12.6015 52.6445 L 22.0936 52.6445 L 22.0936 35.9805 C 22.0936 34.9023 22.8202 34.1992 23.8984 34.1992 L 32.1718 34.1992 C 33.2499 34.1992 33.9531 34.9023 33.9531 35.9805 L 33.9531 52.6445 L 43.4216 52.6445 C 46.7264 52.6445 48.6719 50.7461 48.6719 47.4883 L 48.6719 30.3320 L 28.7734 12.4023 C 28.5155 12.1679 28.2343 12.0508 27.9531 12.0508 C 27.6952 12.0508 27.4374 12.1679 27.1562 12.4258 L 7.3280 30.4492 Z" />
        </svg>
      </a>
    </div>

    <div class="scroll-container">
        <section class="scene scene-1">
            <div class="sealevel-container">
                <p>本世紀末</p>
                <p>預計海平面將上升......</p>
                <div class="iframemap-container">
                  <div class="iframe-container">
                    <!-- iframe 區塊 -->
                    <iframe id="mapFrame" 
                            src="https://coastal.climatecentral.org/embed/map/13/121.5354/25.082/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C" 
                            allow="fullscreen"
                            title="Climate Central Map">
                    </iframe>

                    <!-- 按鈕區塊 -->
                    <div class="map-buttons">
                      <button onclick="switchMap('taipei', this)" class="active-btn">雙北地區</button>
                      <button onclick="switchMap('yilan', this)">蘭陽平原</button>
                      <button onclick="switchMap('hsinchu', this)">竹苗地區</button>
                      <button onclick="switchMap('taichung', this)">中彰地區</button>
                      <button onclick="switchMap('chiayi', this)">雲嘉南區</button>
                      <button onclick="switchMap('kaohsiung', this)">高屏地區</button>
                    </div>
                  </div>
                </div>
            </div>

            <div class="carbon-footprint-emissions-container">
                <p class="emissions-text">您過去一年的碳足跡排放是</p>
                <p class="emissions-value-text">
                    <span id="carbon-footprint-emissions-value">計算中...</span>
                    <span>公噸<span class="emissions-unit">二氧化碳當量(tCO2e)</span></span>
                </p>
                <p class="carbon-footprint-emissions-neutrality" id="neutrality-text">計算中...</p>
            </div>

            <div class="carbon-footprint-temperature-container">
                <p class="temperature-text">地球持續升溫</p>
                <p class="temperature-text">本世紀末將達
                    <span id="carbon-footprint-temperature-value">3.7</span>
                </p>
            </div>
            
            <div class="scroll-mouse">
                <svg class="mouse-svg" viewBox="0 0 18 26" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="16" height="24" rx="8" stroke="#cccccc" stroke-width="1" fill="none" />
                    <rect class="border-anim" x="1" y="1" width="16" height="24" rx="8" stroke="#ffffff" stroke-width="1" fill="none" />
                </svg>
                <div class="mouse-line"></div>
            </div>
        </section>

        <section class="scene scene-2">
            <div class="carbon-footprint-status-container">
                <h2 class="analysis-title">您生活碳足跡計算的詳細數據</h2>

                <div class="categories-grid" id="categories-container">
                </div>
            </div>

            <div class="recommendations">
              <div class="toggle-row">
                <span class="nowrap-text">結語說明</span>
                <label class="toggle-switch">
                  <input type="checkbox">
                  <span class="slider"></span>
                </label>
                <span class="nowrap-text">改善建議</span>
              </div>

              <!-- 第一頁：結語與圓餅圖 -->
              <div id="summary-page" class="recommendation-page">
                <!-- 圓餅圖區 -->
                <div class="chart-container">
                  <canvas id="emissions-chart"></canvas>
                  <!-- 右側 legend -->
                  <div>
                    <ul class="emissions-legend-container" id="emissions-legend"></ul>
                  </div>
                </div>

                <ul id="recommendations-list">
                  <li>計算分析中...</li>
                </ul>
              </div>

              <!-- 第二頁：改善建議 -->
              <div id="advice-page" class="recommendation-page" style="display:none;">
              </div>
            </div>

            <div class="scroll-mouse">
                <svg class="mouse-svg" viewBox="0 0 18 26" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="16" height="24" rx="8" stroke="#cccccc" stroke-width="1" fill="none" />
                    <rect class="border-anim" x="1" y="1" width="16" height="24" rx="8" stroke="#ffffff" stroke-width="1" fill="none" />
                </svg>
                <div class="mouse-line"></div>
            </div>
        </section>
    </div>

    <script>
// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyBm2oNcPhQ5nbQbLrvQUnlQ31LoxX3JThM",
  authDomain: "steinlux-calculator.firebaseapp.com",
  projectId: "steinlux-calculator",
  storageBucket: "steinlux-calculator.firebasestorage.app",
  messagingSenderId: "180210584345",
  appId: "1:180210584345:web:759888650c808df8159388",
  measurementId: "G-VX9JK5P5DF"
};

// 初始化 Firebase
firebase.initializeApp(firebaseConfig);
const functions = firebase.functions();

// 碳足跡完整數據
let carbonDetailedData = {
    'traffic-daily': { total: 0, breakdown: {} },
    'home': { total: 0, breakdown: {} },
    'traffic-travel': { total: 0, breakdown: {} },
    'food': { total: 0, breakdown: {} },
    'fashion': { total: 0, breakdown: {} },
    'entertainment': { total: 0, breakdown: {} }
};

// 碳足跡簡化數據
let carbonData = {
    'traffic-daily': 0,
    'home': 0,
    'traffic-travel': 0,
    'food': 0,
    'fashion': 0,
    'entertainment': 0
};

let totalEmissions = 0;

const pageNames = {
    'traffic-daily': '日常通勤',
    'home': '居住生活',
    'traffic-travel': '旅遊交通',
    'food': '日常飲食',
    'fashion': '時尚穿搭',
    'entertainment': '生活娛樂'
};

const urls = {
  taipei: "https://coastal.climatecentral.org/embed/map/13/121.4803/25.0938/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  yilan: "https://coastal.climatecentral.org/embed/map/12/121.8153/24.7567/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  hsinchu: "https://coastal.climatecentral.org/embed/map/11/120.9004/24.757/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  taichung: "https://coastal.climatecentral.org/embed/map/12/120.5003/24.1713/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  chiayi: "https://coastal.climatecentral.org/embed/map/10/120.1769/23.3712/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  kaohsiung: "https://coastal.climatecentral.org/embed/map/12/120.5064/22.4321/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C"
};

function switchMap(region, btn) {

  document.getElementById("mapFrame").src = urls[region];

  document.querySelectorAll(".map-buttons button").forEach(b => {
    b.classList.remove("active-btn");
  });

  if (btn) {
    btn.classList.add("active-btn");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  function wrapContainers() {
    const sealevel = document.querySelector(".sealevel-container");
    const emissions = document.querySelector(".carbon-footprint-emissions-container");
    const temperature = document.querySelector(".carbon-footprint-temperature-container");

    if (!sealevel || !emissions || !temperature) return;

    let wrapper = document.querySelector(".climate-wrapper");

    if (window.innerWidth <= 1024) {
      if (!wrapper) {
        wrapper = document.createElement("div");
        wrapper.classList.add("climate-wrapper");

        sealevel.parentNode.insertBefore(wrapper, sealevel);
        wrapper.appendChild(sealevel);
        wrapper.appendChild(emissions);
        wrapper.appendChild(temperature);
      }
    } else {
      // 視窗拉大後，把元素移回原本的層級並移除 wrapper
      if (wrapper) {
        const parent = wrapper.parentNode;
        parent.insertBefore(sealevel, wrapper);
        parent.insertBefore(emissions, wrapper);
        parent.insertBefore(temperature, wrapper);
        wrapper.remove();
      }
    }
  }

  wrapContainers();

  window.addEventListener("resize", wrapContainers);
});


// 檢查是否為移動裝置
function isMobile() {
    return window.innerWidth <= 1024 || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

let currentMode = null;
let sceneTransitionsSetup = false;

// 取得 userId
function getUserId() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    
    if (userId) {
        return userId;
    }
    
    const storedUserId = localStorage.getItem('userId');
    if (storedUserId) {
        return storedUserId;
    }
    
    return 'test-user';
}

// --- Toggle 切換結語 / 改善建議 ---
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.querySelector(".toggle-switch input");
  const summaryPage = document.getElementById("summary-page");
  const advicePage = document.getElementById("advice-page");

  if (toggle) {
    toggle.addEventListener("change", () => {
      if (toggle.checked) {
        summaryPage.style.display = "none";
        advicePage.style.display = "flex";
      } else {
        summaryPage.style.display = "flex";
        advicePage.style.display = "none";
      }
    });
  }
});

// 用 Firebase Function 計算碳足跡詳細數據
async function calculateCarbonFootprintDetailed() {
    const userId = getUserId();
    const pages = Object.keys(carbonDetailedData);
    const calculateCarbonPage = functions.httpsCallable('calculateCarbonPage');

    try {
        const promises = pages.map(pageName => 
            calculateCarbonPage({ userId, pageName })
        );

        const results = await Promise.all(promises);
        
        results.forEach(result => {
            if (result.data) {
                const pageName = result.data.pageName;
                carbonDetailedData[pageName] = {
                    total: result.data.total || 0,
                    breakdown: result.data.breakdown || {}
                };
                carbonData[pageName] = result.data.total || 0;
            }
        });

        totalEmissions = Object.values(carbonData).reduce((sum, value) => sum + value, 0)/1000;
        
        return true;
    } catch (error) {
        console.error('計算碳足跡時發生錯誤:', error);
        showError('計算碳足跡時發生錯誤，請稍後再試');
        return false;
    }
}

function showError(message) {
    const container = document.getElementById('categories-container');
    container.innerHTML = `<div class="error-message">${message}</div>`;
}

const categoryInfo = {
    'traffic-daily': { color: '#6D808F', bgcolor: '#6D808F35', name: '日常通勤' },
    'home': { color: '#A88E71', bgcolor: '#A88E7135', name: '居住生活' },
    'traffic-travel': { color: '#C18181', bgcolor: '#C1818135', name: '旅遊交通' },
    'food': { color: '#A3B18D', bgcolor: '#A3B18D35', name: '日常飲食' },
    'fashion': { color: '#B6A0B1', bgcolor: '#B6A0B135', name: '時尚穿搭' },
    'entertainment': { color: '#AAC5D2', bgcolor: '#AAC5D235', name: '生活娛樂' }
};

function createCategoryCards() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';

    const order = ['traffic-daily', 'home', 'traffic-travel', 'food', 'fashion', 'entertainment'];

    const filteredEntries = Object.entries(carbonDetailedData)
        .filter(([pageKey, data]) => data.total > 0);

    if (filteredEntries.length === 0) {
        const noDataCard = document.createElement('div');
        noDataCard.className = 'category-card no-data';
        noDataCard.innerHTML = `
            <div class="category-header" style="background-color:#f0f0f0; font-weight:bold; color:#888; border-left: 0.5rem solid #888;">
                <h3 class="category-title">暫無數據</h3>
                <div class="category-value" style="color:#888;">0.000</div>
            </div>
            <div class="category-description" style="padding:0.5rem 1rem;">請完成碳足跡問卷以查看詳細數據</div>
        `;
        container.appendChild(noDataCard);
        return;
    }

    const orderedEntries = filteredEntries.sort(
        ([a], [b]) => order.indexOf(a) - order.indexOf(b)
    );

    orderedEntries.forEach(([pageKey, data]) => {
        const info = categoryInfo[pageKey];

        const sortedBreakdown = Object.entries(data.breakdown)
            .filter(([itemName, itemData]) => itemData.emission > 0)
            .sort((a, b) => b[1].emission - a[1].emission);

        const card = document.createElement('div');
        card.className = 'category-card detailed';

        const itemsHTML = sortedBreakdown.length > 0 ?
            sortedBreakdown.map(([itemName, itemData]) => {
                return `
                    <div class="breakdown-item">
                        <div class="item-info">
                            <div class="item-name" style="font-weight:bold; color:${info.color};">${itemName}</div>
                            <div class="item-details">
                                ${itemData.input} ${itemData.unit || ''}
                            </div>
                        </div>
                        <div class="item-emission" style="color:${info.color};">
                            ${itemData.emission.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('')
            : '<div class="no-items" style="padding:0.5rem 1rem; color:#999;">暫無詳細項目</div>';

        card.innerHTML = `
            <div class="category-header" style="background-color:${info.bgcolor}; font-weight:bold; color:${info.color}; border-left: 8px solid ${info.color};">
                <h3 class="category-title" style="margin:0;">${info.name}</h3>
                <div class="category-value" style="color:${info.color};">${data.total.toFixed(2)}</div>
            </div>
            <div class="category-breakdown">
                ${itemsHTML}
            </div>
        `;

        container.appendChild(card);
    });
}

// 計算升溫幅度，累積碳排量線性插值
function calculateTemperatureIncrease(totalEmissions) {
    const currentYear = new Date().getFullYear();

    // 累積碳排量公式
    const cumulativeEmissions = (totalEmissions/11.77) * 4.86 * 8000000000 * (2100 - currentYear) / 1000000000;
    console.log('累積碳排量 (GtCO2):', cumulativeEmissions);

    // 累積碳排量對應的暖化映射
    const mapping = [
        { emissions: 0, temp: 0 },
        { emissions: 500, temp: 1.5 },
        { emissions: 1000, temp: 1.7 },
        { emissions: 1500, temp: 2.1 },
        { emissions: 2800, temp: 3.5 },
        { emissions: 3500, temp: 4 }
    ];

    let temperature = 0;

    // 線性內插
    for (let i = 0; i < mapping.length - 1; i++) {
        const p1 = mapping[i];
        const p2 = mapping[i + 1];
        if (cumulativeEmissions >= p1.emissions && cumulativeEmissions <= p2.emissions) {
            const ratio = (cumulativeEmissions - p1.emissions) / (p2.emissions - p1.emissions);
            temperature = p1.temp + ratio * (p2.temp - p1.temp);
            break;
        }
    }

    // 超過最大值顯示 4+
    if (cumulativeEmissions > mapping[mapping.length - 1].emissions) return '4+';

    // 下限 1.48
    if (temperature < 1.48) temperature = 1.48;

    return temperature.toFixed(2);
}

// 更新顯示資料
function updateDisplay() {
    const emissionsValueElement = document.getElementById('carbon-footprint-emissions-value');
    const temperatureValueElement = document.getElementById('carbon-footprint-temperature-value');

    if (totalEmissions > 0) {
        emissionsValueElement.textContent = totalEmissions.toFixed(2);

        // 更新升溫幅度
        temperatureValueElement.textContent = calculateTemperatureIncrease(totalEmissions) + '℃';

        // 更新中和說明
        const forestArea = Math.round(totalEmissions * 1388.889);
        const stadiums = (forestArea / 12950).toFixed(1);
        const neutralityText = document.getElementById('neutrality-text');
        neutralityText.innerHTML = `
          <p>為了中和您的排放，必須復育大約 
          <p><span class="neutrality-value">${forestArea.toLocaleString()}</span>
          m²的自然再生林地。</p><p>這大約與
          <span class="neutrality-value">${stadiums}</span>
          座台北大巨蛋相同！</p></p>
        `;

    } else {
        emissionsValueElement.textContent = '暫無數據';
        temperatureValueElement.textContent = '暫無數據';
        const neutralityText = document.getElementById('neutrality-text');
        neutralityText.textContent = '請完成碳足跡問卷，我們將為您計算需要復育的森林面積。';
    }

    createCategoryCards();

    generateRecommendations();
    generateAdvice();

    renderEmissionsChart();
}

// 初始化 Chart.js 圓餅圖
let emissionsChart = null;

function renderEmissionsChart() {
  const ctx = document.getElementById('emissions-chart').getContext('2d');
  const dataValues = [];
  const dataLabels = [];
  const dataColors = [];

  Object.entries(carbonData).forEach(([key, value]) => {
    if (value > 0) {
      dataValues.push(value);
      dataLabels.push(categoryInfo[key].name);
      dataColors.push(categoryInfo[key].color);
    }
  });

  // 如果已存在圖表就先銷毀
  if (emissionsChart) emissionsChart.destroy();

  // 初始化圓餅圖
  emissionsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: dataLabels,
      datasets: [{
        data: dataValues,
        backgroundColor: dataColors,
        borderWidth: 0,       // 去掉白邊
      }]
    },
    options: {
      responsive: true,
      cutout: '70%',
      plugins: {
        legend: {
          display: false 
        }
      }
    }
  });

  // 生成右側自訂 legend
  const legendContainer = document.getElementById('emissions-legend');
  legendContainer.innerHTML = '';
  const total = dataValues.reduce((a, b) => a + b, 0);

  dataLabels.forEach((label, index) => {
    const li = document.createElement('li');
    li.classList.add('legend-item');
    li.style.color = dataColors[index];

    const colorBox = document.createElement('span');
    colorBox.classList.add('legend-color');
    colorBox.style.backgroundColor = dataColors[index];

    const percent = ((dataValues[index] / total) * 100).toFixed(1);

    li.appendChild(colorBox);
    li.appendChild(document.createTextNode(`${label} , ${percent}%`));

    legendContainer.appendChild(li);
  });
}

function generateRecommendations() {
  const recommendations = [];

  // 取得有數值的項目，並排序取前三大
  const activeCategories = Object.entries(carbonData)
    .filter(([key, value]) => value > 0)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);

  const list = document.getElementById('recommendations-list');
  list.innerHTML = '';

  if (activeCategories.length === 0) {
    recommendations.push({
      pageKey: 'none',
      title: '尚未完成問卷',
      content: '請先完成碳足跡問卷，我們將根據您的數據提供個人化減碳建議'
    });
  } else {
    // 針對前三大類別提供詳細建議
    activeCategories.forEach(([pageKey, value]) => {
      switch(pageKey) {
        case 'traffic-daily':
          recommendations.push({
            pageKey,
            title: '你的日常通勤碳排放較高，可能是因為機車或汽車使用頻率較高。可以考慮改變部分通勤方式。',
            startContent:'例如：',
            content: '<li>短程改為步行或騎腳踏車，減少燃油車使用次數</li><li>若有條件，可改用電動車或共乘方式，減少個人排放</li><li>調整駕駛習慣，如保持胎壓、減少怠速，以提升燃油效率</li>'
          });
          break;
        case 'traffic-travel':
          recommendations.push({
            pageKey,
            title: '你的旅遊交通碳足跡較高，可能是來自飛機旅行。長途飛行是個人碳排放的主要來源之一。',
            startContent:'你可以考慮:',
            content: '<li>減少不必要的短途飛行，改搭高鐵或火車</li><li>若需飛行，選擇直飛航班，減少中轉產生的額外排放</li><li>支持碳補償計畫，如選擇航空公司的碳中和選項</li>'
          });
          break;
        case 'home':
          recommendations.push({
            pageKey,
            title: '你的住家碳排放較高，可能與家電使用、冷氣或熱水器有關。',
            startContent:'你可以嘗試：',
            content: '<li>更換高效節能電器，如 LED 燈、變頻冷氣</li><li>減少不必要的電器待機電力，使用插座開關隨手關閉</li><li>提升房屋隔熱效果，減少冷氣或暖氣的使用需求</li>'
          });
          break;
        case 'food':
          recommendations.push({
            pageKey,
            title: '你的食物碳足跡較高，可能來自高碳排的飲食選擇，如紅肉、乳製品或進口食品。',
            startContent:'你可以考慮:',
            content: '<li>減少牛肉與羊肉攝取，改為雞肉、魚類或植物蛋白</li><li>優先選擇當地、當季食材，減少長途運輸的碳排</li><li>避免食物浪費，適量購買、保存與利用剩食</li>'
          });
          break;
        case 'fashion':
          recommendations.push({
            pageKey,
            title: '你的衣物碳足跡較高，可能與頻繁購衣或快時尚消費習慣有關。',
            startContent:'試試這些方法降低影響：',
            content: '<li>選擇高品質、耐穿的衣物，減少購買頻率</li><li>支持二手市場，或參加舊衣回收、交換活動</li><li>洗衣時使用冷水並自然晾乾，減少乾衣機的能源消耗</li>'
          });
          break;
        case 'entertainment':
          recommendations.push({
            pageKey,
            title: '你的娛樂碳足跡較高，可能來自頻繁購買電子產品或高耗能的娛樂方式，如長時間串流影片。',
            startContent:'試試這些改變：',
            content: '<li>減少不必要的電子產品升級，延長設備使用壽命</li><li>調低串流影片解析度，或改為下載觀看，減少數據中心耗能</li><li>嘗試更多低碳娛樂，如閱讀、戶外活動或桌遊</li>'
          });
          break;
      }
    });
  }

  // 顯示建議
  list.innerHTML = recommendations.map(rec => {
    if (rec.pageKey === 'none') {
      return `
        <li class="recommendation-item no-category">
          <div class="recommendation-title">
            <span class="marker marker-gray"></span>
            ${rec.title}
          </div>
          <div class="recommendation-content"><p>${rec.startContent}</p><ul>${rec.content}</ul></div>
        </li>
      `;
    } else {
      const info = categoryInfo[rec.pageKey];
      return `
        <li class="recommendation-item">
          <div class="recommendation-title" style="color:${info.color};">
            <span class="marker" style="background-color:${info.color};"></span>
            ${rec.title}
          </div>
          <div class="recommendation-content"><p>${rec.startContent}</p><ul>${rec.content}</ul></div>
        </li>
      `;
    }
  }).join('');
}

// ===================== 工具函式 =====================
const isNumber = v => typeof v === 'number' && isFinite(v);
const sum = arr => arr.reduce((a,b)=>a+(isNumber(b)?b:0),0);
const share = (part, total) => {
  const p = isNumber(part) ? part : 0;
  const t = isNumber(total) && total > 0 ? total : 0;
  return t === 0 ? 0 : p / t;
};
const hasAnyPositive = obj => !!obj && Object.values(obj).some(v => isNumber(v) ? v > 0 : !!v);

// 取最大鍵名（忽略非數字或 <=0）
function maxKey(obj, keys) {
  let best = null, bestVal = -Infinity;
  if (!obj) return null;
  for (const k of keys) {
    const v = obj[k];
    if (isNumber(v) && v > bestVal && v > 0) {
      best = k; bestVal = v;
    }
  }
  return best;
}

// 建議模板函數 - 根據類別返回帶顏色的建議內容
function getAdviceTemplate(templateKey, categoryKey) {
    const info = categoryInfo[categoryKey];
    if (!info) return '';
    
    const color = info.color;
    
    const templates = {
        // --- 日常通勤 ---
        commute_car: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>開車通勤雖然方便，但對地球可有點傷～來看看有什麼小方法能幫你減碳又不太麻煩：</p>
                <ul>
                    <li>偶爾搭搭大眾運輸：如果有地鐵、公車或高鐵能搭，不妨偶爾放下方向盤，改搭一下，碳排少很多，而且還不用找停車位超讚！</li>
                    <li>能走就走，能騎就騎：你家離公司或學校不遠嗎？那就走路或騎腳踏車吧～順便活動筋骨、醒腦又省碳，一舉三得～</li>
                    <li>找人一起坐車也很棒：真的要開車的話，也可以找同事或朋友一起共乘，少一台車跑在路上，空氣會感謝你～</li>
                    <li>換台電動車也不錯啦：如果你本來就有開車的需求，那可以考慮未來換成電動車，現在充電站越來越多，也越來越方便了，減碳效果也很不錯！</li>
                </ul>
            </div>
        `,

        // --- 旅遊 ---
        travel_plane: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>搭飛機雖然快速又方便，但其實飛行是碳排放非常高的一種交通方式，特別是短程航班，起降階段排放量特別驚人。不過不用完全戒飛，改變一點點，也能減碳不少：</p>
                <ul>
                    <li>少搭短程飛機：像是「台北到高雄」或「台中到金門」這種短程航班，飛行時間雖然短，但起降階段的碳排放其實特別高。不妨改搭高鐵或船，不只更環保，有時候整體時間也差不多，還省下候機時間呢！</li>
                    <li>把旅行排得更有計劃：與其一年飛好幾趟，不如一次安排長一點的假期，減少搭機次數又能玩得更盡興。</li>
                    <li>探索低碳旅遊方式：搭火車、高鐵、公車旅遊，碳排低又能慢慢欣賞沿途風景，其實也滿療癒的。</li>
                    <li>選擇碳補償航班：部分航空公司有提供碳補償選項，可以用少量費用支持碳抵換專案（例如植樹、再生能源），多少幫地球平衡一下。</li>
                </ul>
            </div>
        `,
        travel_public: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>你選擇搭大眾運輸通勤，真的超棒的！這比自己開車或騎機車環保多了，已經是很棒的低碳選擇了～<br>如果你還想再進一步為地球多做一點，這邊有幾個小撇步可以參考看看：</p>
                <ul>
                    <li>接駁也能低碳一點：從家裡到高鐵或火車站那段路，可以的話就走路、騎腳踏車，或再接一段公車，減少短途開車的碳排也有幫助喔～</li>
                    <li>支持碳中和服務：有些列車或航空公司有推出「綠色座位」或碳補償選項（例如種樹、投資再生能源），未來如果看到這種服務，可以考慮支持一下，讓你的旅程更環保！</li>
                    <li>有時候遠端也不錯：如果工作性質允許，不妨和公司討論看看可不可以一週有幾天遠端上班，這樣不但省通勤時間，還能少搭幾趟車，碳排自然就少了～</li>
                    <li>你就是最棒的綠色榜樣：你已經走在減碳的路上了，不妨把你的經驗分享給身邊的親朋好友，大家一起搭大眾運輸，對環境的幫助會更大！</li>
                </ul>
            </div>
        `,

        // --- 住家 ---
        home_water: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>你家裡的碳足跡主要來自「用水」這塊，雖然水本身不會排碳，但抽水、加熱洗澡水、處理廢水這些過程其實都會耗能，碳排也跟著來～但別擔心，幾個小改變就能讓家裡更環保：</p>
                <ul>
                    <li>洗澡時間稍微縮短一下下：把淋浴時間縮短個 3～5 分鐘，或者水溫稍微調低一點，熱水器就不用那麼拚命燒水，省能又省錢。</li>
                    <li>冷水洗衣更聰明：熱水洗衣其實沒必要（而且可能還傷衣服），不如改用冷水，省下不少加熱的電力～還有記得累積多一點衣服再洗，減少洗衣次數也有幫助！</li>
                    <li>馬桶沖水也可以省一點：如果家裡是舊式馬桶，可以換成雙段式省水款；或是放個寶特瓶在水箱裡，讓每次沖水的水量變少，效果其實滿有感的！</li>
                    <li>注意漏水 + 換節水設備：定期檢查水龍頭和馬桶有沒有在偷偷漏水～也可以考慮裝省水花灑、水龍頭起泡器這類的節水小工具，用起來跟一般的一樣，但其實很省水。</li>
                    <li>回收水二次利用：像洗菜水可以拿來澆花、沖馬桶，這種簡單的小動作，真的超實用又環保！</li>
                    <p>小小調整就能省下很多水和能源，不只幫地球減碳，連水費都會變少一點，環境跟荷包一起加分，何樂而不為呢？</p>
                </ul>
            </div>
        `,
        home_electric: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>你的住家碳足跡偏高，主要是用電量比較多。雖然用電是現代生活的基本需求，但其實很多時候，我們可以用得更聰明、更省碳一點～來看看有什麼實用又不難的小改變吧：</p>
                <ul>
                    <li>白天善用自然光：白天能不開燈就不開，讓陽光幫你省一波電，心情也比較好！</li>
                    <li>冷氣使用有技巧：冷氣不要一開就設很低，設在 26～28 度是舒適又省電的甜蜜點，加上電風扇一起用，涼感會更快也更省～別忘了定期清洗濾網，冷氣才不會「偷吃電」喔。</li>
                    <li>留意「待機電力」的小地方：有些家電像是電視、微波爐、音響，沒開機的時候，其實也會偷偷耗一點電。如果你覺得不方便，可以考慮用有開關的延長線，一次切電就好，不用天天拔插頭～對於不常用的電器，偶爾拔一下也不錯，雖然省的不多，但累積起來還是有差！ ！</li>
                    <li>換成節能燈泡：LED 燈比傳統燈泡省電好幾倍，而且更耐用，長遠下來超划算！</li>
                    <li>家電使用也能小省一下：洗衣機、洗碗機等大型家電累積多一點再用，效率會更高。如果有要換家電，也可以優先選有「節能標章」的款式，真的有差！</li>
                    <p>其實生活中很多微小的習慣，只要稍微調整一下，用電就能降下來。不只是減碳，電費也會跟著變可愛，省心又省荷包～</p>
                </ul>
            </div>
        `,
        home_gas: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>瓦斯是日常生活中常見的能源，但每次使用其實也會有一些碳排放。小小的調整可以幫助你減少碳足跡：</p>
                <ul>
                    <li>調整烹飪方式：烹煮食物時，盡量選擇適當的鍋具，使用適當的火力，可以讓瓦斯燃燒更有效率，不用開那麼大火。</li>
                    <li>控制烹飪時間：有些食物煮太久，火候過大不但浪費瓦斯，還會影響食物品質。試著規劃食物煮的時間，避免過長的等待。</li>
                    <li>高效能爐具：如果打算換爐具，可以選擇能效較高的瓦斯爐，這樣可以讓每次烹飪時的能源消耗更低。</li>
                    <p小小改變，讓每一次的烹飪都更加節能！不僅能幫地球減碳，還能節省瓦斯費用，一舉兩得！</p>
                </ul>
            </div>
        `,
        home_trash: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>垃圾處理會產生相當多的碳排放，減少垃圾量和增加回收利用是減碳的關鍵。這裡有幾個可以參考的小建議：</p>
                <ul>
                    <li>分類回收：確保家庭垃圾分類清楚，將可回收物品如塑膠、金屬、紙類分開，這樣可以減少進入垃圾掩埋場的量。</li>
                    <li>減少一次性物品：盡量減少使用一次性包裝材料或塑膠袋，選擇可重複使用的容器，這樣有助於減少垃圾量。</li>
                    <li>購物減量：每次購物前，考慮是否真的需要，避免過多的物品消耗與包裝產生垃圾。</li>
                    <p>把垃圾分類好、減少一次性物品，這些小舉動就能讓你為環保出一份力！每次購物、每次選擇，都能對地球產生正面的影響！</p>
                </ul>
            </div>
        `,

        // --- 衣服 ---
        clothes_fast: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>快時尚建議（給愛買衣服又想顧地球的你)<br>愛穿搭沒什麼不好，但快時尚的衣服為了便宜、流行，常常大量生產、快速淘汰，對環境其實蠻傷的。你不一定要變成極簡主義者，但可以從以下幾個方向開始：</p>
                <ul>
                    <li>買少一點、挑好一點：下手前先想想這件衣服能不能穿好幾次、搭配性高不高。一次買一堆，結果都穿不到幾次真的很浪費。</li>
                    <li>支持比較有良心的品牌：現在有越來越多品牌開始注重永續，用回收布料、生產更透明，支持他們等於用錢投票，讓好的品牌活下來。</li>
                    <li>發聲也能帶來改變：覺得某品牌浪費太誇張、不重視環境？可以在社群媒體上發聲或留言，很多品牌其實會聽的！</li>
                    <p>時尚可以是環保的，從每一次的選擇開始，讓你穿得好看，也穿得安心！</p>
                </ul>
            </div>
        `,
        clothes_luxury: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>奢華時尚建議（給懂質感又有環保意識的你)<br>精品不一定比快時尚環保，尤其是長途運送、過度包裝、使用稀有材料等等，加起來碳排也不少。但如果你喜歡精品，其實也可以穿得有格調又不傷地球：</p>
                <ul>
                    <li>買之前想長遠：挑真正喜歡、能穿好幾年、甚至穿到老的款式，才是真正值得投資。</li>
                    <li>挑選有永續理念的精品品牌：像 Stella McCartney、Chloé 有些系列就強調環保設計，買得安心又有品味。</li>
                    <li>不穿的也別浪費：可以拿去精品寄售店、或轉賣平台，讓其他人繼續珍惜它。</li>
                    <li>讓品牌知道你在意：用你的聲音鼓勵更多精品品牌重視環保，消費者的力量真的很強大！</li>
                </ul>
            </div>
        `,

        // --- 食物 ---
        food_meat: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>葷食<br>嘿～如果你的飲食中紅肉佔比高，其實這樣對碳排放的影響不小。別擔心，這裡有幾個小撇步，讓你也能吃得健康又減碳：</p>
                <ul>
                    <li>少吃紅肉，多選白肉：牛排雖然好吃，但牛肉的碳排放超高！不妨試試雞肉、魚肉，它們的碳足跡比較輕，也有很好的蛋白質來源。</li>
                    <li>選擇可持續養殖的肉品：如果還是想吃肉，記得挑選有機或可持續養殖的肉品，這樣對環境的影響會小一些。</li>
                    <li>多加點植物性食物：偶爾換換口味，加入更多蔬菜、豆腐、豆類等，這不僅對你的健康有益，還能讓你的碳足跡下降！</li>
                    <li>購買當地食材：少買進口的食物，選擇當季當地的蔬果或肉品，這樣不但新鮮，還能減少運輸的碳排放。</li>
                </ul>
            </div>
        `,
        food_vege: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>素食<br>讚啦！素食本來就是減碳的一大步。不過還是有些小地方可以再調整，讓你對地球更友善：</p>
                <ul>
                    <li>吃得更有變化：選擇多樣化的植物性食物，讓飲食更營養，也能有效減少因單一作物需求過度造成的碳排放。</li>
                    <li>挑選當季食材：去菜市場挑選當季的蔬菜，這樣不僅能減少碳排放，還能讓你吃到最新鮮的食物。</li>
                    <li>減少加工素食食品：雖然市面上有很多素肉漢堡、素食香腸等，但這些加工過的食品對碳排放的影響其實也蠻大的。嘗試更多自家料理，這樣不僅能減少碳足跡，也能吃得更健康！</li>
                    <li>購買當地食材：少買進口的食物，選擇當季當地的蔬果，這樣不但新鮮，還能減少運輸的碳排放。</li>
                </ul>
            </div>
        `,
        food_waste: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>廚餘的處理不當會讓有機垃圾變成溫室氣體的源頭，這裡有一些改善的方法：</p>
                <ul>
                    <li>廚餘堆肥：如果有空間，試著將廚餘進行堆肥處理，不僅減少垃圾，也能為你的花園提供有機肥料。</li>
                    <li>減少食物浪費：合理規劃每次的食物分量，避免過多食物被丟棄，這樣不僅減少廚餘，也能節省預算。</li>
                    <li>廚餘分開處理：將廚餘與其他垃圾分開丟，避免對廢物處理系統造成負擔，並提高廚餘的回收率。</li>
                </ul>
            </div>
        `,

        // --- 娛樂 ---
        ent_cinema: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>去電影院看電影超療癒，但別忘了影廳的冷氣、燈光、音響都會耗電。試試以下方式減點碳吧：</p>
                <ul>
                    <li>選擇中小型影院：比較省電，也有機會支持在地小型經營者 </li>
                    <li>少開車去電影院：搭捷運、騎腳踏車或跟朋友一起共乘都不錯</li>
                    <li>選擇節能影廳：有些新式影廳會使用LED放映設備，比傳統放映更環保！邊享受電影邊愛地球也不衝突！</li>
                    <p>挑間省電又有質感的電影院，不只觀影體驗升級，也能讓你的低碳生活更有趣！</p>
                </ul>
            </div>
        `,
        ent_ktv: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>唱K超紓壓，但KTV的冷氣、燈光、音響可是電力大怪獸！來看看怎麼唱得更低碳：</p>
                <ul>
                    <li>挑選節能 KTV：有些店家會標榜省電或綠能，優先支持這些場所</li>
                    <li>控制冷氣：溫度不要開太低，唱到出汗才過癮嘛</li>
                    <li>交通工具很重要：跟朋友一起坐車或搭捷運，少一點碳，多一點快樂小結語：唱得嗨也能唱出綠生活！</li>
                    <p>小小改變，就能讓你的歡唱夜少一點碳、多一點對地球的溫柔</p>
                </ul>

            </div>
        `,
        ent_gym: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>運動超棒！但健身房裡的器材、冷氣真的挺耗電。想運動又顧地球？可以這樣做：</p>
                <ul>
                    <li>選永續設備的健身房：有些健身房會標榜節能、用再生能源或有環保認證，優先選這種不只能動得安心，還能對地球友善一點</li>
                    <li>多練自由重量或自重訓練：像是啞鈴、槓鈴或徒手深蹲、伏地挺身，這些訓練方式不但不耗電，效果一樣好，還能練出穩定核心，訓練品質更高！</li>
                    <li>選擇離峰時段：人少時去健身房，整體能源消耗也會少一點，低碳也能高效鍛鍊！</li>
                    <p>你不需要為了環保就犧牲訓練效果，改用自由重量或自重訓練，照樣能進步、練出成果，還能默默替地球省下一筆能源～綠色健身，其實沒那麼難</p>
                </ul>

            </div>
        `,
        ent_religion: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>拜拜求心安沒問題，但燒香也會產生碳排和空氣污染喔～不如這樣調整看看：</p>
                <ul>
                    <li>用環保香：市面上有些低煙、少毒的香品，可以當替代方案。</li>
                    <li>少量燒香：不一定要「煙霧瀰漫」才靈驗，心誠就好！</li>
                    <li>電子拜拜也可以：有些寺廟已經使用電子香爐，乾淨又方便，誠心不靠煙，環保更平安！</li>
                    <p>信仰加上環保，讓你的善念也為地球盡一份心力</p>
                </ul>
            </div>
        `,
        ent_hotel: `
            <div class="advice-section" style="color:${color};">
                <p><span class="advice-dot" style="background-color:${color};"></span>出去玩最開心～但飯店也會有不少能源耗用。來試試這些小改變，旅行更永續：</p>
                <ul>
                    <li>選綠色旅館：像是有環保認證（LEED、EarthCheck）的飯店</li>
                    <li>減少清潔服務：連住幾天其實不需要每天打掃，幫忙節省水電與清潔劑</li>
                    <li>搭大眾交通工具：旅行途中改搭巴士、捷運、共乘都能減碳</li>
                    <li>自備一次性用品：牙刷、刮鬍刀自己帶，不拿飯店備品也能減少浪費，旅行開心，地球也一起開心!</li>
                    <p>用綠色方式住飯店，你的每一趟旅程都會留下更好的回憶和足跡</p>
                </ul>
            </div>
        `,
    };

    return templates[templateKey] || '';
}


// ===================== 將 carbonDetailedData 轉換為 userData 格式 =====================
function convertCarbonDataToUserData() {
    const userData = {
        commute: {},
        travel: {},
        home: {},
        clothes: { type: null },
        food: { diet: null, foodWasteInput: 0 },
        entertainment: {},
        filled: {}
    };

    const hasData = (categoryData) => categoryData && categoryData.total > 0 && 
                     Object.keys(categoryData.breakdown).length > 0;

    // 日常通勤
    if (hasData(carbonDetailedData['traffic-daily'])) {
        userData.filled.commute = true;
        const breakdown = carbonDetailedData['traffic-daily'].breakdown;
        
        Object.entries(breakdown).forEach(([itemName, itemData]) => {
            const name = itemName.toLowerCase();
            if (name.includes('汽车') || name.includes('汽車') || name.includes('开车') || name.includes('駕車')) {
                userData.commute.car = (userData.commute.car || 0) + itemData.emission;
            } else if (name.includes('机车') || name.includes('機車') || name.includes('摩托车') || name.includes('摩托車')) {
                userData.commute.motorcycle = (userData.commute.motorcycle || 0) + itemData.emission;
            } else if (name.includes('公车') || name.includes('公車') || name.includes('地铁') || name.includes('地鐵') || 
                      name.includes('捷运') || name.includes('捷運') || name.includes('高铁') || name.includes('高鐵')) {
                userData.commute.public = (userData.commute.public || 0) + itemData.emission;
            } else if (name.includes('步行') || name.includes('走路')) {
                userData.commute.walk = (userData.commute.walk || 0) + itemData.emission;
            } else if (name.includes('自行车') || name.includes('自行車') || name.includes('腳踏車')) {
                userData.commute.bike = (userData.commute.bike || 0) + itemData.emission;
            } else {
                userData.commute.car = (userData.commute.car || 0) + itemData.emission;
            }
        });
    } else {
        userData.filled.commute = false;
    }

    // 旅游交通
    if (hasData(carbonDetailedData['traffic-travel'])) {
        userData.filled.travel = true;
        const breakdown = carbonDetailedData['traffic-travel'].breakdown;
        
        Object.entries(breakdown).forEach(([itemName, itemData]) => {
            const name = itemName.toLowerCase();
            if (name.includes('飞机') || name.includes('飛機') || name.includes('航班') || name.includes('搭機')) {
                userData.travel.flight = (userData.travel.flight || 0) + itemData.emission;
            } else if (name.includes('高铁') || name.includes('高鐵')) {
                userData.travel.hsr = (userData.travel.hsr || 0) + itemData.emission;
            } else if (name.includes('火车') || name.includes('火車') || name.includes('台铁') || name.includes('台鐵')) {
                userData.travel.train = (userData.travel.train || 0) + itemData.emission;
            } else if (name.includes('公车') || name.includes('公車') || name.includes('客运') || name.includes('客運')) {
                userData.travel.bus = (userData.travel.bus || 0) + itemData.emission;
            } else if (name.includes('船') || name.includes('轮船') || name.includes('輪船')) {
                userData.travel.ship = (userData.travel.ship || 0) + itemData.emission;
            } else {
                if (itemData.emission > 100) {
                    userData.travel.flight = (userData.travel.flight || 0) + itemData.emission;
                } else {
                    userData.travel.train = (userData.travel.train || 0) + itemData.emission;
                }
            }
        });
    } else {
        userData.filled.travel = false;
    }

    // 居住生活
    if (hasData(carbonDetailedData['home'])) {
        userData.filled.home = true;
        const breakdown = carbonDetailedData['home'].breakdown;
        
        Object.entries(breakdown).forEach(([itemName, itemData]) => {
            const name = itemName.toLowerCase();
            if (name.includes('水') || name.includes('热水') || name.includes('熱水') || name.includes('洗澡')) {
                userData.home.water = (userData.home.water || 0) + itemData.emission;
            } else if (name.includes('电') || name.includes('電') || name.includes('冷气') || name.includes('冷氣') || 
                      name.includes('家电') || name.includes('家電')) {
                userData.home.electricity = (userData.home.electricity || 0) + itemData.emission;
            } else if (name.includes('瓦斯') || name.includes('天然气') || name.includes('天然氣') || name.includes('煮饭') || name.includes('煮飯')) {
                userData.home.gas = (userData.home.gas || 0) + itemData.emission;
            } else if (name.includes('垃圾') || name.includes('废物') || name.includes('廢物')) {
                userData.home.trash = (userData.home.trash || 0) + itemData.emission;
            } else {
                userData.home.electricity = (userData.home.electricity || 0) + itemData.emission;
            }
        });
    } else {
        userData.filled.home = false;
    }

    // 日常飲食
    if (hasData(carbonDetailedData['food'])) {
        userData.filled.food = true;
        const breakdown = carbonDetailedData['food'].breakdown;
        
        let meatEmission = 0;
        let vegetableEmission = 0;
        let wasteInput = 0;

        Object.entries(breakdown).forEach(([itemName, itemData]) => {
            const name = itemName.toLowerCase();
            if (name.includes('肉') || name.includes('牛') || name.includes('猪') || name.includes('豬') || 
                name.includes('鸡') || name.includes('雞') || name.includes('鱼') || name.includes('魚')) {
                meatEmission += itemData.emission;
            } else if (name.includes('蔬菜') || name.includes('素食') || name.includes('豆') || name.includes('菜')) {
                vegetableEmission += itemData.emission;
            } else if (name.includes('浪费') || name.includes('浪費') || name.includes('厨余') || name.includes('剩食')) {
                wasteInput += itemData.input || 0;
            }
        });

        const foodBreakdown = carbonDetailedData['food']?.breakdown;
        if (foodBreakdown) {
          diet = Object.values(foodBreakdown).find(item => item.selectedDiet)?.selectedDiet;
        }
        userData.food.diet = diet;

        userData.food.foodWasteInput = wasteInput;

    } else {
        userData.filled.food = false;
    }

    // 時尚
    if (hasData(carbonDetailedData['fashion'])) {
        userData.filled.clothes = true;
        const breakdown = carbonDetailedData['fashion'].breakdown;

        const fastEmission = breakdown["快時尚"]?.emission || 0;
        const luxuryEmission = breakdown["奢華時尚"]?.emission || 0;

        userData.clothes.value = fastEmission + luxuryEmission;
        userData.clothes.type = fastEmission >= luxuryEmission ? 'fast' : 'luxury';
    } else {
        userData.filled.clothes = false;
    }

    // 娛樂
    if (hasData(carbonDetailedData['entertainment'])) {
        userData.filled.entertainment = true;
        const breakdown = carbonDetailedData['entertainment'].breakdown;
        
        Object.entries(breakdown).forEach(([itemName, itemData]) => {
            const name = itemName.toLowerCase();
            if (name.includes('电影') || name.includes('電影') || name.includes('影院')) {
                userData.entertainment.cinema = (userData.entertainment.cinema || 0) + itemData.emission;
            } else if (name.includes('ktv') || name.includes('卡拉ok') || name.includes('歌唱')) {
                userData.entertainment.ktv = (userData.entertainment.ktv || 0) + itemData.emission;
            } else if (name.includes('健身') || name.includes('运动') || name.includes('運動') || name.includes('gym')) {
                userData.entertainment.gym = (userData.entertainment.gym || 0) + itemData.emission;
            } else if (name.includes('拜拜') || name.includes('宗教') || name.includes('庙') || name.includes('廟')) {
                userData.entertainment.religion = (userData.entertainment.religion || 0) + itemData.emission;
            } else if (name.includes('旅馆') || name.includes('旅館') || name.includes('饭店') || name.includes('飯店') || name.includes('酒店')) {
                userData.entertainment.hotel = (userData.entertainment.hotel || 0) + itemData.emission;
            } else {
                if (itemData.emission > 20) {
                    userData.entertainment.hotel = (userData.entertainment.hotel || 0) + itemData.emission;
                } else if (itemData.emission > 10) {
                    userData.entertainment.cinema = (userData.entertainment.cinema || 0) + itemData.emission;
                } else {
                    userData.entertainment.ktv = (userData.entertainment.ktv || 0) + itemData.emission;
                }
            }
        });
    } else {
        userData.filled.entertainment = false;
    }

    return userData;
}

// ===================== 生成建議 =====================
function generateAdvice(customUserData = null) {
    const adviceEl = document.getElementById('advice-page');
    if (!adviceEl) return;
    adviceEl.innerHTML = '';

    const userData = customUserData || convertCarbonDataToUserData();
    const filled = userData.filled || {};

    // 計算六大類總和
    const sums = {
        'traffic-daily': sum([userData?.commute?.car, userData?.commute?.motorcycle, userData?.commute?.public, userData?.commute?.walk, userData?.commute?.bike]),
        'traffic-travel': sum([userData?.travel?.flight, userData?.travel?.hsr, userData?.travel?.train, userData?.travel?.bus, userData?.travel?.ship]),
        'home': sum([userData?.home?.water, userData?.home?.electricity, userData?.home?.gas]),
        'fashion': userData?.clothes?.value || 0,
        'food': (userData?.food?.value || 0) + (userData?.food?.foodWasteInput || 0),
        'entertainment': sum(Object.values(userData?.entertainment || {}))
    };

    // 建立六大類長方形卡片 (依照 categoryInfo 設定名稱和顏色)
    let summaryHTML = `<div class="advice-summary-container">`;
    Object.entries(sums).forEach(([key, value]) => {
        const info = categoryInfo[key] || { name: key, color: '#333', bgcolor: '#eee' };
        summaryHTML += `
          <div class="advice-summary-card" style="background:${info.bgcolor}; border-left:6px solid ${info.color};">
              <span class="advice-name" style="color:${info.color};">${info.name}</span>
              <span class="advice-value" style="color:${info.color};">${(value || 0).toFixed(2)}</span>
          </div>
        `;
    });
    summaryHTML += `</div>`;

    adviceEl.innerHTML = summaryHTML;

    // 通勤
    if (filled.commute) {
        const c = userData.commute || {};

        const hasValue = Object.values(c || {}).some(v => isNumber(v) && v > 0);

        if (hasValue) {
            adviceEl.innerHTML += getAdviceTemplate('commute_car', 'traffic-daily');
        }
    }

    // 住家
    if (filled.home) {
        const h = userData.home || {};
        const topKey = maxKey(h, ['water','electricity','gas']);
        if (topKey === 'water') adviceEl.innerHTML += getAdviceTemplate('home_water', 'home');
        if (topKey === 'electricity') adviceEl.innerHTML += getAdviceTemplate('home_electric', 'home');
        if (topKey === 'gas') adviceEl.innerHTML += getAdviceTemplate('home_gas', 'home');
        if (Object.keys(h).length > 0) {
            adviceEl.innerHTML += getAdviceTemplate('home_trash', 'home');
        }
    }

    // 旅游
    if (filled.travel) {
        const t = userData.travel || {};
        const totalTravel = sum([t.flight, t.hsr, t.train, t.bus, t.ship]);
        const flightShare = share(t.flight, totalTravel);
        const publicTravel = sum([t.hsr, t.train, t.bus, t.ship]);
        const publicShare = share(publicTravel, totalTravel);

        if ((t.flight > 0) && (t.flight > publicTravel || flightShare > 0.5)) {
            adviceEl.innerHTML += getAdviceTemplate('travel_plane', 'traffic-travel');
        } else if ((t.flight || 0) === 0 && publicShare >= 0.6 && publicShare > 0) {
            adviceEl.innerHTML += getAdviceTemplate('travel_public', 'traffic-travel');
        }
    }

    // 食物
    if (filled.food) {
        const f = userData.food || {};
        const diet = f.diet;
        if (diet === 'omnivore') adviceEl.innerHTML += getAdviceTemplate('food_meat', 'food');
        if (diet === 'vegetarian' || diet === 'vegan') adviceEl.innerHTML += getAdviceTemplate('food_vege', 'food');
        
        // ⭐ 直接檢查剩食 input
        if (isNumber(f.foodWasteInput) && f.foodWasteInput > 20) {
            adviceEl.innerHTML += getAdviceTemplate('food_waste', 'food');
        }
        console.log('食物浪費輸入值:', f.foodWasteInput);
    }

    // 衣服
    if (filled.clothes) {
        const type = userData?.clothes?.type;
        if (type === 'fast') adviceEl.innerHTML += getAdviceTemplate('clothes_fast', 'fashion');
        if (type === 'luxury') adviceEl.innerHTML += getAdviceTemplate('clothes_luxury', 'fashion');
    }

    // 娛樂
    if (filled.entertainment) {
        const e = userData.entertainment || {};
        const totalEnt = sum(Object.values(e));
        const entShare = key => share(e[key], totalEnt);

        if (entShare('cinema') >= 0.05) adviceEl.innerHTML += getAdviceTemplate('ent_cinema', 'entertainment');
        if (entShare('ktv') >= 0.05) adviceEl.innerHTML += getAdviceTemplate('ent_ktv', 'entertainment');
        if (entShare('gym') >= 0.05) adviceEl.innerHTML += getAdviceTemplate('ent_gym', 'entertainment');
        if (entShare('religion') >= 0.05) adviceEl.innerHTML += getAdviceTemplate('ent_religion', 'entertainment');
        if (entShare('hotel') >= 0.05) adviceEl.innerHTML += getAdviceTemplate('ent_hotel', 'entertainment');
    }

    if (!Object.values(filled).some(Boolean)) {
        adviceEl.innerHTML = `
            <div class="no-data-advice">
                <p><span class="advice-dot" style="background-color:#999;"></span>尚未完成碳足跡問卷，請先完成問卷，我們將根據您的數據提供個人化減碳建議。</p>
            </div>
        `;
    }
}


// 重置為桌面模式
function resetToDesktopMode() {
    const container = document.querySelector(".scroll-container");
    const body = document.body;
    
    // 重置滾動位置到頂部
    if (container) {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // 重置所有元素的透明度
    setTimeout(() => {
        // 第一幕元素顯示
        gsap.set(".scene-1 .sealevel-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-emissions-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-temperature-container", { opacity: 1 });
        
        // 第二幕元素隱藏
        gsap.set(".scene-2 .carbon-footprint-status-container", { opacity: 0 });
        gsap.set(".scene-2 .recommendations", { opacity: 0 });
    }, 100);
    
    // 清除可能的樣式覆蓋
    body.style.overflow = "";
    if (container) {
        container.style.overflow = "";
    }
}

// 重置為移動模式
function resetToMobileMode() {
    const container = document.querySelector(".scroll-container");
    
    // 重置滾動位置到頂部
    if (container) {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // 確保所有元素在移動版本都顯示
    setTimeout(() => {
        gsap.set(".scene-1 .sealevel-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-emissions-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-temperature-container", { opacity: 1 });
        gsap.set(".scene-2 .carbon-footprint-status-container", { opacity: 1 });
        gsap.set(".scene-2 .recommendations", { opacity: 1 });
    }, 100);
}

function handleModeChange() {
    const mobile = isMobile();
    
    if (currentMode === mobile) {
        return;
    }
    
    console.log(`模式切換: ${currentMode === null ? '初始化' : (currentMode ? '移動' : '桌面')} -> ${mobile ? '移動' : '桌面'}`);
    
    currentMode = mobile;
    
    if (mobile) {
        // 切換到移動模式
        resetToMobileMode();

        removeDesktopEventListeners();
        sceneTransitionsSetup = false;
    } else {
        // 切換到桌面模式
        resetToDesktopMode();

        if (!sceneTransitionsSetup) {
            setTimeout(() => {
                setupSceneTransitions();
                sceneTransitionsSetup = true;
            }, 200);
        }
    }
}

let currentScrollListener = null;
let currentMouseListeners = [];

function removeDesktopEventListeners() {
    const container = document.querySelector(".scroll-container");
    
    if (container && currentScrollListener) {
        container.removeEventListener('wheel', currentScrollListener);
        currentScrollListener = null;
    }

    currentMouseListeners.forEach(({ element, listener }) => {
        if (element && listener) {
            element.removeEventListener('click', listener);
        }
    });
    currentMouseListeners = [];
}

document.addEventListener("DOMContentLoaded", async () => {
    const loadingScreen = document.querySelector('.loading-screen');
    const iframe = document.getElementById("mapFrame");

    // 用兩個旗標控制 loading 是否可以隱藏
    let calculationDone = false;
    let iframeLoaded = false;

    // 當 iframe 完全載入
    iframe.addEventListener("load", () => {
        console.log("iframe 已載入完成");
        iframeLoaded = true;
        tryHideLoading();
    });

    // 計算碳足跡
    try {
        const success = await calculateCarbonFootprintDetailed();

        if (success) {
            updateDisplay();
            console.log('碳足跡計算完成:', carbonDetailedData);
            console.log('總排放量:', totalEmissions);
        } else {
            document.getElementById('carbon-footprint-emissions-value').textContent = '計算失敗';
        }
    } catch (error) {
        console.error('初始化錯誤:', error);
        showError('系統初始化失敗，請重新整理頁面');
    } finally {
        calculationDone = true;
        tryHideLoading();
    }

    handleModeChange();

    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            handleModeChange();
        }, 250);
    });

    // 監聽裝置方向改變
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            handleModeChange();
        }, 500);
    });

    // 檢查是否可以隱藏 loading
    function tryHideLoading() {
        if (calculationDone && iframeLoaded) {
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 500); // 延遲小段時間，視覺效果更平滑
        }
    }
});


// 桌面板廠景切換
function setupSceneTransitions() {
    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting && entry.target.classList.contains('scene-2')) {
                    setTimeout(() => {
                    }, 1000);
                }
            });
        },
        { threshold: 0.6 }
    );

    observer.observe(document.querySelector(".scene-2"));

    const container = document.querySelector(".scroll-container");
    let isScrolling = false;
    const cooldownTime = 3000;
    let lastScrollTime = 0;

    function disableScroll() {
      document.body.style.overflow = "hidden";
      container.style.overflow = "hidden";

      // 禁止滑鼠滾輪
      window.addEventListener("wheel", preventScroll, { passive: false });
      // 禁止觸控滑動
      window.addEventListener("touchmove", preventScroll, { passive: false });
    }

    function enableScroll() {
      document.body.style.overflow = "";
      container.style.overflow = "";

      window.removeEventListener("wheel", preventScroll, { passive: false });
      window.removeEventListener("touchmove", preventScroll, { passive: false });
    }

    function preventScroll(e) {
      e.preventDefault();
    }

    // 切到第二幕
    function goToSecondScene() {
        document.querySelector(".scene-1").classList.remove("active");
        document.querySelector(".scene-2").classList.add("active");
        if (isScrolling) return;
        const vh = window.innerHeight;
        isScrolling = true;
        lastScrollTime = Date.now();
        disableScroll();

        gsap.to(container, {
            scrollTo: { y: vh },
            duration: 2,
            ease: "power2.out",
            onStart: () => {
                gsap.to(".scene-1", { PointerEvent: 'none' });
                gsap.to(".scene-1 .sealevel-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .carbon-footprint-emissions-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .carbon-footprint-temperature-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .scroll-mouse", { opacity: 0, duration: 0.25 });
                gsap.to(".scene-2", { PointerEvent: 'intial' });
                gsap.to(".scene-2 .carbon-footprint-status-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2 .recommendations", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2 .scroll-mouse", { delay: 0.5, opacity: 1, duration: 1.5 });
            },
            onComplete: () => {
                isScrolling = false;
                enableScroll();
            },
        });
    }

    // 切回第一幕
    function goToFirstScene() {
        document.querySelector(".scene-2").classList.remove("active");
        document.querySelector(".scene-1").classList.add("active");
        const vh = window.innerHeight;
        isScrolling = true;
        lastScrollTime = Date.now();
        disableScroll();

        gsap.to(container, {
            scrollTo: { y: 0 },
            duration: 2,
            ease: "power2.out",
            onStart: () => {
                gsap.to(".scene-1", { PointerEvent: 'intial' });
                gsap.to(".scene-1 .sealevel-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .carbon-footprint-emissions-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .carbon-footprint-temperature-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .scroll-mouse", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2", { PointerEvent: 'none' });
                gsap.to(".scene-2 .carbon-footprint-status-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-2 .recommendations", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-2 .scroll-mouse", { opacity: 0, duration: 0.5 });
            },
            onComplete: () => {
                isScrolling = false;
                enableScroll();
            },
        });
    }

  const wheelHandler = (e) => {
      const statusContainer = document.querySelector(".carbon-footprint-status-container");
      const recommendations = document.querySelector(".recommendations");

      // 如果滾動事件發生在指定容器內 → 不觸發場景切換
      if (
          (statusContainer && statusContainer.contains(e.target)) ||
          (recommendations && recommendations.contains(e.target))
      ) {
          return; // 直接跳出，不做場景切換
      }

      const now = Date.now();
      if (now - lastScrollTime < cooldownTime || isScrolling) {
          e.preventDefault();
          return;
      }

      const deltaY = e.deltaY;
      const scrollTop = container.scrollTop;
      const vh = window.innerHeight;

      if (deltaY > 0 && scrollTop < vh / 2) {
          e.preventDefault();
          goToSecondScene();
      }

      else if (deltaY < 0 && scrollTop > vh / 1.5 && scrollTop < vh * 1.5) {
          e.preventDefault();
          goToFirstScene();
      }
  };
    
    container.addEventListener("wheel", wheelHandler, { passive: false });
    currentScrollListener = wheelHandler;

    const scrollMouse1 = document.querySelector(".scene-1 .scroll-mouse");
    const scrollMouse2 = document.querySelector(".scene-2 .scroll-mouse");
    
    if (scrollMouse1) {
        scrollMouse1.addEventListener("click", goToSecondScene);
        currentMouseListeners.push({ element: scrollMouse1, listener: goToSecondScene });
    }
    
    if (scrollMouse2) {
        scrollMouse2.addEventListener("click", goToFirstScene);
        currentMouseListeners.push({ element: scrollMouse2, listener: goToFirstScene });
    }

    window.goToSecondScene = goToSecondScene;
    window.goToFirstScene = goToFirstScene;
}

function retryCalculation() {
    const loadingScreen = document.querySelector('.loading-screen');
    loadingScreen.classList.remove('hidden');
    
    calculateCarbonFootprintDetailed().then(success => {
        if (success) {
            updateDisplay();
        } else {
            showError('重新計算失敗，請檢查網路連接或稍後再試');
        }
    }).finally(() => {
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
        }, 1000);
    });
}

function exportCarbonData() {
    const exportData = {
        timestamp: new Date().toISOString(),
        userId: getUserId(),
        totalEmissions: totalEmissions,
        categories: carbonData,
        detailedData: carbonDetailedData,
        details: Object.entries(carbonData)
            .filter(([key, value]) => value > 0)
            .map(([key, value]) => ({
                category: pageNames[key],
                emissions: value,
                percentage: ((value / totalEmissions) * 100).toFixed(1)
            }))
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `carbon-footprint-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

window.retryCalculation = retryCalculation;
window.exportCarbonData = exportCarbonData;
    </script>
</body>
</html>