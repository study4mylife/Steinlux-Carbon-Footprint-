<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>星際碳險 - 碳足跡分析</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
    
    <style>
      @font-face {
        font-family: "GenSenRounded2TW-R";
        src: url("../font/GenSenRounded2TW-R.otf") format("opentype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      @media (min-width: 1200px) {
        html { font-size: 18px; }
      }

      @media (max-width: 480px) {
        html { font-size: 14px; }
      }

      html {
        font-family: "GenSenRounded2TW-R", sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      }

      p {
        margin: 0.5rem 0;
      }

      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 1;
        transition: opacity 0.5s ease;
      }

      .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* 桌面版本的滾動容器設置 */
      .scroll-container {
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        scroll-snap-type: y mandatory;
        scroll-behavior: smooth;
        z-index: 999;
        width: 100vw;
        overflow: hidden;
      }

      .scene {
        position: relative;
        height: 100vh;
        scroll-snap-align: start;
        z-index: 999;
      }

      .scene.active {
        pointer-events: auto; /* 只有 active 的場景可以點 */
      }
      
      @media (max-width: 1024px) {
        body {
          height: auto; /* 允許body高度自適應 */
        }
        
        .scroll-container {
          position: static !important; /* 改為靜態定位 */
          overflow-y: visible !important; /* 允許正常滾動 */
          scroll-snap-type: none !important; /* 取消滾動吸附 */
          scroll-behavior: auto !important; /* 恢復正常滾動行為 */
          overflow-x: hidden !important;
        }

        .scene {
          position: static !important; /* 改為靜態定位 */
          scroll-snap-align: none !important; /* 取消滾動吸附對齊 */
          height: auto !important; /* 高度自適應內容 */
          min-height: 100vh; /* 最小高度保持一個視窗高度 */
          overflow-x: hidden;
        }
        
        /* 確保第二個場景在手機上也顯示 */
        .scene-2 {
          height: auto !important;
          min-height: 100vh;
          pointer-events: initial !important;
        }
      }

      .scene-1 {
        background: url("images/0813修01.jpg") no-repeat 0 0;
        background-size: 100% 200%;
        pointer-events: initial;
      }

      .scene-2 {
        background: url("images/0813修01.jpg") no-repeat 0 -100vh;
        background-size: 100% 200%;
        pointer-events: none;
      }

      @media (max-width: 1024px) {
        .scene-1, .scene-2 {
          background: none
        }

        .scroll-container {
          background: url("images/0813修03.jpg") no-repeat 0 0;
          background-size: 100% 200%;
        }

        
      }

      /* 第一幕样式 */
      .scene-1 .sealevel-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        min-width: max-content;
        height: 50vh;
        font-size: 1.5rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 5%;
        left: 5.75%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 100;
      }

      .scene-1 .sealevel-container p {
        margin-bottom: 1rem;
      }

      .scene-1 .sealevel-container iframe {
        border-radius: 1.25rem;
      }

      .scene-1 .map-buttons {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
      }

      .scene-1 .map-buttons button {
        background: rgba(255,255,255,0.5);
        border: none;
        padding: 0.25rem;
        border: 0.25pt solid #fff;
        color: #6D808F;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.5rem;
        text-shadow: #7F7F7F60;
      }

      .scene-1 .map-buttons button.active-btn {
        border: 0.25pt solid #AD967C;
        color: #AD967C;
      }

      .scene-1 .carbon-footprint-emissions-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 450px;
        font-size: 1.5rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 5%;
        right: 3.25%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      .scene-1 #carbon-footprint-emissions-value {
        font-size: 1.75rem;
        color: #6D808F;
      }

      .scene-1 .emissions-unit {
        font-size: 0.8rem;
        letter-spacing: 4px;
      }

      .scene-1 .carbon-footprint-emissions-neutrality {
        width: 65%;
        font-size: 0.8rem;
        text-align: justify;
        letter-spacing: 4px;
        line-height: 2;
      }

      .scene-1 .carbon-footprint-temperature-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 450px;
        font-size: 1.5rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 38%;
        right: 5%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      .scene-1 .temperature-text {
        text-align: right;
      }

      .scene-1 #carbon-footprint-temperature-value {
        color: #C00000;
      }

      .scene-1 .polarbear-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 300px;
        font-size: 0.75rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 57.5%;
        right: 5%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      /* 第二幕详细数据样式 */
      .scene-2 .carbon-footprint-status-container {
        position: fixed;
        top: 50%;
        left: 25%;
        transform: translate(-50%, -50%);
        width: 40vw;
        max-width: 1200px;
        height: 85vh;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 20px;
        border: 0.25px solid rgba(255, 255, 255);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 1rem 2rem;
        box-sizing: border-box;
        opacity: 0;
        overflow-y: auto;
      }

      .analysis-title {
        text-align: center;
        font-size: 1.25rem;
        font-weight: normal;
        color: #f5f5f5;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        letter-spacing: 0.75rem;
        border-bottom: 1.5pt solid #ffffff60;
      }

      .total-emissions {
        text-align: center;
        margin-bottom: 3rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .total-value {
        font-size: 3rem;
        color: #ff6b6b;
        font-weight: bold;
        display: block;
      }

      .total-unit {
        font-size: 1rem;
        color: #cccccc;
        margin-top: 0.5rem;
      }

      .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .category-card {
        border-radius: 8px;
      }

      .category-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 2pt 2pt 2.5pt #C3CADB24;
      }

      .category-title {
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-align: center;
        letter-spacing: 2px;
      }

      .category-value {
        font-size: 0.9rem;
        text-align: center;
      }

      .category-unit {
        font-size: 0.9rem;
        color: #cccccc;
        text-align: center;
      }

      .category-percentage {
        font-size: 0.8rem;
        color: #ffb347;
        text-align: center;
        margin-top: 0.5rem;
      }

      .breakdown-item {
        display:flex;
        justify-content:space-between;
        padding: 0.5rem 1rem;
      }

      .item-emission {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .recommendations {
        position: fixed;
        top: 50%;
        right: -15%;
        transform: translate(-50%, -50%);
        width: 40vw;
        max-width: 1200px;
        height: 85vh;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 20px;
        border: 0.25px solid rgba(255, 255, 255);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 1rem;
        opacity: 0;
        box-sizing: border-box;
        overflow-y: auto;
      }

      .recommendation-page {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-top: 1rem;
      }

      .toggle-switch {
        display: flex;
        justify-content: center;
        margin-bottom: 0.5rem;
      }

      .toggle-switch button {
        background: rgba(255,255,255,0.6);
        border: none;
        padding: 0.4rem 0.8rem;
        margin: 0 0.25rem;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-switch button.active {
        background: rgba(255,255,255,0.95);
        font-weight: bold;
      }

      .recommendations strong {
        text-decoration: dotted;
        color: #ffffff;
        margin-bottom: 1rem;
        text-align: center;
        font-size: 1rem;
      }

      .recommendations ul {
        font-size: 0.55rem;
        line-height: 1.8;
      }

      .recommendations li {
        margin-bottom: 0.5rem;
      }
      
      .emissions-legend-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        list-style:none;
        text-align: center;
        padding:0; 
        margin:0;
      }

      .chart-container {
        display:flex;
        justify-content: space-evenly;
        align-items: center;
        width: 100%;
      }

      #emissions-chart {
        max-width: 50%;
        max-height: 300px;
      }

      /* legend 列表 */
      #emissions-legend {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      /* 每一列 */
      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
      }

      /* 顏色小圓點 */
      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
      }

      /* 滑鼠提示样式 */
      .scene-1 .scroll-mouse {
        position: absolute;
        bottom: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        width: 18px;
        height: 26px;
        opacity: 1;
        cursor: pointer;
      }

      .scene-2 .scroll-mouse {
        position: absolute;
        top: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        width: 18px;
        height: 26px;
        opacity: 0;
        cursor: pointer;
      }

      /* 在手機版本隱藏滑鼠提示 */
      @media (max-width: 1024px) {
        .scroll-mouse {
          display: none !important;
        }
      }

      .border-anim {
        stroke-dasharray: 90;
        stroke-dashoffset: 90;
        cursor: pointer;
        transition: stroke-dashoffset 1s linear;
      }
      
      .mouse-line {
        position: absolute;
        width: 0.05rem;
        height: 0.4rem;
        background-color: #fff;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: translateY 0.3s linear;
        animation: none;
      }

      .scroll-mouse:not(:hover) .border-anim {
        stroke-dashoffset: 90;
      }

      .scroll-mouse:hover .border-anim {
        stroke-dashoffset: 0;
      }


      .error-message {
        color: #ff6b6b;
        text-align: center;
        font-size: 1.2rem;
        padding: 2rem;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(255, 107, 107, 0.3);
        margin: 1rem 0;
      }

      /* 手機版本的響應式調整 */
      @media (max-width: 1024px) {
        .scene-1, .scene-2 {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
        }

        .scene-1 .sealevel-container,
        .scene-1 .carbon-footprint-emissions-container,
        .scene-1 .carbon-footprint-temperature-container,
        .scene-1 .polarbear-container {
          position: static !important;
          width: 90%;
          max-width: 450px;
          margin: 1rem 0;
          text-align: center;
          translate: none;
        }

        .scene-2 {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .scene-2 .carbon-footprint-status-container {
          position: static !important;
          width: 90vw;
          height: auto;
          max-height: none;
          margin-bottom: 2rem;
          transform: none;
          opacity: 1 !important;
        }

        .scene-2 .recommendations {
          position: static !important;
          width: 90vw;
          height: auto;
          max-height: none;
          margin-bottom: 2rem;
          transform: none;
          opacity: 1 !important;
        }

        .categories-grid {
          grid-template-columns: 1fr;
        }

        .analysis-title {
          font-size: 1.5rem;
        }

        .total-value {
          font-size: 2rem;
        }

        .chart-container {
          flex-direction: column;
        }

        #emissions-chart {
          max-width: 50%;
          max-height: 300px;
          margin-bottom: 1.5rem;
        }


        #emissions-legend {
          flex-direction: row
        }

        .legend-item {
          display: flex;
          justify-content: center;
          align-items: center;
          width: 30%;
        }
      }
    </style>
</head>
<body>
    <!-- 加载屏幕 -->
    <div class="loading-screen">
        <div class="spinner"></div>
    </div>

    <div class="scroll-container">
        <section class="scene scene-1">
            <div class="sealevel-container">
                <p>2100年，預計海平面<br>將上升......</p>
                <div style="display:flex; gap:1rem; align-items:flex-start;">
                  <!-- iframe 區塊 -->
                  <iframe id="mapFrame" 
                          src="https://coastal.climatecentral.org/embed/map/13/121.5354/25.082/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C" 
                          width="80%" height="200" 
                          style="border-radius:1rem; border:none;"
                          allow="fullscreen"
                          title="Climate Central Map">
                  </iframe>

                  <!-- 按鈕區塊 -->
                  <div class="map-buttons">
                    <button onclick="switchMap('taipei', this)" class="active-btn">雙北地區</button>
                    <button onclick="switchMap('yilan', this)">蘭陽平原</button>
                    <button onclick="switchMap('hsinchu', this)">竹苗地區</button>
                    <button onclick="switchMap('taichung', this)">中彰地區</button>
                    <button onclick="switchMap('chiayi', this)">雲嘉南區</button>
                    <button onclick="switchMap('kaohsiung', this)">高屏地區</button>
                  </div>
                </div>
            </div>

            <div class="carbon-footprint-emissions-container">
                <p class="emissions-text">您過去一年的碳足跡排放是</p>
                <p>
                    <span id="carbon-footprint-emissions-value">計算中...</span>
                    <span>公噸<span class="emissions-unit">二氧化碳當量(tCO2e)</span></span>
                </p>
                <p class="carbon-footprint-emissions-neutrality" id="neutrality-text">計算中...</p>
            </div>

            <div class="carbon-footprint-temperature-container">
                <p class="temperature-text">地球持續升溫</p>
                <p class="temperature-text">本世紀末將達
                    <span id="carbon-footprint-temperature-value">3.7℃</span>
                </p>
            </div>

            <div class="polarbear-container">
                <img src="./images/bg-fashion.webp" alt="北極熊">
                <p class="polarbear-text">這將導致我們可愛的北極熊不再有冷氣吹...</p>
            </div>
            
            <div class="scroll-mouse">
                <svg class="mouse-svg" viewBox="0 0 18 26" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="16" height="24" rx="8" stroke="#cccccc" stroke-width="1" fill="none" />
                    <rect class="border-anim" x="1" y="1" width="16" height="24" rx="8" stroke="#ffffff" stroke-width="1" fill="none" />
                </svg>
                <div class="mouse-line"></div>
            </div>
        </section>

        <section class="scene scene-2">
            <div class="carbon-footprint-status-container">
                <h2 class="analysis-title">您生活碳足跡計算的詳細數據</h2>

                <div class="categories-grid" id="categories-container">
                </div>
            </div>

            <div class="recommendations">
              <div class="toggle-switch">
                <button id="summary-btn" class="active">結語</button>
                <button id="advice-btn">改善建議</button>
              </div>

              <!-- 第一頁：結語與圓餅圖 -->
              <div id="summary-page" class="recommendation-page">
                <!-- 圓餅圖區 -->
                <div class="chart-container">
                  <canvas id="emissions-chart"></canvas>
                  <!-- 右側 legend -->
                  <div >
                    <ul class="emissions-legend-container" id="emissions-legend"></ul>
                  </div>
                </div>
              </div>

              <!-- 第二頁：改善建議 -->
              <div id="advice-page" class="recommendation-page" style="display:none;">
                <ul id="recommendations-list">
                  <li>計算分析中...</li>
                </ul>
              </div>
            </div>

            <div class="scroll-mouse">
                <svg class="mouse-svg" viewBox="0 0 18 26" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="16" height="24" rx="8" stroke="#cccccc" stroke-width="1" fill="none" />
                    <rect class="border-anim" x="1" y="1" width="16" height="24" rx="8" stroke="#ffffff" stroke-width="1" fill="none" />
                </svg>
                <div class="mouse-line"></div>
            </div>
        </section>
    </div>

    <script>
// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyBm2oNcPhQ5nbQbLrvQUnlQ31LoxX3JThM",
  authDomain: "steinlux-calculator.firebaseapp.com",
  projectId: "steinlux-calculator",
  storageBucket: "steinlux-calculator.firebasestorage.app",
  messagingSenderId: "180210584345",
  appId: "1:180210584345:web:759888650c808df8159388",
  measurementId: "G-VX9JK5P5DF"
};

// 初始化 Firebase
firebase.initializeApp(firebaseConfig);
const functions = firebase.functions();

// 碳足跡数据 - 詳細版本
let carbonDetailedData = {
    'traffic-daily': { total: 0, breakdown: {} },
    'home': { total: 0, breakdown: {} },
    'traffic-travel': { total: 0, breakdown: {} },
    'food': { total: 0, breakdown: {} },
    'fashion': { total: 0, breakdown: {} },
    'entertainment': { total: 0, breakdown: {} }
};

// 碳足跡数据 - 簡化版本（保持相容性）
let carbonData = {
    'traffic-daily': 0,
    'home': 0,
    'traffic-travel': 0,
    'food': 0,
    'fashion': 0,
    'entertainment': 0
};

let totalEmissions = 0;

// 页面映射
const pageNames = {
    'traffic-daily': '日常通勤',
    'home': '居住生活',
    'traffic-travel': '旅遊交通',
    'food': '日常飲食',
    'fashion': '時尚穿搭',
    'entertainment': '生活娛樂'
};

const urls = {
  taipei: "https://coastal.climatecentral.org/embed/map/13/121.5354/25.082/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  yilan: "https://coastal.climatecentral.org/embed/map/12/121.8527/24.735/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  hsinchu: "https://coastal.climatecentral.org/embed/map/12/120.9782/24.7644/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  taichung: "https://coastal.climatecentral.org/embed/map/13/120.5391/24.1589/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  chiayi: "https://coastal.climatecentral.org/embed/map/11/120.2957/23.4169/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  kaohsiung: "https://coastal.climatecentral.org/embed/map/11/120.6035/22.6896/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C"
};

function switchMap(region, btn) {
  // 換 iframe 的 src
  document.getElementById("mapFrame").src = urls[region];

  // 移除所有按鈕的 active 樣式
  document.querySelectorAll(".map-buttons button").forEach(b => {
    b.classList.remove("active-btn");
  });

  // 幫目前點擊的按鈕加上 active 樣式
  if (btn) {
    btn.classList.add("active-btn");
  }
}

// 检测是否为移动设备
function isMobile() {
    return window.innerWidth <= 1024 || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// 当前模式状态
let currentMode = null;
let sceneTransitionsSetup = false;

// 获取用户ID
function getUserId() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    
    if (userId) {
        return userId;
    }
    
    const storedUserId = localStorage.getItem('userId');
    if (storedUserId) {
        return storedUserId;
    }
    
    return 'test-user';
}

// 调用 Firebase Function 计算碳足跡
async function calculateCarbonFootprintDetailed() {
    const userId = getUserId();
    const pages = Object.keys(carbonDetailedData);
    const calculateCarbonPage = functions.httpsCallable('calculateCarbonPage');

    try {
        const promises = pages.map(pageName => 
            calculateCarbonPage({ userId, pageName })
        );

        const results = await Promise.all(promises);
        
        // 更新詳細數據
        results.forEach(result => {
            if (result.data) {
                const pageName = result.data.pageName;
                carbonDetailedData[pageName] = {
                    total: result.data.total || 0,
                    breakdown: result.data.breakdown || {}
                };
                // 保持原有的 carbonData 格式
                carbonData[pageName] = result.data.total || 0;
            }
        });

        // 計算總排放量
        totalEmissions = Object.values(carbonData).reduce((sum, value) => sum + value, 0)/1000;
        
        return true;
    } catch (error) {
        console.error('計算碳足跡時發生錯誤:', error);
        showError('計算碳足跡時發生錯誤，請稍後再試');
        return false;
    }
}

// 显示错误信息
function showError(message) {
    const container = document.getElementById('categories-container');
    container.innerHTML = `<div class="error-message">${message}</div>`;
}

const categoryInfo = {
    'traffic-daily': { color: '#6D808F', bgcolor: '#6D808F35', name: '日常通勤' },
    'home': { color: '#A88E71', bgcolor: '#A88E7135', name: '居住生活' },
    'traffic-travel': { color: '#C18181', bgcolor: '#C1818135', name: '旅遊交通' },
    'food': { color: '#A3B18D', bgcolor: '#A3B18D35', name: '日常飲食' },
    'fashion': { color: '#B6A0B1', bgcolor: '#B6A0B135', name: '時尚穿搭' },
    'entertainment': { color: '#AAC5D2', bgcolor: '#AAC5D235', name: '生活娛樂' }
};

function createCategoryCards() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';

    const order = ['traffic-daily', 'home', 'traffic-travel', 'food', 'fashion', 'entertainment'];

    const filteredEntries = Object.entries(carbonDetailedData)
        .filter(([pageKey, data]) => data.total > 0);

    if (filteredEntries.length === 0) {
        const noDataCard = document.createElement('div');
        noDataCard.className = 'category-card no-data';
        noDataCard.innerHTML = `
            <div class="category-header" style="background-color:#f0f0f0; font-weight:bold; color:#888; border-left: 8px solid #888;">
                <h3 class="category-title">暫無數據</h3>
                <div class="category-value" style="color:#888;">0.000</div>
            </div>
            <div class="category-description" style="padding:0.5rem 1rem;">請完成碳足跡問卷以查看詳細數據</div>
        `;
        container.appendChild(noDataCard);
        return;
    }

    const orderedEntries = filteredEntries.sort(
        ([a], [b]) => order.indexOf(a) - order.indexOf(b)
    );

    orderedEntries.forEach(([pageKey, data]) => {
        const info = categoryInfo[pageKey];

        const sortedBreakdown = Object.entries(data.breakdown)
            .filter(([itemName, itemData]) => itemData.emission > 0)
            .sort((a, b) => b[1].emission - a[1].emission);

        const card = document.createElement('div');
        card.className = 'category-card detailed';

        const itemsHTML = sortedBreakdown.length > 0 ?
            sortedBreakdown.map(([itemName, itemData]) => {
                return `
                    <div class="breakdown-item">
                        <div class="item-info">
                            <div class="item-name" style="font-weight:bold; color:${info.color};">${itemName}</div>
                            <div class="item-details" style="font-size:0.85em; color:#666;">
                                ${itemData.input} ${itemData.unit || ''}
                            </div>
                        </div>
                        <div class="item-emission" style="color:${info.color};">
                            ${itemData.emission.toFixed(3)}
                        </div>
                    </div>
                `;
            }).join('')
            : '<div class="no-items" style="padding:0.5rem 1rem; color:#999;">暫無詳細項目</div>';

        card.innerHTML = `
            <div class="category-header" style="background-color:${info.bgcolor}; font-weight:bold; color:${info.color}; border-left: 8px solid ${info.color};">
                <h3 class="category-title" style="margin:0;">${info.name}</h3>
                <div class="category-value" style="color:${info.color};">${data.total.toFixed(3)}</div>
            </div>
            <div class="category-breakdown">
                ${itemsHTML}
            </div>
        `;

        container.appendChild(card);
    });
}

// 更新显示数据
function updateDisplay() {
    // 更新第一幕的总排放量
    const emissionsValueElement = document.getElementById('carbon-footprint-emissions-value');
    if (totalEmissions > 0) {
        emissionsValueElement.textContent = totalEmissions.toFixed(3);
        
        // 更新中和说明
        const forestArea = Math.round(totalEmissions * 1388.889);
        const stadiums = (forestArea / 12950).toFixed(1);
        const neutralityText = document.getElementById('neutrality-text');
        neutralityText.textContent = `為了中和您的排放，必須復育大約 ${forestArea.toLocaleString()}m²的自然再生林地。這大約與${stadiums}座台北大巨蛋相同！`;
        
    } else {
        emissionsValueElement.textContent = '暫無數據';
        const neutralityText = document.getElementById('neutrality-text');
        neutralityText.textContent = '請完成碳足跡問卷，我們將為您計算需要復育的森林面積。';
        
    }

    // 创建分类卡片
    createCategoryCards();

    // 生成减碳建议
    generateRecommendations();

    // 初始化圓餅圖
    renderEmissionsChart();
}

// 初始化 Chart.js 圓餅圖
let emissionsChart = null;

function renderEmissionsChart() {
  const ctx = document.getElementById('emissions-chart').getContext('2d');
  const dataValues = [];
  const dataLabels = [];
  const dataColors = [];

  Object.entries(carbonData).forEach(([key, value]) => {
    if (value > 0) {
      dataValues.push(value);
      dataLabels.push(categoryInfo[key].name);
      dataColors.push(categoryInfo[key].color);
    }
  });

  // 如果已存在圖表就先銷毀
  if (emissionsChart) emissionsChart.destroy();

  // 初始化圓餅圖
  emissionsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: dataLabels,
      datasets: [{
        data: dataValues,
        backgroundColor: dataColors,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false // 內建 legend 關閉
        }
      }
    }
  });

// 生成右側自訂 legend
const legendContainer = document.getElementById('emissions-legend');
legendContainer.innerHTML = ''; // 清空舊的 legend
const total = dataValues.reduce((a, b) => a + b, 0);

dataLabels.forEach((label, index) => {
  const li = document.createElement('li');
  li.classList.add('legend-item');
  li.style.color = dataColors[index]; // 顏色依然用 inline，因為每個顏色不同

  const colorBox = document.createElement('span');
  colorBox.classList.add('legend-color');
  colorBox.style.backgroundColor = dataColors[index];

  const percent = ((dataValues[index] / total) * 100).toFixed(1);

  li.appendChild(colorBox);
  li.appendChild(document.createTextNode(`${label}: ${percent}%`));

  legendContainer.appendChild(li);
});
}


// Toggle 切換
document.getElementById('summary-btn').addEventListener('click', () => {
  document.getElementById('summary-page').style.display = 'flex';
  document.getElementById('advice-page').style.display = 'none';
  document.getElementById('summary-btn').classList.add('active');
  document.getElementById('advice-btn').classList.remove('active');
  renderEmissionsChart();
});

document.getElementById('advice-btn').addEventListener('click', () => {
  document.getElementById('summary-page').style.display = 'none';
  document.getElementById('advice-page').style.display = 'flex';
  document.getElementById('summary-btn').classList.remove('active');
  document.getElementById('advice-btn').classList.add('active');
});

function generateRecommendations() {
  const recommendations = [];

  // 取得有數值的項目，並排序取前三大
  const activeCategories = Object.entries(carbonData)
    .filter(([key, value]) => value > 0)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3); // 只取前三大

  const list = document.getElementById('recommendations-list');
  list.innerHTML = ''; // 清空原本內容

  if (activeCategories.length === 0) {
    recommendations.push({
      pageKey: 'none',
      title: '尚未完成問卷',
      content: '請先完成碳足跡問卷，我們將根據您的數據提供個人化減碳建議'
    });
  } else {
    // 針對前三大類別提供詳細建議
    activeCategories.forEach(([pageKey, value]) => {
      switch(pageKey) {
        case 'traffic-daily':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: '你的日常通勤碳排放較高，可能是因為機車或汽車使用頻率較高。可以考慮改變部分通勤方式。<br>例如：<br>• 短程改為步行或騎腳踏車，減少燃油車使用次數<br>• 若有條件，可改用電動車或共乘方式，減少個人排放<br>• 調整駕駛習慣，如保持胎壓、減少怠速，以提升燃油效率'
          });
          break;
        case 'traffic-travel':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: '你的旅遊交通碳足跡較高，可能是來自飛機旅行。長途飛行是個人碳排放的主要來源之一。<br>你可以考慮：<br>• 減少不必要的短途飛行，改搭高鐵或火車<br>• 若需飛行，選擇直飛航班，減少中轉產生的額外排放<br>• 支持碳補償計畫，如選擇航空公司的碳中和選項'
          });
          break;
        case 'home':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: '你的住家碳排放較高，可能與家電使用、冷氣或熱水器有關。你可以嘗試：<br>• 更換高效節能電器，如 LED 燈、變頻冷氣<br>• 減少不必要的電器待機電力，使用插座開關隨手關閉<br>• 提升房屋隔熱效果，減少冷氣或暖氣的使用需求'
          });
          break;
        case 'food':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: '你的飲食碳排放較高，可能與肉類攝取頻繁或食物浪費有關。建議：<br>• 減少紅肉和加工肉類攝取，增加植物性飲食<br>• 選擇當季在地食材，減少食物運輸碳排放<br>• 減少食物浪費，注意保存和計畫購買'
          });
          break;
        case 'fashion':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: '你的時尚穿搭碳排放較高，可能與快時尚消費習慣有關。建議：<br>• 選擇耐用的衣物，減少購買快時尚<br>• 考慮二手或租借服飾<br>• 支持永續品牌與環保材料的衣物'
          });
          break;
        case 'entertainment':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: '你的娛樂活動碳排放較高，可能與高耗能娛樂設備或頻繁活動有關。建議：<br>• 選擇低碳娛樂方式，如戶外運動、閱讀<br>• 減少高耗能電子設備使用時間<br>• 參與社區活動或公共資源娛樂'
          });
          break;
      }
    });
  }

  // 顯示建議
  list.innerHTML = recommendations.map(rec => {
    if (rec.pageKey === 'none') {
      return `
        <li>
          <div style="font-weight:bold; color:#555;">${rec.title}</div>
          <div style="margin-left:0.5rem; color:#666;">${rec.content}</div>
        </li>
      `;
    } else {
      const info = categoryInfo[rec.pageKey];
      return `
        <li style="margin-bottom:1rem;">
          <div style="font-weight:bold; color:${info.color}; padding-left:0.5rem;">
            ${rec.title}
          </div>
          <div style="margin-left:0.75rem; margin-top:0.25rem; color:#333;">
            ${rec.content}
          </div>
        </li>
      `;
    }
  }).join('');
}

// 重置為桌面模式
function resetToDesktopMode() {
    const container = document.querySelector(".scroll-container");
    const body = document.body;
    
    // 重置滾動位置到頂部
    if (container) {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // 重置所有元素的透明度
    setTimeout(() => {
        // 第一幕元素顯示
        gsap.set(".scene-1 .sealevel-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-emissions-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-temperature-container", { opacity: 1 });
        gsap.set(".scene-1 .polarbear-container", { opacity: 1 });
        
        // 第二幕元素隱藏
        gsap.set(".scene-2 .carbon-footprint-status-container", { opacity: 0 });
        gsap.set(".scene-2 .recommendations", { opacity: 0 });
    }, 100);
    
    // 清除可能的樣式覆蓋
    body.style.overflow = "";
    if (container) {
        container.style.overflow = "";
    }
}

// 重置為移動模式
function resetToMobileMode() {
    const container = document.querySelector(".scroll-container");
    
    // 重置滾動位置到頂部
    if (container) {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // 確保所有元素在移動版本都顯示
    setTimeout(() => {
        gsap.set(".scene-1 .sealevel-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-emissions-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-temperature-container", { opacity: 1 });
        gsap.set(".scene-1 .polarbear-container", { opacity: 1 });
        gsap.set(".scene-2 .carbon-footprint-status-container", { opacity: 1 });
        gsap.set(".scene-2 .recommendations", { opacity: 1 });
    }, 100);
}

// 處理模式切換
function handleModeChange() {
    const mobile = isMobile();
    
    if (currentMode === mobile) {
        return; // 模式沒有改變，不需要處理
    }
    
    console.log(`模式切換: ${currentMode === null ? '初始化' : (currentMode ? '移動' : '桌面')} -> ${mobile ? '移動' : '桌面'}`);
    
    currentMode = mobile;
    
    if (mobile) {
        // 切換到移動模式
        resetToMobileMode();
        // 移除可能存在的事件監聽器
        removeDesktopEventListeners();
        sceneTransitionsSetup = false;
    } else {
        // 切換到桌面模式
        resetToDesktopMode();
        // 設置桌面版場景切換
        if (!sceneTransitionsSetup) {
            setTimeout(() => {
                setupSceneTransitions();
                sceneTransitionsSetup = true;
            }, 200);
        }
    }
}

// 移除桌面版事件監聽器
let currentScrollListener = null;
let currentMouseListeners = [];

function removeDesktopEventListeners() {
    const container = document.querySelector(".scroll-container");
    
    // 移除滾輪事件監聽器
    if (container && currentScrollListener) {
        container.removeEventListener('wheel', currentScrollListener);
        currentScrollListener = null;
    }
    
    // 移除滑鼠點擊事件
    currentMouseListeners.forEach(({ element, listener }) => {
        if (element && listener) {
            element.removeEventListener('click', listener);
        }
    });
    currentMouseListeners = [];
}
// 页面加载完成后的初始化
document.addEventListener("DOMContentLoaded", async () => {
    const loadingScreen = document.querySelector('.loading-screen');
    
    try {
        // 使用新的詳細計算函數
        const success = await calculateCarbonFootprintDetailed();
        
        if (success) {
            updateDisplay();
            console.log('碳足跡計算完成:', carbonDetailedData);
            console.log('總排放量:', totalEmissions);
        } else {
            document.getElementById('carbon-footprint-emissions-value').textContent = '計算失敗';
        }
    } catch (error) {
        console.error('初始化錯誤:', error);
        showError('系統初始化失敗，請重新整理頁面');
    } finally {
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
        }, 1000);
    }

    // 初始化模式檢測
    handleModeChange();
    
    // 監聽視窗大小改變
    let resizeTimeout;
    window.addEventListener('resize', () => {
        // 防抖處理，避免頻繁觸發
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            handleModeChange();
        }, 250);
    });
    
    // 監聽方向改變（移動設備）
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            handleModeChange();
        }, 500); // 給一點時間讓瀏覽器完成方向改變
    });
});

// 场景切换设置 - 僅限桌面版
function setupSceneTransitions() {
    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting && entry.target.classList.contains('scene-2')) {
                    setTimeout(() => {
                        // 第二幕进入动画
                    }, 1000);
                }
            });
        },
        { threshold: 0.6 }
    );

    observer.observe(document.querySelector(".scene-2"));

    const container = document.querySelector(".scroll-container");
    let isScrolling = false;
    const cooldownTime = 3000;
    let lastScrollTime = 0;

    function disableScroll() {
        document.body.style.overflow = "hidden";
        container.style.overflow = "hidden";
    }

    function enableScroll() {
        document.body.style.overflow = "";
        container.style.overflow = "";
    }

    // 切到第二幕
    function goToSecondScene() {
        document.querySelector(".scene-1").classList.remove("active");
        document.querySelector(".scene-2").classList.add("active");
        if (isScrolling) return;
        const vh = window.innerHeight;
        isScrolling = true;
        lastScrollTime = Date.now();
        disableScroll();

        gsap.to(container, {
            scrollTo: { y: vh },
            duration: 2,
            ease: "power2.out",
            onStart: () => {
                gsap.to(".scene-1", { PointerEvent: 'none' });
                gsap.to(".scene-1 .sealevel-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .carbon-footprint-emissions-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .carbon-footprint-temperature-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .polarbear-container", { opacity: 0, duration: 0.25 });
                gsap.to(".scene-1 .scroll-mouse", { opacity: 0, duration: 0.25 });
                gsap.to(".scene-2", { PointerEvent: 'intial' });
                gsap.to(".scene-2 .carbon-footprint-status-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2 .recommendations", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2 .scroll-mouse", { delay: 0.5, opacity: 1, duration: 1.5 });
            },
            onComplete: () => {
                isScrolling = false;
                enableScroll();
            },
        });
    }

    // 切回第一幕
    function goToFirstScene() {
        document.querySelector(".scene-2").classList.remove("active");
        document.querySelector(".scene-1").classList.add("active");
        const vh = window.innerHeight;
        isScrolling = true;
        lastScrollTime = Date.now();
        disableScroll();

        gsap.to(container, {
            scrollTo: { y: 0 },
            duration: 2,
            ease: "power2.out",
            onStart: () => {
                gsap.to(".scene-1", { PointerEvent: 'intial' });
                gsap.to(".scene-1 .sealevel-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .carbon-footprint-emissions-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .carbon-footprint-temperature-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .polarbear-container", { delay: 0.75, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .scroll-mouse", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2", { PointerEvent: 'none' });
                gsap.to(".scene-2 .carbon-footprint-status-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-2 .recommendations", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-2 .scroll-mouse", { opacity: 0, duration: 0.5 });
            },
            onComplete: () => {
                isScrolling = false;
                enableScroll();
            },
        });
    }

  // 滑鼠滚轮切换场景
  const wheelHandler = (e) => {
      const statusContainer = document.querySelector(".carbon-footprint-status-container");
      const recommendations = document.querySelector(".recommendations");

      // 🔒 如果滾動事件發生在指定容器內 → 不觸發場景切換
      if (
          (statusContainer && statusContainer.contains(e.target)) ||
          (recommendations && recommendations.contains(e.target))
      ) {
          return; // 直接跳出，不做場景切換
      }

      const now = Date.now();
      if (now - lastScrollTime < cooldownTime || isScrolling) {
          e.preventDefault();
          return;
      }

      const deltaY = e.deltaY;
      const scrollTop = container.scrollTop;
      const vh = window.innerHeight;

      // 往下滚进入第二幕
      if (deltaY > 0 && scrollTop < vh / 2) {
          e.preventDefault();
          goToSecondScene();
      }
      // 往上滚回到第一幕
      else if (deltaY < 0 && scrollTop > vh / 1.5 && scrollTop < vh * 1.5) {
          e.preventDefault();
          goToFirstScene();
      }
  };
    
    container.addEventListener("wheel", wheelHandler, { passive: false });
    currentScrollListener = wheelHandler;

    // 点击滑鼠图标切换场景
    const scrollMouse1 = document.querySelector(".scene-1 .scroll-mouse");
    const scrollMouse2 = document.querySelector(".scene-2 .scroll-mouse");
    
    if (scrollMouse1) {
        scrollMouse1.addEventListener("click", goToSecondScene);
        currentMouseListeners.push({ element: scrollMouse1, listener: goToSecondScene });
    }
    
    if (scrollMouse2) {
        scrollMouse2.addEventListener("click", goToFirstScene);
        currentMouseListeners.push({ element: scrollMouse2, listener: goToFirstScene });
    }

    // 暴露全局函数
    window.goToSecondScene = goToSecondScene;
    window.goToFirstScene = goToFirstScene;
}

// 错误处理和重试机制
function retryCalculation() {
    const loadingScreen = document.querySelector('.loading-screen');
    loadingScreen.classList.remove('hidden');
    
    calculateCarbonFootprintDetailed().then(success => {
        if (success) {
            updateDisplay();
        } else {
            showError('重新計算失敗，請檢查網路連接或稍後再試');
        }
    }).finally(() => {
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
        }, 1000);
    });
}

// 数据导出功能
function exportCarbonData() {
    const exportData = {
        timestamp: new Date().toISOString(),
        userId: getUserId(),
        totalEmissions: totalEmissions,
        categories: carbonData,
        detailedData: carbonDetailedData,
        details: Object.entries(carbonData)
            .filter(([key, value]) => value > 0)
            .map(([key, value]) => ({
                category: pageNames[key],
                emissions: value,
                percentage: ((value / totalEmissions) * 100).toFixed(1)
            }))
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `carbon-footprint-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// 暴露测试和工具函数到全局
window.retryCalculation = retryCalculation;
window.exportCarbonData = exportCarbonData;
    </script>
</body>
</html>