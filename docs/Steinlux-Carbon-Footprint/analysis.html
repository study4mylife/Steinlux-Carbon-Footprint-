<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ˜Ÿéš›ç¢³éšª - ç¢³è¶³è·¡åˆ†æ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
    
    <style>
      @font-face {
        font-family: "GenSenRounded2TW-R";
        src: url("../font/GenSenRounded2TW-R.otf") format("opentype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      @media (min-width: 1200px) {
        html { font-size: 18px; }
      }

      @media (max-width: 480px) {
        html { font-size: 14px; }
      }

      html {
        font-family: "GenSenRounded2TW-R", sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      }

      p {
        margin: 0.5rem 0;
      }

      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 1;
        transition: opacity 0.5s ease;
      }

      .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* æ¡Œé¢ç‰ˆæœ¬çš„æ»¾å‹•å®¹å™¨è¨­ç½® */
      .scroll-container {
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        scroll-snap-type: y mandatory;
        scroll-behavior: smooth;
        z-index: 999;
        width: 100vw;
        overflow: hidden;
      }

      .scene {
        position: relative;
        height: 100vh;
        scroll-snap-align: start;
        z-index: 999;
      }

      .scene.active {
        pointer-events: auto; /* åªæœ‰ active çš„å ´æ™¯å¯ä»¥é» */
      }
      
      @media (max-width: 1024px) {
        body {
          height: auto; /* å…è¨±bodyé«˜åº¦è‡ªé©æ‡‰ */
        }
        
        .scroll-container {
          position: static !important; /* æ”¹ç‚ºéœæ…‹å®šä½ */
          overflow-y: visible !important; /* å…è¨±æ­£å¸¸æ»¾å‹• */
          scroll-snap-type: none !important; /* å–æ¶ˆæ»¾å‹•å¸é™„ */
          scroll-behavior: auto !important; /* æ¢å¾©æ­£å¸¸æ»¾å‹•è¡Œç‚º */
          overflow-x: hidden !important;
        }

        .scene {
          position: static !important; /* æ”¹ç‚ºéœæ…‹å®šä½ */
          scroll-snap-align: none !important; /* å–æ¶ˆæ»¾å‹•å¸é™„å°é½Š */
          height: auto !important; /* é«˜åº¦è‡ªé©æ‡‰å…§å®¹ */
          min-height: 100vh; /* æœ€å°é«˜åº¦ä¿æŒä¸€å€‹è¦–çª—é«˜åº¦ */
          overflow-x: hidden;
        }
        
        /* ç¢ºä¿ç¬¬äºŒå€‹å ´æ™¯åœ¨æ‰‹æ©Ÿä¸Šä¹Ÿé¡¯ç¤º */
        .scene-2 {
          height: auto !important;
          min-height: 100vh;
          pointer-events: initial !important;
        }
      }

      .scene-1 {
        background: url("images/0813ä¿®01.jpg") no-repeat 0 0;
        background-size: 100% 200%;
        pointer-events: initial;
      }

      .scene-2 {
        background: url("images/0813ä¿®01.jpg") no-repeat 0 -100vh;
        background-size: 100% 200%;
        pointer-events: none;
      }

      @media (max-width: 1024px) {
        .scene-1, .scene-2 {
          background: none
        }

        .scroll-container {
          background: url("images/0813ä¿®03.jpg") no-repeat 0 0;
          background-size: 100% 200%;
        }

        
      }

      /* ç¬¬ä¸€å¹•æ ·å¼ */
      .scene-1 .sealevel-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        min-width: max-content;
        height: 50vh;
        font-size: 1.5rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 5%;
        left: 5.75%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 100;
      }

      .scene-1 .sealevel-container p {
        margin-bottom: 1rem;
      }

      .scene-1 .sealevel-container iframe {
        border-radius: 1.25rem;
      }

      .scene-1 .map-buttons {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
      }

      .scene-1 .map-buttons button {
        background: rgba(255,255,255,0.5);
        border: none;
        padding: 0.25rem;
        border: 0.25pt solid #fff;
        color: #6D808F;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.5rem;
        text-shadow: #7F7F7F60;
      }

      .scene-1 .map-buttons button.active-btn {
        border: 0.25pt solid #AD967C;
        color: #AD967C;
      }

      .scene-1 .carbon-footprint-emissions-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 450px;
        font-size: 1.5rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 5%;
        right: 3.25%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      .scene-1 #carbon-footprint-emissions-value {
        font-size: 1.75rem;
        color: #6D808F;
      }

      .scene-1 .emissions-unit {
        font-size: 0.8rem;
        letter-spacing: 4px;
      }

      .scene-1 .carbon-footprint-emissions-neutrality {
        width: 65%;
        font-size: 0.8rem;
        text-align: justify;
        letter-spacing: 4px;
        line-height: 2;
      }

      .scene-1 .carbon-footprint-temperature-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 450px;
        font-size: 1.5rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 38%;
        right: 5%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      .scene-1 .temperature-text {
        text-align: right;
      }

      .scene-1 #carbon-footprint-temperature-value {
        color: #C00000;
      }

      .scene-1 .polarbear-container {
        display: flex;
        flex-direction: column;
        position: fixed;
        width: 300px;
        font-size: 0.75rem;
        letter-spacing: 8px;
        color: #F5F5F5;
        top: 57.5%;
        right: 5%;
        translate: (-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      /* ç¬¬äºŒå¹•è¯¦ç»†æ•°æ®æ ·å¼ */
      .scene-2 .carbon-footprint-status-container {
        position: fixed;
        top: 50%;
        left: 25%;
        transform: translate(-50%, -50%);
        width: 40vw;
        max-width: 1200px;
        height: 85vh;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 20px;
        border: 0.25px solid rgba(255, 255, 255);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 1rem 2rem;
        box-sizing: border-box;
        opacity: 0;
        overflow-y: auto;
      }

      .analysis-title {
        text-align: center;
        font-size: 1.25rem;
        font-weight: normal;
        color: #f5f5f5;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        letter-spacing: 0.75rem;
        border-bottom: 1.5pt solid #ffffff60;
      }

      .total-emissions {
        text-align: center;
        margin-bottom: 3rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .total-value {
        font-size: 3rem;
        color: #ff6b6b;
        font-weight: bold;
        display: block;
      }

      .total-unit {
        font-size: 1rem;
        color: #cccccc;
        margin-top: 0.5rem;
      }

      .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .category-card {
        border-radius: 8px;
      }

      .category-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 2pt 2pt 2.5pt #C3CADB24;
      }

      .category-title {
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-align: center;
        letter-spacing: 2px;
      }

      .category-value {
        font-size: 0.9rem;
        text-align: center;
      }

      .category-unit {
        font-size: 0.9rem;
        color: #cccccc;
        text-align: center;
      }

      .category-percentage {
        font-size: 0.8rem;
        color: #ffb347;
        text-align: center;
        margin-top: 0.5rem;
      }

      .breakdown-item {
        display:flex;
        justify-content:space-between;
        padding: 0.5rem 1rem;
      }

      .item-emission {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .recommendations {
        position: fixed;
        top: 50%;
        right: -15%;
        transform: translate(-50%, -50%);
        width: 40vw;
        max-width: 1200px;
        height: 85vh;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 20px;
        border: 0.25px solid rgba(255, 255, 255);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 1rem;
        opacity: 0;
        box-sizing: border-box;
        overflow-y: auto;
      }

      .recommendation-page {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-top: 1rem;
      }

      .toggle-switch {
        display: flex;
        justify-content: center;
        margin-bottom: 0.5rem;
      }

      .toggle-switch button {
        background: rgba(255,255,255,0.6);
        border: none;
        padding: 0.4rem 0.8rem;
        margin: 0 0.25rem;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-switch button.active {
        background: rgba(255,255,255,0.95);
        font-weight: bold;
      }

      .recommendations strong {
        text-decoration: dotted;
        color: #ffffff;
        margin-bottom: 1rem;
        text-align: center;
        font-size: 1rem;
      }

      .recommendations ul {
        font-size: 0.55rem;
        line-height: 1.8;
      }

      .recommendations li {
        margin-bottom: 0.5rem;
      }
      
      .emissions-legend-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        list-style:none;
        text-align: center;
        padding:0; 
        margin:0;
      }

      .chart-container {
        display:flex;
        justify-content: space-evenly;
        align-items: center;
        width: 100%;
      }

      #emissions-chart {
        max-width: 50%;
        max-height: 300px;
      }

      /* legend åˆ—è¡¨ */
      #emissions-legend {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      /* æ¯ä¸€åˆ— */
      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
      }

      /* é¡è‰²å°åœ“é» */
      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
      }

      /* æ»‘é¼ æç¤ºæ ·å¼ */
      .scene-1 .scroll-mouse {
        position: absolute;
        bottom: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        width: 18px;
        height: 26px;
        opacity: 1;
        cursor: pointer;
      }

      .scene-2 .scroll-mouse {
        position: absolute;
        top: 5%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        width: 18px;
        height: 26px;
        opacity: 0;
        cursor: pointer;
      }

      /* åœ¨æ‰‹æ©Ÿç‰ˆæœ¬éš±è—æ»‘é¼ æç¤º */
      @media (max-width: 1024px) {
        .scroll-mouse {
          display: none !important;
        }
      }

      .border-anim {
        stroke-dasharray: 90;
        stroke-dashoffset: 90;
        cursor: pointer;
        transition: stroke-dashoffset 1s linear;
      }
      
      .mouse-line {
        position: absolute;
        width: 0.05rem;
        height: 0.4rem;
        background-color: #fff;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: translateY 0.3s linear;
        animation: none;
      }

      .scroll-mouse:not(:hover) .border-anim {
        stroke-dashoffset: 90;
      }

      .scroll-mouse:hover .border-anim {
        stroke-dashoffset: 0;
      }


      .error-message {
        color: #ff6b6b;
        text-align: center;
        font-size: 1.2rem;
        padding: 2rem;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(255, 107, 107, 0.3);
        margin: 1rem 0;
      }

      /* æ‰‹æ©Ÿç‰ˆæœ¬çš„éŸ¿æ‡‰å¼èª¿æ•´ */
      @media (max-width: 1024px) {
        .scene-1, .scene-2 {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
        }

        .scene-1 .sealevel-container,
        .scene-1 .carbon-footprint-emissions-container,
        .scene-1 .carbon-footprint-temperature-container,
        .scene-1 .polarbear-container {
          position: static !important;
          width: 90%;
          max-width: 450px;
          margin: 1rem 0;
          text-align: center;
          translate: none;
        }

        .scene-2 {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .scene-2 .carbon-footprint-status-container {
          position: static !important;
          width: 90vw;
          height: auto;
          max-height: none;
          margin-bottom: 2rem;
          transform: none;
          opacity: 1 !important;
        }

        .scene-2 .recommendations {
          position: static !important;
          width: 90vw;
          height: auto;
          max-height: none;
          margin-bottom: 2rem;
          transform: none;
          opacity: 1 !important;
        }

        .categories-grid {
          grid-template-columns: 1fr;
        }

        .analysis-title {
          font-size: 1.5rem;
        }

        .total-value {
          font-size: 2rem;
        }

        .chart-container {
          flex-direction: column;
        }

        #emissions-chart {
          max-width: 50%;
          max-height: 300px;
          margin-bottom: 1.5rem;
        }


        #emissions-legend {
          flex-direction: row
        }

        .legend-item {
          display: flex;
          justify-content: center;
          align-items: center;
          width: 30%;
        }
      }
    </style>
</head>
<body>
    <!-- åŠ è½½å±å¹• -->
    <div class="loading-screen">
        <div class="spinner"></div>
    </div>

    <div class="scroll-container">
        <section class="scene scene-1">
            <div class="sealevel-container">
                <p>2100å¹´ï¼Œé è¨ˆæµ·å¹³é¢<br>å°‡ä¸Šå‡......</p>
                <div style="display:flex; gap:1rem; align-items:flex-start;">
                  <!-- iframe å€å¡Š -->
                  <iframe id="mapFrame" 
                          src="https://coastal.climatecentral.org/embed/map/13/121.5354/25.082/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C" 
                          width="80%" height="200" 
                          style="border-radius:1rem; border:none;"
                          allow="fullscreen"
                          title="Climate Central Map">
                  </iframe>

                  <!-- æŒ‰éˆ•å€å¡Š -->
                  <div class="map-buttons">
                    <button onclick="switchMap('taipei', this)" class="active-btn">é›™åŒ—åœ°å€</button>
                    <button onclick="switchMap('yilan', this)">è˜­é™½å¹³åŸ</button>
                    <button onclick="switchMap('hsinchu', this)">ç«¹è‹—åœ°å€</button>
                    <button onclick="switchMap('taichung', this)">ä¸­å½°åœ°å€</button>
                    <button onclick="switchMap('chiayi', this)">é›²å˜‰å—å€</button>
                    <button onclick="switchMap('kaohsiung', this)">é«˜å±åœ°å€</button>
                  </div>
                </div>
            </div>

            <div class="carbon-footprint-emissions-container">
                <p class="emissions-text">æ‚¨éå»ä¸€å¹´çš„ç¢³è¶³è·¡æ’æ”¾æ˜¯</p>
                <p>
                    <span id="carbon-footprint-emissions-value">è¨ˆç®—ä¸­...</span>
                    <span>å…¬å™¸<span class="emissions-unit">äºŒæ°§åŒ–ç¢³ç•¶é‡(tCO2e)</span></span>
                </p>
                <p class="carbon-footprint-emissions-neutrality" id="neutrality-text">è¨ˆç®—ä¸­...</p>
            </div>

            <div class="carbon-footprint-temperature-container">
                <p class="temperature-text">åœ°çƒæŒçºŒå‡æº«</p>
                <p class="temperature-text">æœ¬ä¸–ç´€æœ«å°‡é”
                    <span id="carbon-footprint-temperature-value">3.7â„ƒ</span>
                </p>
            </div>

            <div class="polarbear-container">
                <img src="./images/bg-fashion.webp" alt="åŒ—æ¥µç†Š">
                <p class="polarbear-text">é€™å°‡å°è‡´æˆ‘å€‘å¯æ„›çš„åŒ—æ¥µç†Šä¸å†æœ‰å†·æ°£å¹...</p>
            </div>
            
            <div class="scroll-mouse">
                <svg class="mouse-svg" viewBox="0 0 18 26" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="16" height="24" rx="8" stroke="#cccccc" stroke-width="1" fill="none" />
                    <rect class="border-anim" x="1" y="1" width="16" height="24" rx="8" stroke="#ffffff" stroke-width="1" fill="none" />
                </svg>
                <div class="mouse-line"></div>
            </div>
        </section>

        <section class="scene scene-2">
            <div class="carbon-footprint-status-container">
                <h2 class="analysis-title">æ‚¨ç”Ÿæ´»ç¢³è¶³è·¡è¨ˆç®—çš„è©³ç´°æ•¸æ“š</h2>

                <div class="categories-grid" id="categories-container">
                </div>
            </div>

            <div class="recommendations">
              <div class="toggle-switch">
                <button id="summary-btn" class="active">çµèª</button>
                <button id="advice-btn">æ”¹å–„å»ºè­°</button>
              </div>

              <!-- ç¬¬ä¸€é ï¼šçµèªèˆ‡åœ“é¤…åœ– -->
              <div id="summary-page" class="recommendation-page">
                <!-- åœ“é¤…åœ–å€ -->
                <div class="chart-container">
                  <canvas id="emissions-chart"></canvas>
                  <!-- å³å´ legend -->
                  <div >
                    <ul class="emissions-legend-container" id="emissions-legend"></ul>
                  </div>
                </div>
              </div>

              <!-- ç¬¬äºŒé ï¼šæ”¹å–„å»ºè­° -->
              <div id="advice-page" class="recommendation-page" style="display:none;">
                <ul id="recommendations-list">
                  <li>è¨ˆç®—åˆ†æä¸­...</li>
                </ul>
              </div>
            </div>

            <div class="scroll-mouse">
                <svg class="mouse-svg" viewBox="0 0 18 26" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="16" height="24" rx="8" stroke="#cccccc" stroke-width="1" fill="none" />
                    <rect class="border-anim" x="1" y="1" width="16" height="24" rx="8" stroke="#ffffff" stroke-width="1" fill="none" />
                </svg>
                <div class="mouse-line"></div>
            </div>
        </section>
    </div>

    <script>
// Firebase é…ç½®
const firebaseConfig = {
  apiKey: "AIzaSyBm2oNcPhQ5nbQbLrvQUnlQ31LoxX3JThM",
  authDomain: "steinlux-calculator.firebaseapp.com",
  projectId: "steinlux-calculator",
  storageBucket: "steinlux-calculator.firebasestorage.app",
  messagingSenderId: "180210584345",
  appId: "1:180210584345:web:759888650c808df8159388",
  measurementId: "G-VX9JK5P5DF"
};

// åˆå§‹åŒ– Firebase
firebase.initializeApp(firebaseConfig);
const functions = firebase.functions();

// ç¢³è¶³è·¡æ•°æ® - è©³ç´°ç‰ˆæœ¬
let carbonDetailedData = {
    'traffic-daily': { total: 0, breakdown: {} },
    'home': { total: 0, breakdown: {} },
    'traffic-travel': { total: 0, breakdown: {} },
    'food': { total: 0, breakdown: {} },
    'fashion': { total: 0, breakdown: {} },
    'entertainment': { total: 0, breakdown: {} }
};

// ç¢³è¶³è·¡æ•°æ® - ç°¡åŒ–ç‰ˆæœ¬ï¼ˆä¿æŒç›¸å®¹æ€§ï¼‰
let carbonData = {
    'traffic-daily': 0,
    'home': 0,
    'traffic-travel': 0,
    'food': 0,
    'fashion': 0,
    'entertainment': 0
};

let totalEmissions = 0;

// é¡µé¢æ˜ å°„
const pageNames = {
    'traffic-daily': 'æ—¥å¸¸é€šå‹¤',
    'home': 'å±…ä½ç”Ÿæ´»',
    'traffic-travel': 'æ—…éŠäº¤é€š',
    'food': 'æ—¥å¸¸é£²é£Ÿ',
    'fashion': 'æ™‚å°šç©¿æ­',
    'entertainment': 'ç”Ÿæ´»å¨›æ¨‚'
};

const urls = {
  taipei: "https://coastal.climatecentral.org/embed/map/13/121.5354/25.082/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  yilan: "https://coastal.climatecentral.org/embed/map/12/121.8527/24.735/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  hsinchu: "https://coastal.climatecentral.org/embed/map/12/120.9782/24.7644/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  taichung: "https://coastal.climatecentral.org/embed/map/13/120.5391/24.1589/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  chiayi: "https://coastal.climatecentral.org/embed/map/11/120.2957/23.4169/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C",
  kaohsiung: "https://coastal.climatecentral.org/embed/map/11/120.6035/22.6896/?theme=warming&map_type=decadal_slr&basemap=roadmap&contiguous=false&elevation_model=best_available&esl_model=ipcc_2021&percentile=p95&slr_year=2100&temperature_rise=3.0&temperature_unit=C"
};

function switchMap(region, btn) {
  // æ› iframe çš„ src
  document.getElementById("mapFrame").src = urls[region];

  // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
  document.querySelectorAll(".map-buttons button").forEach(b => {
    b.classList.remove("active-btn");
  });

  // å¹«ç›®å‰é»æ“Šçš„æŒ‰éˆ•åŠ ä¸Š active æ¨£å¼
  if (btn) {
    btn.classList.add("active-btn");
  }
}

// æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
function isMobile() {
    return window.innerWidth <= 1024 || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// å½“å‰æ¨¡å¼çŠ¶æ€
let currentMode = null;
let sceneTransitionsSetup = false;

// è·å–ç”¨æˆ·ID
function getUserId() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    
    if (userId) {
        return userId;
    }
    
    const storedUserId = localStorage.getItem('userId');
    if (storedUserId) {
        return storedUserId;
    }
    
    return 'test-user';
}

// è°ƒç”¨ Firebase Function è®¡ç®—ç¢³è¶³è·¡
async function calculateCarbonFootprintDetailed() {
    const userId = getUserId();
    const pages = Object.keys(carbonDetailedData);
    const calculateCarbonPage = functions.httpsCallable('calculateCarbonPage');

    try {
        const promises = pages.map(pageName => 
            calculateCarbonPage({ userId, pageName })
        );

        const results = await Promise.all(promises);
        
        // æ›´æ–°è©³ç´°æ•¸æ“š
        results.forEach(result => {
            if (result.data) {
                const pageName = result.data.pageName;
                carbonDetailedData[pageName] = {
                    total: result.data.total || 0,
                    breakdown: result.data.breakdown || {}
                };
                // ä¿æŒåŸæœ‰çš„ carbonData æ ¼å¼
                carbonData[pageName] = result.data.total || 0;
            }
        });

        // è¨ˆç®—ç¸½æ’æ”¾é‡
        totalEmissions = Object.values(carbonData).reduce((sum, value) => sum + value, 0)/1000;
        
        return true;
    } catch (error) {
        console.error('è¨ˆç®—ç¢³è¶³è·¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        showError('è¨ˆç®—ç¢³è¶³è·¡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        return false;
    }
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    const container = document.getElementById('categories-container');
    container.innerHTML = `<div class="error-message">${message}</div>`;
}

const categoryInfo = {
    'traffic-daily': { color: '#6D808F', bgcolor: '#6D808F35', name: 'æ—¥å¸¸é€šå‹¤' },
    'home': { color: '#A88E71', bgcolor: '#A88E7135', name: 'å±…ä½ç”Ÿæ´»' },
    'traffic-travel': { color: '#C18181', bgcolor: '#C1818135', name: 'æ—…éŠäº¤é€š' },
    'food': { color: '#A3B18D', bgcolor: '#A3B18D35', name: 'æ—¥å¸¸é£²é£Ÿ' },
    'fashion': { color: '#B6A0B1', bgcolor: '#B6A0B135', name: 'æ™‚å°šç©¿æ­' },
    'entertainment': { color: '#AAC5D2', bgcolor: '#AAC5D235', name: 'ç”Ÿæ´»å¨›æ¨‚' }
};

function createCategoryCards() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';

    const order = ['traffic-daily', 'home', 'traffic-travel', 'food', 'fashion', 'entertainment'];

    const filteredEntries = Object.entries(carbonDetailedData)
        .filter(([pageKey, data]) => data.total > 0);

    if (filteredEntries.length === 0) {
        const noDataCard = document.createElement('div');
        noDataCard.className = 'category-card no-data';
        noDataCard.innerHTML = `
            <div class="category-header" style="background-color:#f0f0f0; font-weight:bold; color:#888; border-left: 8px solid #888;">
                <h3 class="category-title">æš«ç„¡æ•¸æ“š</h3>
                <div class="category-value" style="color:#888;">0.000</div>
            </div>
            <div class="category-description" style="padding:0.5rem 1rem;">è«‹å®Œæˆç¢³è¶³è·¡å•å·ä»¥æŸ¥çœ‹è©³ç´°æ•¸æ“š</div>
        `;
        container.appendChild(noDataCard);
        return;
    }

    const orderedEntries = filteredEntries.sort(
        ([a], [b]) => order.indexOf(a) - order.indexOf(b)
    );

    orderedEntries.forEach(([pageKey, data]) => {
        const info = categoryInfo[pageKey];

        const sortedBreakdown = Object.entries(data.breakdown)
            .filter(([itemName, itemData]) => itemData.emission > 0)
            .sort((a, b) => b[1].emission - a[1].emission);

        const card = document.createElement('div');
        card.className = 'category-card detailed';

        const itemsHTML = sortedBreakdown.length > 0 ?
            sortedBreakdown.map(([itemName, itemData]) => {
                return `
                    <div class="breakdown-item">
                        <div class="item-info">
                            <div class="item-name" style="font-weight:bold; color:${info.color};">${itemName}</div>
                            <div class="item-details" style="font-size:0.85em; color:#666;">
                                ${itemData.input} ${itemData.unit || ''}
                            </div>
                        </div>
                        <div class="item-emission" style="color:${info.color};">
                            ${itemData.emission.toFixed(3)}
                        </div>
                    </div>
                `;
            }).join('')
            : '<div class="no-items" style="padding:0.5rem 1rem; color:#999;">æš«ç„¡è©³ç´°é …ç›®</div>';

        card.innerHTML = `
            <div class="category-header" style="background-color:${info.bgcolor}; font-weight:bold; color:${info.color}; border-left: 8px solid ${info.color};">
                <h3 class="category-title" style="margin:0;">${info.name}</h3>
                <div class="category-value" style="color:${info.color};">${data.total.toFixed(3)}</div>
            </div>
            <div class="category-breakdown">
                ${itemsHTML}
            </div>
        `;

        container.appendChild(card);
    });
}

// æ›´æ–°æ˜¾ç¤ºæ•°æ®
function updateDisplay() {
    // æ›´æ–°ç¬¬ä¸€å¹•çš„æ€»æ’æ”¾é‡
    const emissionsValueElement = document.getElementById('carbon-footprint-emissions-value');
    if (totalEmissions > 0) {
        emissionsValueElement.textContent = totalEmissions.toFixed(3);
        
        // æ›´æ–°ä¸­å’Œè¯´æ˜
        const forestArea = Math.round(totalEmissions * 1388.889);
        const stadiums = (forestArea / 12950).toFixed(1);
        const neutralityText = document.getElementById('neutrality-text');
        neutralityText.textContent = `ç‚ºäº†ä¸­å’Œæ‚¨çš„æ’æ”¾ï¼Œå¿…é ˆå¾©è‚²å¤§ç´„ ${forestArea.toLocaleString()}mÂ²çš„è‡ªç„¶å†ç”Ÿæ—åœ°ã€‚é€™å¤§ç´„èˆ‡${stadiums}åº§å°åŒ—å¤§å·¨è›‹ç›¸åŒï¼`;
        
    } else {
        emissionsValueElement.textContent = 'æš«ç„¡æ•¸æ“š';
        const neutralityText = document.getElementById('neutrality-text');
        neutralityText.textContent = 'è«‹å®Œæˆç¢³è¶³è·¡å•å·ï¼Œæˆ‘å€‘å°‡ç‚ºæ‚¨è¨ˆç®—éœ€è¦å¾©è‚²çš„æ£®æ—é¢ç©ã€‚';
        
    }

    // åˆ›å»ºåˆ†ç±»å¡ç‰‡
    createCategoryCards();

    // ç”Ÿæˆå‡ç¢³å»ºè®®
    generateRecommendations();

    // åˆå§‹åŒ–åœ“é¤…åœ–
    renderEmissionsChart();
}

// åˆå§‹åŒ– Chart.js åœ“é¤…åœ–
let emissionsChart = null;

function renderEmissionsChart() {
  const ctx = document.getElementById('emissions-chart').getContext('2d');
  const dataValues = [];
  const dataLabels = [];
  const dataColors = [];

  Object.entries(carbonData).forEach(([key, value]) => {
    if (value > 0) {
      dataValues.push(value);
      dataLabels.push(categoryInfo[key].name);
      dataColors.push(categoryInfo[key].color);
    }
  });

  // å¦‚æœå·²å­˜åœ¨åœ–è¡¨å°±å…ˆéŠ·æ¯€
  if (emissionsChart) emissionsChart.destroy();

  // åˆå§‹åŒ–åœ“é¤…åœ–
  emissionsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: dataLabels,
      datasets: [{
        data: dataValues,
        backgroundColor: dataColors,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false // å…§å»º legend é—œé–‰
        }
      }
    }
  });

// ç”Ÿæˆå³å´è‡ªè¨‚ legend
const legendContainer = document.getElementById('emissions-legend');
legendContainer.innerHTML = ''; // æ¸…ç©ºèˆŠçš„ legend
const total = dataValues.reduce((a, b) => a + b, 0);

dataLabels.forEach((label, index) => {
  const li = document.createElement('li');
  li.classList.add('legend-item');
  li.style.color = dataColors[index]; // é¡è‰²ä¾ç„¶ç”¨ inlineï¼Œå› ç‚ºæ¯å€‹é¡è‰²ä¸åŒ

  const colorBox = document.createElement('span');
  colorBox.classList.add('legend-color');
  colorBox.style.backgroundColor = dataColors[index];

  const percent = ((dataValues[index] / total) * 100).toFixed(1);

  li.appendChild(colorBox);
  li.appendChild(document.createTextNode(`${label}: ${percent}%`));

  legendContainer.appendChild(li);
});
}


// Toggle åˆ‡æ›
document.getElementById('summary-btn').addEventListener('click', () => {
  document.getElementById('summary-page').style.display = 'flex';
  document.getElementById('advice-page').style.display = 'none';
  document.getElementById('summary-btn').classList.add('active');
  document.getElementById('advice-btn').classList.remove('active');
  renderEmissionsChart();
});

document.getElementById('advice-btn').addEventListener('click', () => {
  document.getElementById('summary-page').style.display = 'none';
  document.getElementById('advice-page').style.display = 'flex';
  document.getElementById('summary-btn').classList.remove('active');
  document.getElementById('advice-btn').classList.add('active');
});

function generateRecommendations() {
  const recommendations = [];

  // å–å¾—æœ‰æ•¸å€¼çš„é …ç›®ï¼Œä¸¦æ’åºå–å‰ä¸‰å¤§
  const activeCategories = Object.entries(carbonData)
    .filter(([key, value]) => value > 0)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3); // åªå–å‰ä¸‰å¤§

  const list = document.getElementById('recommendations-list');
  list.innerHTML = ''; // æ¸…ç©ºåŸæœ¬å…§å®¹

  if (activeCategories.length === 0) {
    recommendations.push({
      pageKey: 'none',
      title: 'å°šæœªå®Œæˆå•å·',
      content: 'è«‹å…ˆå®Œæˆç¢³è¶³è·¡å•å·ï¼Œæˆ‘å€‘å°‡æ ¹æ“šæ‚¨çš„æ•¸æ“šæä¾›å€‹äººåŒ–æ¸›ç¢³å»ºè­°'
    });
  } else {
    // é‡å°å‰ä¸‰å¤§é¡åˆ¥æä¾›è©³ç´°å»ºè­°
    activeCategories.forEach(([pageKey, value]) => {
      switch(pageKey) {
        case 'traffic-daily':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: 'ä½ çš„æ—¥å¸¸é€šå‹¤ç¢³æ’æ”¾è¼ƒé«˜ï¼Œå¯èƒ½æ˜¯å› ç‚ºæ©Ÿè»Šæˆ–æ±½è»Šä½¿ç”¨é »ç‡è¼ƒé«˜ã€‚å¯ä»¥è€ƒæ…®æ”¹è®Šéƒ¨åˆ†é€šå‹¤æ–¹å¼ã€‚<br>ä¾‹å¦‚ï¼š<br>â€¢ çŸ­ç¨‹æ”¹ç‚ºæ­¥è¡Œæˆ–é¨è…³è¸è»Šï¼Œæ¸›å°‘ç‡ƒæ²¹è»Šä½¿ç”¨æ¬¡æ•¸<br>â€¢ è‹¥æœ‰æ¢ä»¶ï¼Œå¯æ”¹ç”¨é›»å‹•è»Šæˆ–å…±ä¹˜æ–¹å¼ï¼Œæ¸›å°‘å€‹äººæ’æ”¾<br>â€¢ èª¿æ•´é§•é§›ç¿’æ…£ï¼Œå¦‚ä¿æŒèƒå£“ã€æ¸›å°‘æ€ é€Ÿï¼Œä»¥æå‡ç‡ƒæ²¹æ•ˆç‡'
          });
          break;
        case 'traffic-travel':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: 'ä½ çš„æ—…éŠäº¤é€šç¢³è¶³è·¡è¼ƒé«˜ï¼Œå¯èƒ½æ˜¯ä¾†è‡ªé£›æ©Ÿæ—…è¡Œã€‚é•·é€”é£›è¡Œæ˜¯å€‹äººç¢³æ’æ”¾çš„ä¸»è¦ä¾†æºä¹‹ä¸€ã€‚<br>ä½ å¯ä»¥è€ƒæ…®ï¼š<br>â€¢ æ¸›å°‘ä¸å¿…è¦çš„çŸ­é€”é£›è¡Œï¼Œæ”¹æ­é«˜éµæˆ–ç«è»Š<br>â€¢ è‹¥éœ€é£›è¡Œï¼Œé¸æ“‡ç›´é£›èˆªç­ï¼Œæ¸›å°‘ä¸­è½‰ç”¢ç”Ÿçš„é¡å¤–æ’æ”¾<br>â€¢ æ”¯æŒç¢³è£œå„Ÿè¨ˆç•«ï¼Œå¦‚é¸æ“‡èˆªç©ºå…¬å¸çš„ç¢³ä¸­å’Œé¸é …'
          });
          break;
        case 'home':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: 'ä½ çš„ä½å®¶ç¢³æ’æ”¾è¼ƒé«˜ï¼Œå¯èƒ½èˆ‡å®¶é›»ä½¿ç”¨ã€å†·æ°£æˆ–ç†±æ°´å™¨æœ‰é—œã€‚ä½ å¯ä»¥å˜—è©¦ï¼š<br>â€¢ æ›´æ›é«˜æ•ˆç¯€èƒ½é›»å™¨ï¼Œå¦‚ LED ç‡ˆã€è®Šé »å†·æ°£<br>â€¢ æ¸›å°‘ä¸å¿…è¦çš„é›»å™¨å¾…æ©Ÿé›»åŠ›ï¼Œä½¿ç”¨æ’åº§é–‹é—œéš¨æ‰‹é—œé–‰<br>â€¢ æå‡æˆ¿å±‹éš”ç†±æ•ˆæœï¼Œæ¸›å°‘å†·æ°£æˆ–æš–æ°£çš„ä½¿ç”¨éœ€æ±‚'
          });
          break;
        case 'food':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: 'ä½ çš„é£²é£Ÿç¢³æ’æ”¾è¼ƒé«˜ï¼Œå¯èƒ½èˆ‡è‚‰é¡æ”å–é »ç¹æˆ–é£Ÿç‰©æµªè²»æœ‰é—œã€‚å»ºè­°ï¼š<br>â€¢ æ¸›å°‘ç´…è‚‰å’ŒåŠ å·¥è‚‰é¡æ”å–ï¼Œå¢åŠ æ¤ç‰©æ€§é£²é£Ÿ<br>â€¢ é¸æ“‡ç•¶å­£åœ¨åœ°é£Ÿæï¼Œæ¸›å°‘é£Ÿç‰©é‹è¼¸ç¢³æ’æ”¾<br>â€¢ æ¸›å°‘é£Ÿç‰©æµªè²»ï¼Œæ³¨æ„ä¿å­˜å’Œè¨ˆç•«è³¼è²·'
          });
          break;
        case 'fashion':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: 'ä½ çš„æ™‚å°šç©¿æ­ç¢³æ’æ”¾è¼ƒé«˜ï¼Œå¯èƒ½èˆ‡å¿«æ™‚å°šæ¶ˆè²»ç¿’æ…£æœ‰é—œã€‚å»ºè­°ï¼š<br>â€¢ é¸æ“‡è€ç”¨çš„è¡£ç‰©ï¼Œæ¸›å°‘è³¼è²·å¿«æ™‚å°š<br>â€¢ è€ƒæ…®äºŒæ‰‹æˆ–ç§Ÿå€Ÿæœé£¾<br>â€¢ æ”¯æŒæ°¸çºŒå“ç‰Œèˆ‡ç’°ä¿ææ–™çš„è¡£ç‰©'
          });
          break;
        case 'entertainment':
          recommendations.push({
            pageKey,
            title: categoryInfo[pageKey].name,
            content: 'ä½ çš„å¨›æ¨‚æ´»å‹•ç¢³æ’æ”¾è¼ƒé«˜ï¼Œå¯èƒ½èˆ‡é«˜è€—èƒ½å¨›æ¨‚è¨­å‚™æˆ–é »ç¹æ´»å‹•æœ‰é—œã€‚å»ºè­°ï¼š<br>â€¢ é¸æ“‡ä½ç¢³å¨›æ¨‚æ–¹å¼ï¼Œå¦‚æˆ¶å¤–é‹å‹•ã€é–±è®€<br>â€¢ æ¸›å°‘é«˜è€—èƒ½é›»å­è¨­å‚™ä½¿ç”¨æ™‚é–“<br>â€¢ åƒèˆ‡ç¤¾å€æ´»å‹•æˆ–å…¬å…±è³‡æºå¨›æ¨‚'
          });
          break;
      }
    });
  }

  // é¡¯ç¤ºå»ºè­°
  list.innerHTML = recommendations.map(rec => {
    if (rec.pageKey === 'none') {
      return `
        <li>
          <div style="font-weight:bold; color:#555;">${rec.title}</div>
          <div style="margin-left:0.5rem; color:#666;">${rec.content}</div>
        </li>
      `;
    } else {
      const info = categoryInfo[rec.pageKey];
      return `
        <li style="margin-bottom:1rem;">
          <div style="font-weight:bold; color:${info.color}; padding-left:0.5rem;">
            ${rec.title}
          </div>
          <div style="margin-left:0.75rem; margin-top:0.25rem; color:#333;">
            ${rec.content}
          </div>
        </li>
      `;
    }
  }).join('');
}

// é‡ç½®ç‚ºæ¡Œé¢æ¨¡å¼
function resetToDesktopMode() {
    const container = document.querySelector(".scroll-container");
    const body = document.body;
    
    // é‡ç½®æ»¾å‹•ä½ç½®åˆ°é ‚éƒ¨
    if (container) {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // é‡ç½®æ‰€æœ‰å…ƒç´ çš„é€æ˜åº¦
    setTimeout(() => {
        // ç¬¬ä¸€å¹•å…ƒç´ é¡¯ç¤º
        gsap.set(".scene-1 .sealevel-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-emissions-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-temperature-container", { opacity: 1 });
        gsap.set(".scene-1 .polarbear-container", { opacity: 1 });
        
        // ç¬¬äºŒå¹•å…ƒç´ éš±è—
        gsap.set(".scene-2 .carbon-footprint-status-container", { opacity: 0 });
        gsap.set(".scene-2 .recommendations", { opacity: 0 });
    }, 100);
    
    // æ¸…é™¤å¯èƒ½çš„æ¨£å¼è¦†è“‹
    body.style.overflow = "";
    if (container) {
        container.style.overflow = "";
    }
}

// é‡ç½®ç‚ºç§»å‹•æ¨¡å¼
function resetToMobileMode() {
    const container = document.querySelector(".scroll-container");
    
    // é‡ç½®æ»¾å‹•ä½ç½®åˆ°é ‚éƒ¨
    if (container) {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // ç¢ºä¿æ‰€æœ‰å…ƒç´ åœ¨ç§»å‹•ç‰ˆæœ¬éƒ½é¡¯ç¤º
    setTimeout(() => {
        gsap.set(".scene-1 .sealevel-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-emissions-container", { opacity: 1 });
        gsap.set(".scene-1 .carbon-footprint-temperature-container", { opacity: 1 });
        gsap.set(".scene-1 .polarbear-container", { opacity: 1 });
        gsap.set(".scene-2 .carbon-footprint-status-container", { opacity: 1 });
        gsap.set(".scene-2 .recommendations", { opacity: 1 });
    }, 100);
}

// è™•ç†æ¨¡å¼åˆ‡æ›
function handleModeChange() {
    const mobile = isMobile();
    
    if (currentMode === mobile) {
        return; // æ¨¡å¼æ²’æœ‰æ”¹è®Šï¼Œä¸éœ€è¦è™•ç†
    }
    
    console.log(`æ¨¡å¼åˆ‡æ›: ${currentMode === null ? 'åˆå§‹åŒ–' : (currentMode ? 'ç§»å‹•' : 'æ¡Œé¢')} -> ${mobile ? 'ç§»å‹•' : 'æ¡Œé¢'}`);
    
    currentMode = mobile;
    
    if (mobile) {
        // åˆ‡æ›åˆ°ç§»å‹•æ¨¡å¼
        resetToMobileMode();
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›£è½å™¨
        removeDesktopEventListeners();
        sceneTransitionsSetup = false;
    } else {
        // åˆ‡æ›åˆ°æ¡Œé¢æ¨¡å¼
        resetToDesktopMode();
        // è¨­ç½®æ¡Œé¢ç‰ˆå ´æ™¯åˆ‡æ›
        if (!sceneTransitionsSetup) {
            setTimeout(() => {
                setupSceneTransitions();
                sceneTransitionsSetup = true;
            }, 200);
        }
    }
}

// ç§»é™¤æ¡Œé¢ç‰ˆäº‹ä»¶ç›£è½å™¨
let currentScrollListener = null;
let currentMouseListeners = [];

function removeDesktopEventListeners() {
    const container = document.querySelector(".scroll-container");
    
    // ç§»é™¤æ»¾è¼ªäº‹ä»¶ç›£è½å™¨
    if (container && currentScrollListener) {
        container.removeEventListener('wheel', currentScrollListener);
        currentScrollListener = null;
    }
    
    // ç§»é™¤æ»‘é¼ é»æ“Šäº‹ä»¶
    currentMouseListeners.forEach(({ element, listener }) => {
        if (element && listener) {
            element.removeEventListener('click', listener);
        }
    });
    currentMouseListeners = [];
}
// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener("DOMContentLoaded", async () => {
    const loadingScreen = document.querySelector('.loading-screen');
    
    try {
        // ä½¿ç”¨æ–°çš„è©³ç´°è¨ˆç®—å‡½æ•¸
        const success = await calculateCarbonFootprintDetailed();
        
        if (success) {
            updateDisplay();
            console.log('ç¢³è¶³è·¡è¨ˆç®—å®Œæˆ:', carbonDetailedData);
            console.log('ç¸½æ’æ”¾é‡:', totalEmissions);
        } else {
            document.getElementById('carbon-footprint-emissions-value').textContent = 'è¨ˆç®—å¤±æ•—';
        }
    } catch (error) {
        console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
        showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    } finally {
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
        }, 1000);
    }

    // åˆå§‹åŒ–æ¨¡å¼æª¢æ¸¬
    handleModeChange();
    
    // ç›£è½è¦–çª—å¤§å°æ”¹è®Š
    let resizeTimeout;
    window.addEventListener('resize', () => {
        // é˜²æŠ–è™•ç†ï¼Œé¿å…é »ç¹è§¸ç™¼
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            handleModeChange();
        }, 250);
    });
    
    // ç›£è½æ–¹å‘æ”¹è®Šï¼ˆç§»å‹•è¨­å‚™ï¼‰
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            handleModeChange();
        }, 500); // çµ¦ä¸€é»æ™‚é–“è®“ç€è¦½å™¨å®Œæˆæ–¹å‘æ”¹è®Š
    });
});

// åœºæ™¯åˆ‡æ¢è®¾ç½® - åƒ…é™æ¡Œé¢ç‰ˆ
function setupSceneTransitions() {
    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting && entry.target.classList.contains('scene-2')) {
                    setTimeout(() => {
                        // ç¬¬äºŒå¹•è¿›å…¥åŠ¨ç”»
                    }, 1000);
                }
            });
        },
        { threshold: 0.6 }
    );

    observer.observe(document.querySelector(".scene-2"));

    const container = document.querySelector(".scroll-container");
    let isScrolling = false;
    const cooldownTime = 3000;
    let lastScrollTime = 0;

    function disableScroll() {
        document.body.style.overflow = "hidden";
        container.style.overflow = "hidden";
    }

    function enableScroll() {
        document.body.style.overflow = "";
        container.style.overflow = "";
    }

    // åˆ‡åˆ°ç¬¬äºŒå¹•
    function goToSecondScene() {
        document.querySelector(".scene-1").classList.remove("active");
        document.querySelector(".scene-2").classList.add("active");
        if (isScrolling) return;
        const vh = window.innerHeight;
        isScrolling = true;
        lastScrollTime = Date.now();
        disableScroll();

        gsap.to(container, {
            scrollTo: { y: vh },
            duration: 2,
            ease: "power2.out",
            onStart: () => {
                gsap.to(".scene-1", { PointerEvent: 'none' });
                gsap.to(".scene-1 .sealevel-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .carbon-footprint-emissions-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .carbon-footprint-temperature-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-1 .polarbear-container", { opacity: 0, duration: 0.25 });
                gsap.to(".scene-1 .scroll-mouse", { opacity: 0, duration: 0.25 });
                gsap.to(".scene-2", { PointerEvent: 'intial' });
                gsap.to(".scene-2 .carbon-footprint-status-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2 .recommendations", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2 .scroll-mouse", { delay: 0.5, opacity: 1, duration: 1.5 });
            },
            onComplete: () => {
                isScrolling = false;
                enableScroll();
            },
        });
    }

    // åˆ‡å›ç¬¬ä¸€å¹•
    function goToFirstScene() {
        document.querySelector(".scene-2").classList.remove("active");
        document.querySelector(".scene-1").classList.add("active");
        const vh = window.innerHeight;
        isScrolling = true;
        lastScrollTime = Date.now();
        disableScroll();

        gsap.to(container, {
            scrollTo: { y: 0 },
            duration: 2,
            ease: "power2.out",
            onStart: () => {
                gsap.to(".scene-1", { PointerEvent: 'intial' });
                gsap.to(".scene-1 .sealevel-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .carbon-footprint-emissions-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .carbon-footprint-temperature-container", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .polarbear-container", { delay: 0.75, opacity: 1, duration: 1.5 });
                gsap.to(".scene-1 .scroll-mouse", { delay: 0.5, opacity: 1, duration: 1.5 });
                gsap.to(".scene-2", { PointerEvent: 'none' });
                gsap.to(".scene-2 .carbon-footprint-status-container", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-2 .recommendations", { opacity: 0, duration: 0.5 });
                gsap.to(".scene-2 .scroll-mouse", { opacity: 0, duration: 0.5 });
            },
            onComplete: () => {
                isScrolling = false;
                enableScroll();
            },
        });
    }

  // æ»‘é¼ æ»šè½®åˆ‡æ¢åœºæ™¯
  const wheelHandler = (e) => {
      const statusContainer = document.querySelector(".carbon-footprint-status-container");
      const recommendations = document.querySelector(".recommendations");

      // ğŸ”’ å¦‚æœæ»¾å‹•äº‹ä»¶ç™¼ç”Ÿåœ¨æŒ‡å®šå®¹å™¨å…§ â†’ ä¸è§¸ç™¼å ´æ™¯åˆ‡æ›
      if (
          (statusContainer && statusContainer.contains(e.target)) ||
          (recommendations && recommendations.contains(e.target))
      ) {
          return; // ç›´æ¥è·³å‡ºï¼Œä¸åšå ´æ™¯åˆ‡æ›
      }

      const now = Date.now();
      if (now - lastScrollTime < cooldownTime || isScrolling) {
          e.preventDefault();
          return;
      }

      const deltaY = e.deltaY;
      const scrollTop = container.scrollTop;
      const vh = window.innerHeight;

      // å¾€ä¸‹æ»šè¿›å…¥ç¬¬äºŒå¹•
      if (deltaY > 0 && scrollTop < vh / 2) {
          e.preventDefault();
          goToSecondScene();
      }
      // å¾€ä¸Šæ»šå›åˆ°ç¬¬ä¸€å¹•
      else if (deltaY < 0 && scrollTop > vh / 1.5 && scrollTop < vh * 1.5) {
          e.preventDefault();
          goToFirstScene();
      }
  };
    
    container.addEventListener("wheel", wheelHandler, { passive: false });
    currentScrollListener = wheelHandler;

    // ç‚¹å‡»æ»‘é¼ å›¾æ ‡åˆ‡æ¢åœºæ™¯
    const scrollMouse1 = document.querySelector(".scene-1 .scroll-mouse");
    const scrollMouse2 = document.querySelector(".scene-2 .scroll-mouse");
    
    if (scrollMouse1) {
        scrollMouse1.addEventListener("click", goToSecondScene);
        currentMouseListeners.push({ element: scrollMouse1, listener: goToSecondScene });
    }
    
    if (scrollMouse2) {
        scrollMouse2.addEventListener("click", goToFirstScene);
        currentMouseListeners.push({ element: scrollMouse2, listener: goToFirstScene });
    }

    // æš´éœ²å…¨å±€å‡½æ•°
    window.goToSecondScene = goToSecondScene;
    window.goToFirstScene = goToFirstScene;
}

// é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
function retryCalculation() {
    const loadingScreen = document.querySelector('.loading-screen');
    loadingScreen.classList.remove('hidden');
    
    calculateCarbonFootprintDetailed().then(success => {
        if (success) {
            updateDisplay();
        } else {
            showError('é‡æ–°è¨ˆç®—å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç¨å¾Œå†è©¦');
        }
    }).finally(() => {
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
        }, 1000);
    });
}

// æ•°æ®å¯¼å‡ºåŠŸèƒ½
function exportCarbonData() {
    const exportData = {
        timestamp: new Date().toISOString(),
        userId: getUserId(),
        totalEmissions: totalEmissions,
        categories: carbonData,
        detailedData: carbonDetailedData,
        details: Object.entries(carbonData)
            .filter(([key, value]) => value > 0)
            .map(([key, value]) => ({
                category: pageNames[key],
                emissions: value,
                percentage: ((value / totalEmissions) * 100).toFixed(1)
            }))
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `carbon-footprint-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// æš´éœ²æµ‹è¯•å’Œå·¥å…·å‡½æ•°åˆ°å…¨å±€
window.retryCalculation = retryCalculation;
window.exportCarbonData = exportCarbonData;
    </script>
</body>
</html>