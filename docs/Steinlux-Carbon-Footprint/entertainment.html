<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>娛樂</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/all.css" />
    <link rel="stylesheet" href="css/story.css" />
    <style>
      .scene-1 .entertain-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(120px, 1fr));
        grid-template-rows: repeat(2, auto);
        gap: 1.75rem 1.5rem;
        width: 90%;
        max-width: 700px;
        margin: 0 auto;
      }

      .scene-1 .entertain-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 0.25rem 0;
        border-radius: 32px;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
      }

      .scene-1 .entertain-card img {
        width: 100px;
        height: 100px;
        object-fit: contain;
      }

      .scene-1 .entertain-card .label {
        font-family: "GenSenRounded2TW-R", sans-serif;
        font-size: 1.2rem;
        color: #5d6c78;
        text-align: center;
        white-space: nowrap;
        letter-spacing: 6px;
      }

      .scene-1 .entertain-card:hover {
        transform: translateY(-2px);
      }

      .scene-1 .entertain-card.selected {
      -webkit-box-shadow:
      inset -7.5px -4.75px 1px -6.5px rgb(255, 255, 255), 
      inset 7.5px 4.75px 1px -6.5px rgb(255, 255, 255),
      inset -1.75px -7.5px 1px -6.75px rgb(255, 255, 255), 
      inset 1.75px 7.5px 1px -6.75px rgb(255, 255, 255),
      2px 2px 8px 0px rgba(110, 110, 110, 0.275);
      box-shadow:
      inset -7px -4.75px 1px -6.5px rgb(255, 255, 255), 
      inset 7px 4.75px 1px -6.5px rgb(255, 255, 255),
      inset -1.75px -7px 1px -6.75px rgb(255, 255, 255), 
      inset 1.75px 7px 1px -6.75px rgb(255, 255, 255),
      2px 2px 8px 0px rgba(110, 110, 110, 0.275);
      }

      .custom-number-input {
        flex-wrap: wrap;
        justify-content: center;
      }

      .scene-2 .entertain-card {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 32px;
      }

      .scene-2 .entertain-card .toggle-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 32px;
        padding: 1rem 1.25rem;
        gap: 0.75rem;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .toggle-card::before {
      content: "";
      position: absolute;
      inset: 0;
      -webkit-box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      0 0 0 0.2px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      0 0 0 0.2px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: -1;
      border-radius: 32px;
      }
      
      .scene-2 .entertain-card .toggle-card-1 {
        width: 20%;
      }

      .scene-2 .entertain-card .toggle-card-2 {
        width: 40%;
      }

      .streaming-toggle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 32px;
      }

      .streaming-toggle-card-1,
      .streaming-toggle-card-2 {
        width: 80%;
      }

      .scene-2 .entertain-card .streaming-toggle-card-3 {
        display: flex;
        justify-content: center;
      }

      .scene-2 .toggle-card .question-title {
        font-family: "GenSenRounded2TW-R", sans-serif;
        color: #9c7a5c;
        line-height: 1.2;
        white-space: nowrap;
      }

      .scene-2 .toggle-card .question-unit {
        font-family: "GenSenRounded2TW-L", sans-serif;
        font-weight: normal;
        color: #6c808f;
      }

      .scene-2 .toggle-card .label {
        color: #444;
        user-select: none;
        margin-top: 8px;
      }

      .toggle-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.6rem;
      }

      .nowrap-text {
        color: #6c808f;
        white-space: nowrap;
        font-family: "GenSenRounded2TW-L", sans-serif;
        letter-spacing: 6px;
      }
      
      .info-btn {
        position: absolute;
        bottom: 48px;
        right: 32px;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 255, 255, 0.9) 0%,
          rgba(236, 240, 245, 1) 100%
        );
        -webkit-box-shadow:
        inset -0.185rem -0.235rem 0.315rem -0.295rem rgba(255, 255, 255), 
        inset 0.185rem 0.25rem 0.315rem -0.295rem rgba(255, 255, 255),
        -0.06rem -0.03rem 0 0 rgba(255, 255, 255), 
        0.03rem 0.03rem 0 0 rgba(255, 255, 255);
        box-shadow:
        inset -0.285rem -0.235rem 0.1rem -0.295rem rgba(255, 255, 255), 
        inset 0.285rem 0.235rem 0.1rem -0.295rem rgba(255, 255, 255),
        -0.03rem -0.025rem 0 0 rgba(255, 255, 255), 
        0.025rem 0.025rem 0 0 rgba(255, 255, 255),
        4px 8px 16px 0 rgba(110, 110, 110, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        z-index: 10;
      }

      .info-btn img {
        width: 20px;
        height: 20px;
        object-fit: contain;
      }

      .modal {
        display: none;
        justify-content: center;
        align-items: center;
        position: fixed;
        bottom: 24px;
        right: -8px;
        transform: translate(-50%, -50%);
        width: fit-content;
        height: 1rem;
        -webkit-box-shadow:
        inset -0.185rem -0.235rem 0.315rem -0.295rem rgba(255, 255, 255), 
        inset 0.185rem 0.25rem 0.315rem -0.295rem rgba(255, 255, 255),
        -0.06rem -0.03rem 0 0 rgba(255, 255, 255), 
        0.03rem 0.03rem 0 0 rgba(255, 255, 255);
        box-shadow:
        inset -0.185rem -0.235rem 0.315rem -0.295rem rgba(255, 255, 255), 
        inset 0.185rem 0.25rem 0.315rem -0.295rem rgba(255, 255, 255),
        -0.06rem -0.03rem 0 0 rgba(255, 255, 255), 
        0.03rem 0.03rem 0 0 rgba(255, 255, 255);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 0.75rem;
        z-index: 1000;
      }

      .modal-body {
        font-size: 0.75rem;
        flex: 1;
        overflow-y: auto;
        white-space: nowrap;
      }

      @media (min-width: 320px) and (max-width: 600px) {
        .scene-1 .entertain-grid {
          grid-template-columns: repeat(2, minmax(80px, 1fr));
          grid-template-rows: repeat(3, minmax(120px, 1fr));
        }
      }

      @media (min-width: 600px) and (max-width: 900px) {
        .scene {
          min-height: unset;
        }

        .scene-1 .entertain-grid img {
          width: 100px;
          height: 100px;
        }
      }

      @media (min-width: 600px) and (max-width: 900px) and (orientation: portrait) {
        .scene-1 .entertain-grid {
          grid-template-columns: repeat(2, minmax(120px, 1fr));
          grid-template-rows: repeat(3, auto);
        }
      }

      @media (max-width: 600px) {
        .scene-1 .entertain-card img {
          width: 80px;
          height: 80px;
        }

        .scene-2 .entertain-card .toggle-card-2 {
          margin-bottom: 2rem;
        }
      }

      @media (max-width: 900px) {
        .scene-2 .entertain-card .toggle-card {
          width: 80%;
        }

        .scene-2 .entertain-card .toggle-card-1 {
          flex-direction: column;
          justify-content: center;
        }

        .scene-2 .entertain-card .toggle-card-2 {
          padding: 2rem 1rem;
        }

        .info-btn {
        bottom: 20px;
        right: 24px;
        }

        .modal {
          bottom: -4px;
          right: -16px;
        }
      }

      @media (max-width: 1024px) {
        .streaming .entertain-card .toggle-card {
          width: 80%;
          justify-content: center;
        }

        .streaming-toggle-container {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- 故事劇情 -->
    <story-chatroom></story-chatroom>
    
    <!-- Scene 1: 選娛樂活動 -->
    <section id="scene-entertain-1" class="scene scene-1">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>日常生活中有哪些娛樂活動？</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="entertain-grid">
          <div class="entertain-card" onclick="toggleActivity(this,'KTV')">
            <img src="images/KTV.webp" alt="KTV" /><span class="label">KTV</span>
          </div>
          <div class="entertain-card" onclick="toggleActivity(this,'電影')">
            <img src="images/電影院.webp" alt="電影" /><span class="label"
              >電影</span
            >
          </div>
          <div class="entertain-card" onclick="toggleActivity(this,'健身房')">
            <img src="images/健身房.webp" alt="健身房" /><span class="label"
              >健身房</span
            >
          </div>
          <div class="entertain-card" onclick="toggleActivity(this,'旅遊住宿')">
            <img src="images/飯店.webp" alt="旅遊住宿" /><span class="label"
              >旅遊住宿</span
            >
          </div>
          <div class="entertain-card" onclick="toggleActivity(this,'影音串流')">
            <img src="images/串流媒體.webp" alt="影音串流" /><span class="label"
              >影音串流</span
            >
          </div>
          <div class="entertain-card" onclick="toggleActivity(this,'宗教信仰')">
            <img src="images/宗教.webp" alt="宗教信仰" /><span class="label"
              >宗教信仰</span
            >
          </div>
        </div>
      </div>
      <button
        class="nav-btn prev-btn"
        onclick="window.location.href='fashion.html'"
      >
        ‹
      </button>
      <!-- 第一頁下一頁按鈕 -->
      <button class="nav-btn next-btn" onclick="handleFirstSceneNext()">
        ›
      </button>
    </section>

    <!-- Scene 1：KTV -->
    <section id="scene-entertain-2-1" class="scene scene-2 KTV">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>日常生活中去KTV頻率？</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="entertain-card">
          <div class="toggle-card toggle-card-1">
            <span class="question-title">時間單位</span>
            <div class="toggle-row">
              <span class="nowrap-text">月</span>
              <label class="toggle-switch">
                <input type="checkbox" id="KTV-unit-toggle"/>
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">年</span>
            </div>
          </div>
          <div class="toggle-card toggle-card-2">
            <span class="question-title" data-template="每{unit}去KTV"
              >每月去KTV</span
            >
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" id="entertainment-KTV-value"/>
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
              <span class="question-unit question-title" data-template="次/{unit}"
                >次/月</span
              >
            </div>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 2：電影院 -->
    <section id="scene-entertain-2-2" class="scene scene-2 Cinema">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>日常生活中到電影院觀影頻率？</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="entertain-card">
          <div class="toggle-card toggle-card-1">
            <span class="question-title">時間單位</span>
            <div class="toggle-row">
              <span class="nowrap-text">月</span>
              <label class="toggle-switch">
                <input type="checkbox" id="cinema-unit-toggle"/>
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">年</span>
            </div>
          </div>
          <div class="toggle-card toggle-card-2">
            <span class="question-title" data-template="每{unit}去電影院"
              >每月去電影院</span
            >
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" id="entertainment-cinema-value"/>
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
              <span class="question-unit question-title" data-template="次/{unit}"
                >次/月</span
              >
            </div>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 3：健身房 -->
    <section id="scene-entertain-2-3" class="scene scene-2 gym">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>日常生活中到健身房健身頻率？</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
          <div class="entertain-card">
          <div class="toggle-card toggle-card-1">
            <span class="question-title">時間單位</span>
            <div class="toggle-row">
              <span class="nowrap-text">週</span>
              <label class="toggle-switch">
                <input type="checkbox" id="gym-unit-toggle"/>
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">月</span>
            </div>
          </div>
          <div class="toggle-card toggle-card-2">
            <span class="question-title" data-template="每{unit}去健身房"
              >每週去健身房</span
            >
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" id="entertainment-gym-value"/>
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
              <span class="question-unit question-title" data-template="次/{unit}"
                >次/週</span
              >
            </div>
          </div>
          </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 4：飯店 -->
    <section id="scene-entertain-2-4" class="scene scene-2 hotel">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>日常生活中入住飯店頻率？</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="entertain-card">
          <div class="toggle-card toggle-card-1">
            <span class="question-title">時間單位</span>
            <div class="toggle-row">
              <span class="nowrap-text">月</span>
              <label class="toggle-switch">
                <input type="checkbox" id="hotel-unit-toggle"/>
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">年</span>
            </div>
          </div>
          <div class="toggle-card toggle-card-2">
            <span class="question-title" data-template="每{unit}去住飯店"
              >每月去住飯店</span
            >
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" id="entertainment-hotel-value"/>
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
              <span class="question-unit question-title" data-template="次/{unit}"
                >次/月</span
              >
            </div>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 5：網路流量 -->
    <section id="scene-entertain-2-5" class="scene scene-2 streaming">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>日常生活中使用多少串流和網路流量？</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="entertain-card">
          <div class="toggle-card streaming-toggle-card-3">
            <span class="question-title">每月使用網路流量(GB)</span>
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" id="entertainment-internet-value"/>
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
            </div>
          </div>

          <div class="toggle-container streaming-toggle-container">
            <div class="toggle-card streaming-toggle-card-1">
              <span class="question-title">時間單位</span>
              <div class="toggle-row">
                <span class="nowrap-text">天</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="streaming-unit-toggle"/>
                  <span class="slider"></span>
                </label>
                <span class="nowrap-text">周</span>
              </div>
            </div>

            <div class="toggle-card streaming-toggle-card-2">
              <span class="question-title" data-template="每{unit}使用串流影音">
                每天使用串流影音
              </span>
              <div class="custom-number-input">
                <button type="button" class="btn-decrement">
                  <span class="decrement">-</span>
                </button>
                <input type="number" value="0" min="0" id="entertainment-streaming-value"/>
                <button type="button" class="btn-increment">
                  <span class="increment">+</span>
                </button>
                <span
                  class="question-unit question-title"
                  data-template="小時/{unit}"
                >
                  小時/天
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 6：宗教活動 -->
    <section id="scene-entertain-2-6" class="scene scene-2 religion">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>日常生活中參與宗教活動頻率？</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="entertain-card">
          <div class="toggle-card toggle-card-1">
            <span class="question-title">時間單位</span>
            <div class="toggle-row">
              <span class="nowrap-text">月</span>
              <label class="toggle-switch">
                <input type="checkbox" id="religion-unit-toggle"/>
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">年</span>
            </div>
          </div>
          <div class="toggle-card toggle-card-2">
            <span class="question-title" data-template="每{unit}使用金紙"
              >每月使用金紙？</span
            >
            <div class="custom-number-input">
              <button type="button" class="btn-decrement">
                <span class="decrement">-</span>
              </button>
              <input type="number" value="0" min="0" id="entertainment-religion-value"/>
              <button type="button" class="btn-increment">
                <span class="increment">+</span>
              </button>
              <span class="question-unit question-title" data-template="份/{unit}"
                >次/週</span
              >
            </div>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>

      <!-- Info 按鈕 -->
      <button id="info-btn" class="info-btn">
        <img src="images/info.webp" alt="!" />
      </button>

      <!-- 彈跳式視窗 -->
      <div id="modal" class="modal">
        <div class="modal-body">
          <span>金紙一份為500克</span>
        </div>
      </div>
    </section>
    
    <div id="page-loader" class="loader-overlay" style="display:none;">
      <div class="loader"></div>
    </div>

<script src="./js/all.js"></script>
<script type="module">
  import { saveSectionData, loadSectionData } from './js/firebase.js';
  import { functions, httpsCallable } from './js/firebase.js';

  // 頁面載入時回填
  window.addEventListener('DOMContentLoaded', async () => {
    try {
      const data = await loadSectionData('entertainment');
      if (data) {
        // KTV
        document.getElementById("entertainment-KTV-value").value = data.entertainmentKTV ?? 0;
        document.getElementById("KTV-unit-toggle").checked = data.entertainmentKTVToggle ?? false;

        // 電影
        document.getElementById("entertainment-cinema-value").value = data.entertainmentCinemaValue ?? 0;
        document.getElementById("cinema-unit-toggle").checked = data.entertainmentCinemaToggle ?? false;

        // 健身房
        document.getElementById("entertainment-gym-value").value = data.entertainmentGymValue ?? 0;
        document.getElementById("gym-unit-toggle").checked = data.entertainmentGymToggle ?? false;

        // 旅遊住宿
        document.getElementById("entertainment-hotel-value").value = data.entertainmentHotelValue ?? 0;
        document.getElementById("hotel-unit-toggle").checked = data.entertainmentHotelToggle ?? false;

        // 影音串流
        document.getElementById("entertainment-internet-value").value = data.entertainmentInternetValue ?? 0;
        document.getElementById("entertainment-streaming-value").value = data.entertainmentStreamingValue ?? 0;
        document.getElementById("streaming-unit-toggle").checked = data.entertainmentStreamingToggle ?? false;

        // 宗教信仰
        document.getElementById("entertainment-religion-value").value = data.entertainmentReligionValue ?? 0;
        document.getElementById("religion-unit-toggle").checked = data.entertainmentReligionToggle ?? false;
      }
    } catch (err) {
      console.error("載入資料失敗：", err);
    }
  });

function getUserId() {
  let userId = localStorage.getItem("userId");
  if (!userId) {
    userId = `user_${Date.now()}`;
    localStorage.setItem("userId", userId);
  }
  return userId;
}

async function calculate() {
  const userId = getUserId();
  console.log("userId:", userId);
  console.log("userId 型別:", typeof userId);

  // 檢查當前儲存的資料
  try {
    const currentData = await loadSectionData('entertainment');
    console.log("當前儲存的資料:", currentData);
  } catch (err) {
    console.log("載入資料失敗:", err);
  }

  try {
    console.log("開始呼叫 Cloud Function...");
    
    const calculateFunction = httpsCallable(functions, "calculateCarbonPage");
    
    const requestData = {
      userId: userId,
      pageName: "entertainment"
    };
    
    console.log("準備傳送的資料:", requestData);
    console.log("requestData 型別:", typeof requestData);
    console.log("JSON.stringify(requestData):", JSON.stringify(requestData));
    
    const result = await calculateFunction(requestData);
    
    console.log("Cloud Function 回應:", result);
    console.log("result.data:", result.data);
    
    if (result.data && result.data.total !== undefined) {
      const total = result.data.total;
      
      const resultElement = document.getElementById("calculation-result");
      if (resultElement) {
        resultElement.innerHTML = `
          <h3>計算結果</h3>
          <p>碳排放量: <strong>${total.toFixed(2)} kg CO2e</strong></p>
          <p>計算時間: ${new Date().toLocaleString()}</p>
        `;
      }
    } else {
      console.warn("回應格式異常:", result);
      alert("計算完成，但回應格式異常");
    }
    
  } catch (err) {
    console.error("完整錯誤物件:", err);
    console.error("錯誤訊息:", err.message);
    console.error("錯誤代碼:", err.code);
    console.error("錯誤詳細資訊:", err.details);
    
    let errorMessage = "計算失敗，請稍後再試";
    if (err.message) {
      errorMessage += `\n錯誤訊息: ${err.message}`;
    }
    
    alert(errorMessage);
  }
}

document.querySelectorAll(".next-btn").forEach(btn => {
  btn.addEventListener("click", calculate);
});

document.querySelectorAll(".chapter-button").forEach(btn => {
  btn.addEventListener("click", calculate);
});

  // 儲存資料並跳轉
  async function handleNext() {
    const data = {
      // KTV
      entertainmentKTV: parseFloat(document.getElementById("entertainment-KTV-value").value) || 0,
      entertainmentKTVToggle: document.getElementById("KTV-unit-toggle").checked,

      // 電影
      entertainmentCinemaValue: parseFloat(document.getElementById("entertainment-cinema-value").value) || 0,
      entertainmentCinemaToggle: document.getElementById("cinema-unit-toggle").checked,

      // 健身房
      entertainmentGymValue: parseFloat(document.getElementById("entertainment-gym-value").value) || 0,
      entertainmentGymToggle: document.getElementById("gym-unit-toggle").checked,

      // 旅遊住宿
      entertainmentHotelValue: parseFloat(document.getElementById("entertainment-hotel-value").value) || 0,
      entertainmentHotelToggle: document.getElementById("hotel-unit-toggle").checked,

      // 影音串流
      entertainmentInternetValue: parseFloat(document.getElementById("entertainment-internet-value").value) || 0,
      entertainmentStreamingValue: parseFloat(document.getElementById("entertainment-streaming-value").value) || 0,
      entertainmentStreamingToggle: document.getElementById("streaming-unit-toggle").checked,

      // 宗教信仰
      entertainmentReligionValue: parseFloat(document.getElementById("entertainment-religion-value").value) || 0,
      entertainmentReligionToggle: document.getElementById("religion-unit-toggle").checked
    };

    try {
      await saveSectionData('entertainment', data);
    } catch (err) {
      console.error("儲存資料失敗：", err);
      alert("資料儲存失敗，請稍後再試。");
    }
  }

    document.querySelectorAll(".next-btn").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    document.querySelectorAll(".prev-btn").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    document.querySelectorAll(".chapter-button").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
</script>

  <script>


    let currentScene = "scene-entertain-1";

    function goToNextScene() {
      const currentIndex = selectedActivities.findIndex(
        (activity) => activityScenes[activity] === currentScene
      );

      if (currentIndex === selectedActivities.length - 1) {
        window.location.href = "analysis.html";
        return;
      }

      const nextActivity = selectedActivities[currentIndex + 1];
      const nextSceneId = activityScenes[nextActivity];
      if (nextSceneId) {
        goToScene(nextSceneId);
      }
    }

    function goToPrevScene() {
      const currentIndex = selectedActivities.findIndex(
        (activity) => activityScenes[activity] === currentScene
      );

      if (currentIndex === 0) {
        goToScene("scene-entertain-1");
        return;
      }

      const prevActivity = selectedActivities[currentIndex - 1];
      const prevSceneId = activityScenes[prevActivity];
      if (prevSceneId) {
        goToScene(prevSceneId);
      }
    }


    const infoBtn = document.getElementById("info-btn");
    const modal = document.getElementById("modal");

    infoBtn.addEventListener("click", () => {
      if (modal.style.display === "flex") {
        modal.style.display = "none";
      } else {
        modal.style.display = "flex";
      }
    });

    document.querySelectorAll(".entertain-card").forEach((card) => {
      const toggle = card.querySelector(
        '.toggle-switch input[type="checkbox"]'
      );
      const titles = card.querySelectorAll(".question-title[data-template]");

      if (!toggle || titles.length === 0) return;

      const leftLabel = card
        .querySelector(".toggle-row span:nth-child(1)")
        ?.textContent.trim();
      const rightLabel = card
        .querySelector(".toggle-row span:nth-child(3)")
        ?.textContent.trim();

      function updateTitle() {
        const selectedUnit = toggle.checked ? rightLabel : leftLabel;
        titles.forEach((title) => {
          const template = title.dataset.template;
          title.textContent = template.replace("{unit}", selectedUnit);
        });
      }

      updateTitle();
      toggle.addEventListener("change", updateTitle);
    });

    const messages = [
          {
              type: "time",
              text: "上午 9:30",
              time: 1000,
          },
          {
              text: "登入中...歡迎進入AI智慧雲端生活！你現在的生活是24小時上網、AI推薦吃穿用、手機一天充三次電的超人類時代！",
              from: "cat",
              time: 2000,
              typingTime: 1500,
          },
          {
              text: "這裡是...現在的我們對吧？",
              from: "user",
              time: 1500,
              typingTime: 800,
          },
          {
              text: "沒錯，這正是我們的「碳生活」主場。從你打開一支reels、追一場Netflix、用AI生成一張貓貓圖，背後都是巨大的雲端伺服器在運轉。",
              from: "cat",
              time: 2500,
              typingTime: 2000,
          },
          {
              text: "資料中心需要全年無休和冷卻、高頻計算、高能耗伺服器，而智慧生活帶來的便利，也帶來前所未有的能源需求。說白了，現在我們不用出門也能...碳排爆表！",
              from: "cat",
              time: 3000,
              typingTime: 2500,
          },
          {
              text: "確實！我們根本無法拒絕便利！但，這不就是人類推動科技進步的目的嗎...",
              from: "user",
              time: 2000,
              typingTime: 1200,
          },
      ];

    // 選擇娛樂活動

    function handleFirstSceneNext() {
      const fullOrder = [
        "KTV",
        "電影",
        "健身房",
        "旅遊住宿",
        "影音串流",
        "宗教信仰",
      ];

      const sortedActivities = fullOrder.filter((activity) =>
        selectedActivities.includes(activity)
      );

      selectedActivities.length = 0;
      selectedActivities.push(...sortedActivities);

      if (selectedActivities.length === 0) {
        alert("請至少選擇一個娛樂活動！");
        return;
      }

      const firstScene = activityScenes[selectedActivities[0]];
      goToScene(firstScene);
    }

    const selectedActivities = [];
    const activityScenes = {
      KTV: "scene-entertain-2-1",
      電影: "scene-entertain-2-2",
      健身房: "scene-entertain-2-3",
      旅遊住宿: "scene-entertain-2-4",
      影音串流: "scene-entertain-2-5",
      宗教信仰: "scene-entertain-2-6",
    };

    function toggleActivity(card, activity) {
      const index = selectedActivities.indexOf(activity);

      if (index === -1) {
        selectedActivities.push(activity);
        card.classList.add("selected");
      } else {
        selectedActivities.splice(index, 1);
        card.classList.remove("selected");
      }

      updatePageIndicators();
    }

    // bar跳轉頁面

    function goToScene(targetId) {
      document.getElementById(currentScene).classList.remove("active");
      document.getElementById(targetId).classList.add("active");
      currentScene = targetId;
      updatePageIndicators();
      updateNavButtonsVisibility();
    }

  function updatePageIndicators() {
    const scene = document.getElementById(currentScene);
    const container = scene.querySelector(".dynamic-bar-container");

    if (!container) return;
    container.innerHTML = "";

    const selectHitArea = document.createElement("div");
    selectHitArea.classList.add("bar-hit-area");

    const selectBar = document.createElement("span");
    selectBar.classList.add("bar");

    if (currentScene === "scene-entertain-1") {
      selectBar.classList.add("active");
    }

    selectHitArea.appendChild(selectBar);
    selectHitArea.onclick = () => {
      goToScene("scene-entertain-1");
      updateBarActive(0);
    };
    container.appendChild(selectHitArea);

    selectedActivities.forEach((activity, idx) => {
      const sceneId = activityScenes[activity];
      if (!sceneId) return;

      const hitArea = document.createElement("div");
      hitArea.classList.add("bar-hit-area");

      const bar = document.createElement("span");
      bar.classList.add("bar");

      if (currentScene === sceneId) {
        bar.classList.add("active");
      }

      hitArea.appendChild(bar);

      hitArea.onclick = () => {
        goToScene(sceneId);
        updateBarActive(idx + 1);
      };

      container.appendChild(hitArea);
    });
  }


  function updateNavButtonsVisibility() {
    const sceneEl = document.getElementById(currentScene);

    const prevBtn = sceneEl.querySelector(".prev-btn");
    const nextBtn = sceneEl.querySelector(".next-btn");

    document.querySelectorAll(".prev-btn, .next-btn").forEach(btn => {
      btn.style.display = "none";
    });

    if (prevBtn) prevBtn.style.display = "block";
    if (nextBtn) nextBtn.style.display = "block";
  }


  function updateBarActive(activeIndex) {
    const scene = document.getElementById(currentScene);
    const container = scene.querySelector(".dynamic-bar-container");
    if (!container) return;

    const bars = container.querySelectorAll(".bar-hit-area .bar");
    bars.forEach((bar, idx) => {
      if (idx === activeIndex) {
        bar.classList.add("active");
      } else {
        bar.classList.remove("active");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    currentScene = "scene-entertain-1";
    updatePageIndicators();
    updateNavButtonsVisibility();
  });

  </script>
  </body>
</html>

