<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>日常交通</title>
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/all.css" />
    <link rel="stylesheet" href="css/story.css" />
    <style>
      input[list="trDistanceMap"]:valid,
      input[list="hsrStationList"]:valid,
      input[list="mrtStationList"]:valid {
          background-color: white !important;
      }

      #pane-left, #pane-right, #pane-left4, #pane-right4 {
        animation: none;
      }

      .hidden {
        display: none;
      }

      .inactive {
        opacity: 0.4;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .transport-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(120px, 1fr));
        grid-template-rows: repeat(2, auto);
        gap: 1.75rem 1.5rem;
        width: 90%;
        max-width: 700px;
        margin: 0 auto;
      }

      .transport-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 32px;
        padding: 0.25rem 0;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
      }
      
      .transport-card img {
        width: 120px;
        height: 120px;
        object-fit: contain;
        margin-bottom: -20px;
      }

      .transport-card .label {
        font-family: "GenSenRounded2TW-R", sans-serif;
        font-size: 1.2rem;
        color: #515F6B;
        text-align: center;
        white-space: nowrap;
        letter-spacing: 6px;
      }

      .transport-card:hover {
        transform: translateY(-2px);
      }
      
      .transport-card.selected {
      -webkit-box-shadow:
      inset -7.5px -4.75px 1px -6.5px rgb(255, 255, 255), 
      inset 7.5px 4.75px 1px -6.5px rgb(255, 255, 255),
      inset -1.75px -7.5px 1px -6.75px rgb(255, 255, 255), 
      inset 1.75px 7.5px 1px -6.75px rgb(255, 255, 255),
      2px 2px 8px 0px rgba(110, 110, 110, 0.275);
      box-shadow:
      inset -7px -4.75px 1px -6.5px rgb(255, 255, 255), 
      inset 7px 4.75px 1px -6.5px rgb(255, 255, 255),
      inset -1.75px -7px 1px -6.75px rgb(255, 255, 255), 
      inset 1.75px 7px 1px -6.75px rgb(255, 255, 255),
      2px 2px 8px 0px rgba(110, 110, 110, 0.275);
      }
      
      .toggle-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.6rem;
      }

      .input-group-MRT .toggle-row input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .add-trip-wrapper .input-group-MRT label {
        margin: 0;
      }

      .add-trip-wrapper .input-group-MRT .toggle-row {
      gap: 4px;
      font-size: 0.85rem;
      }


      .daily-card {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 1.25rem;
      }

      .toggle-card {
        display: flex;
        align-items: center;
        width: 40%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 32px;
        padding: 1rem 1.25rem;
        gap: 0.75rem;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .toggle-card::before {
      content: "";
      position: absolute;
      inset: 0;
      -webkit-box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: -1;
      border-radius: 32px;
      }

      .toggle-card span.label {
        font-family: "GenSenRounded2TW-R", sans-serif;
        color: #9c7a5c;
        line-height: 1.2;
        white-space: nowrap;
      }

      .nowrap-text {
        color: #6c808f;
        white-space: nowrap;
        font-family: "GenSenRounded2TW-L", sans-serif;
        letter-spacing: 6px;
      }

      .template-wrapper {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      width: 40%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 32px;
      padding: 0.75rem 1.25rem 0.5rem 1.25rem;
      gap: 1rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      }

      .template-wrapper::before {
      content: "";
      position: absolute;
      inset: 0;
      -webkit-box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: -1;
      border-radius: 32px;
      }

      .template-row {
        display: flex;
        gap: 32px;
        justify-content: center;
      }

      .fuel-group .input-group {
        display: flex;
        align-items: center;
        padding: 1.25rem 0;
        gap: 0.5rem;
      }
      
      .fuel-group .input-group label {
        font-family: "GenSenRounded2TW-R", sans-serif;
        font-size: 1rem;
        color: #9c7a5c;
        line-height: 1.2;
        white-space: nowrap;
      }

      .fuel-group .input-group input {
        font-family: "GenSenRounded2TW-L", sans-serif;
        width: 90px;
        padding: 0.5rem 0.5rem 0.5rem 0.75rem;
        border: 0.25pt solid #b5c1c623;
        border-radius: 8px;
        box-shadow: inset 2pt 2pt 7pt #6d808f70;
        background: #fff;
        font-size: 16px;
        color: #4a4a4a;
        letter-spacing: 3px;
        outline: none;
      }

      .fuel-group .input-group select {
        font-family: "GenSenRounded2TW-L", sans-serif;
        width: 110px;
        padding: 0.5rem 0.5rem 0.5rem 0.75rem;
        border: 0.25pt solid #b5c1c623;
        border-radius: 8px;
        box-shadow: inset 2pt 2pt 7pt #6d808f70;
        background: #fff;
        font-size: 16px;
        color: #4a4a4a;
        letter-spacing: 3px;
        outline: none;
      }

      #daily-car-type-value {
        width: 140px;
      }

      #daily-bus-fuel-type-value {
        width: 120px;
      }

      .fuel-group .input-group input[type='checkbox'] {
        width: 0;
      }

      .fuel-group .input-group input[type="number"]::-webkit-outer-spin-button,
      .fuel-group .input-group input[type="number"]::-webkit-inner-spin-button,
      .input-group-MRT input[type="number"]::-webkit-outer-spin-button,
      .input-group-MRT input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .fuel-group .input-group .special-label {
      font-family: "GenSenRounded2TW-L", sans-serif;
      font-weight: normal;
      color: #6c808f;
      margin: 0;
      }


      .mrt-trip-list-wrapper .mrt-btn {
        flex: 0 0 auto;
        margin-top: 20px;
      }

      .input-group-MRT {
        display: flex;
        align-items: center;
        flex-direction: row;
        gap: 0.5rem;
      }

      .input-group-MRT label {
        margin: 0.15rem 0.75rem;
        font-size: 0.85rem;
        color: #9c7a5c;
        white-space: nowrap;
        font-family: "GenSenRounded2TW-R", sans-serif;
        letter-spacing: 6px;
      }
      .input-group-MRT .special-label {
        font-family: "GenSenRounded2TW-L", sans-serif;
        font-weight: normal;
        color: #6c808f;
      }

      .input-group-MRT input {
        width: 120px;
        padding: 0.375rem 0.5rem 0.375rem 0.75rem;
        border: 0.25pt solid #b5c1c623;
        border-radius: 6px;
        background: #fff;
        font-size: 16px;
        color: #4a4a4a;
        box-shadow: inset 2pt 2pt 7pt #6d808f70;
        font-family: "GenSenRounded2TW-L", sans-serif;
        letter-spacing: 2px;
        outline: none;
      }

      #mrtTripDisplay {
        display: flex;
        flex-direction: column;
      }

      .mrt-btn {
        width: 50%;
        margin: auto 0 0.25rem;
        align-self: center;
        background: rgba(240, 244, 252, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-radius: 32px;
        font-size: 0.85rem;
        font-weight: bold;
        color: rgba(0, 0, 0, 0.2);
        padding: 6px 12px;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
        font-family: "GenSenRounded2TW-R", sans-serif;
      }

      .mrt-btn:hover {
        background-color: #eee;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }

      .mrt-trip-list-wrapper {
        display: flex;
        flex-direction: column;
        height: 200px;
      }

      .trip-list {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: start;
        align-items: center;
        max-width: 100%;
        min-width: 100%;
        width: 100%;
        max-height: 200px;
        overflow-x: hidden;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      .trip-list::-webkit-scrollbar {
        display: none;
      }
      
      .trip-item {
        font-family: "GenSenRounded2TW-L", sans-serif;
        display: flex;
        justify-content: center;
        text-align: left;
        width: 100%;
        max-width: 400px;
        font-size: 0.85rem;
        letter-spacing: 0.1rem;
        color: #6c808f;
        margin: 0.1rem;
        padding: 0.35rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
        position: relative;
      }

    .trip-item:hover {
      border-color: #3b82f6;
      background-color: #f8fafc;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .trip-item.selected {
      border-color: #10b981;
      background-color: #ecfdf5;
      color: #047857;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    .trip-item.selected:hover {
      border-color: #ef4444;
      background-color: #fef2f2;
      color: #dc2626;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }
    
    .trip-item::before {
      content: '';
      width: 0.75rem;
      height: 0.75rem;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      margin: auto 0.75rem;
      flex-shrink: 0;
      transition: all 0.3s ease;
      position: relative;
      background-color: white;
    }
    
    .trip-item:hover::before {
      border-color: #3b82f6;
    }
    
    .trip-item.selected::before {
      border-color: #10b981;
      background-color: #10b981;
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='m13.854 3.646-7.5 7.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6 10.293l7.146-7.147a.5.5 0 0 1 .708.708z'/%3e%3c/svg%3e");
      background-size: 12px 12px;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .trip-item.selected:hover::before {
      border-color: #ef4444;
      background-color: #ef4444;
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }
    
    .trip-item.selected::after {
      content: '點擊取消選擇';
      position: absolute;
      top: -4px;
      right: 12px;
      background-color: #ef4444;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 10;
    }
    
    .trip-item.selected:hover::after {
      opacity: 1;
      transform: translateY(0);
    }
    
    .trip-item-text {
      flex: 1;
      display: flex;
      justify-content: space-between;
    }

    .selection-info {
      margin: 8px 0;
      padding: 8px 12px;
      background-color: #f1f5f9;
      border-radius: 6px;
      font-size: 12px;
      color: #475569;
      border-left: 3px solid #3b82f6;
    }
    
    .selection-info.has-selection {
      background-color: #ecfdf5;
      border-left-color: #10b981;
      color: #047857;
    }

      .add-trip-wrapper {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      align-content: center;
      flex-direction: column;
      }

      #scene7 .template-wrapper {
        width: 750px;
        max-width: 100%;
        height: 200px;
        justify-content: center;
        overflow-y: auto;
        margin: auto 0;
        align-items: center;
      }
      #scene7 .add-trip-wrapper {
        gap: 12px;
      }

      .input-wrapper {
        position: relative;
        display: inline-block;
      }

      .input-wrapper input::-webkit-calendar-picker-indicator {
        opacity: 0;
      }

      .input-wrapper select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }

      .input-wrapper::after {
        content: "";
        position: absolute;
        right: 0.4em;
        top: 45%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        background-image: url("./images/下拉式箭頭.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        filter: drop-shadow(2px 2px 2px rgb(195, 202, 219));
      }

      @media (min-width: 320px) and (max-width: 600px) {
        .scene-1 .transport-grid {
          grid-template-columns: repeat(2, minmax(80px, 1fr));
          grid-template-rows: repeat(3, minmax(120px, 1fr));
        }
      }

      @media (min-width: 600px) and (max-width: 900px) {
        .scene-1 .transport-grid {
          grid-template-columns: repeat(2, minmax(120px, 1fr));
          grid-template-rows: repeat(3, auto);
        }
      }

      @media (max-width: 600px) {
        .scene-1 .transport-card img {
          width: 80px;
          height: 80px;
        }

        .scene-2 .daily-card .toggle-card {
          flex-direction: column;
          justify-content: center;
          padding: 2rem 1rem;
        }

        .scene-2 .daily-card .toggle-card .input-group, .scene-2 .daily-card .template-wrapper .input-group{
          flex-direction: column;
          padding: 0.5rem;
        }
      }

      @media (max-width: 900px) {
        .scene-2 .daily-card .toggle-card, .scene-2 .daily-card .template-wrapper  {
          width: 80%;
          padding: 1rem;
          justify-content: center;
        }

         .scene-2 .add-trip-wrapper {
          align-items: center;
         }

        .input-group-MRT {
          flex-direction: column;
        }

        .trip-item {
          text-align: center;
        }
    }
    </style>
  </head>

  <body>
    <!-- 故事劇情 -->
    <story-chatroom></story-chatroom>

    <!-- Scene 1: 選車種 -->
    <section id="scene-daily-1" class="scene scene-1">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
      <h1>日常通勤使用的交通工具</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="transport-grid">
          <div class="transport-card" onclick="toggleActivity(this,'汽車')">
            <img src="images/汽車.webp" alt="汽車" />
            <span class="label">汽車</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'機車')">
            <img src="images/機車.webp" alt="機車" />
            <span class="label">機車</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'公車')">
            <img src="images/公車.webp" alt="公車" />
            <span class="label">公車</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'捷運')">
            <img src="images/捷運.webp" alt="捷運" />
            <span class="label">捷運</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'火車')">
            <img src="images/火車.webp" alt="火車" />
            <span class="label">火車</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'高鐵')">
            <img src="images/高鐵.webp" alt="高鐵" />
            <span class="label">高鐵</span>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn"  onclick="window.location.href='index.html'">‹</button>
      <button class="nav-btn next-btn" onclick="handleFirstSceneNext()">›</button>
    </section>

    <!-- Scene 1: 燃料 & 計算方法 -->
    <section id="scene-daily-2-1" class="scene scene-2">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>汽車使用狀況</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="daily-card">
          <!-- 燃料開關 -->
          <div class="toggle-card">
            <span class="label">選擇<br />車種燃料</span>
            <div class="toggle-row">
              <span class="nowrap-text">油車</span>
              <label class="toggle-switch">
                <input type="checkbox" id="daily-car-fuel-type-toggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">電車</span>
            <div>
          </div>
            </div>
          </div>
          <!-- 方法開關 -->
          <div class="toggle-card">
            <span class="label">選擇<br />計算方法</span>
            <div class="toggle-row">
              <span class="nowrap-text">油量</span>
              <label class="toggle-switch">
                <input type="checkbox" id="daily-car-method-toggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">距離</span>
            </div>
          </div>

          <div id="pane-left" class="template-wrapper">
            <div id="oil-left" class="fuel-group">
              <div class="input-group">
                <label>選擇<br />汽油類型</label>
                <div class="input-wrapper">
                  <select id="daily-car-fuel-type-value">
                    <option value="92無鉛">92無鉛</option>
                    <option value="95無鉛">95無鉛</option>
                    <option value="98無鉛">98無鉛</option>
                    <option value="柴油">柴油</option>
                  </select>
                </div>
              </div>
              <div class="input-group">
                <label>每週加油</label>
                <input type="number" min="0" id="daily-car-oil-value" value="0" />
                <div class="toggle-row">
                  <label class="apple-toggle-switch">
                    <span class="nowrap-text">公升​</span>
                    <input type="checkbox" id="oil-unit-toggle" />
                    <span class="slider"></span>
                    <span class="nowrap-text">元​</span>
                  </label>
                </div>
              </div>
            </div>
            <div id="electric-left" class="fuel-group hidden">
              <div class="input-group">
                <label>外出充電</label>
                <input type="number" min="0" id="daily-EV-charge-value" value="0"/>
                <label class="special-label">度/週</label>
              </div>
            </div>
          </div>

          <div id="pane-right" class="template-wrapper inactive">
            <div id="oil-right" class="fuel-group">
              <div class="input-group">
                <label>選擇<br />汽車類型</label>
                <div class="input-wrapper">
                  <select id="daily-car-type-value">
                    <option value="小型房車">小型房車</option>
                    <option value="中型房車">中型房車</option>
                    <option value="大型房車">大型房車</option>
                    <option value="小型休旅車">小型休旅車</option>
                    <option value="中型休旅車">中型休旅車</option>
                    <option value="大型休旅車">大型休旅車</option>
                  </select>
                </div>
                <datalist id="carList"></datalist>
              </div>
              <div class="input-group">
                <label>每週行駛</label>
                <input type="number" min="0" id="daily-oilcar-distance-value" value="0"/>
                <label class="special-label">公里/週</label>
              </div>
            </div>
            <div id="electric-right" class="fuel-group hidden">
              <div class="input-group">
                <label>行駛里程</label>
                <input type="number" min="0" id="daily-EV-distance-value" value="0"/>
                <label class="special-label">公里/週</label>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>

      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>
    <!-- Scene 2: 燃料 & 計算方法（機車） -->
    <section id="scene-daily-2-2" class="scene scene-2">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>機車使用情況</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="daily-card">
          <!-- 燃料開關 -->
          <div class="toggle-card">
            <span class="label">選擇<br />車種燃料</span>
            <div class="toggle-row">
              <span class="nowrap-text">油車</span>
              <label class="toggle-switch">
                <input type="checkbox" id="daily-motorcycle-fuel-type-toggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">電車</span>
            </div>
          </div>

          <!-- 方法開關 -->
          <div class="toggle-card">
            <span class="label">選擇<br />計算方法</span>
            <div class="toggle-row">
              <span class="nowrap-text">油量</span>
              <label class="toggle-switch">
                <input type="checkbox" id="daily-motorcycle-method-toggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">距離</span>
            </div>
          </div>

          <div id="pane-left4" class="template-wrapper">
            <div id="oil-left4" class="fuel-group">
              <div class="input-group">
                <label>選擇<br />汽油類型</label>
                <div class="input-wrapper">
                  <select id="daily-motorcycle-fuel-type-value">
                    <option value="92無鉛">92無鉛</option>
                    <option value="95無鉛">95無鉛</option>
                    <option value="98無鉛">98無鉛</option>
                    <option value="柴油">柴油</option>
                  </select>
                </div>
              </div>
              <div class="input-group">
                <label>每週加油</label>
                <input type="number" min="0" id="daily-motorcycle-oil-value" value="0"/>
                <div class="toggle-row">
                  <label class="apple-toggle-switch">
                    <span class="nowrap-text">公升​</span>
                    <input type="checkbox" id="water-unit-toggle" />
                    <span class="slider"></span>
                    <span class="nowrap-text">元​</span>
                  </label>
                </div>
              </div>
            </div>
            <div id="electric-left4" class="fuel-group hidden">
              <div class="input-group">
                <label>外出充電</label>
                <input type="number" min="0" id="daily-electricmotorcycle-charge-value" value="0"/>
                <label class="special-label">度/週</label>
              </div>
            </div>
          </div>

          <div id="pane-right4" class="template-wrapper inactive">
            <div id="oil-right4" class="fuel-group">
              <div class="input-group">
                <label>每週行駛</label>
                <input type="number" min="0" id="daily-oilmotorcycle-distance-value" value="0"/>
                <label class="special-label">公里/週</label>
              </div>
            </div>
            <div id="electric-right4" class="fuel-group hidden">
              <div class="input-group">
                <label>行駛里程</label>
                <input type="number" min="0" id="daily-electricmotorcycle-distance-value" value="0"/>
                <label class="special-label">公里/週</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 3: 公車使用情況 -->
    <section id="scene-daily-2-3" class="scene scene-2">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>公車使用情況</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="daily-card">
          <div class="template-wrapper">
            <div class="input-group-MRT fuel-group">
              <div class="input-group">
                <label>選擇<br />能源類型</label>
                <div class="input-wrapper">
                  <select id="daily-bus-fuel-type-value">
                    <option value="燃油公車">燃油公車</option>
                    <option value="電動公車">電動公車</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="template-wrapper">
            <div class="input-group-MRT">
              <label for="daily-bus-distance-value" style="font-size: 1rem;">每周搭乘</label>
              <input id="daily-bus-distance-value" type="number" min="0" value="0"/>
              <label style="font-family: GenSenRounded2TW-L, sans-serif; font-size: 1rem ;color: #6c808f">公里</label>
            </div>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 4: 捷運使用情況 -->
    <section id="scene-daily-2-4" class="scene scene-2">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>捷運使用情況</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="daily-card" data-type="mrt">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="mrtStart">選擇起點</label>
              <div class="input-wrapper">
                <input list="mrtStationListStart" id="mrtStart" />
              </div>
              <datalist id="mrtStationListStart"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="mrtEnd">選擇訖點</label>
              <div class="input-wrapper">
                <input list="mrtStationListEnd" id="mrtEnd" />
              </div>
              <datalist id="mrtStationListEnd"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="mrtCount">每月趟數</label>
              <input id="mrtCount" type="number" min="1" max="99"/>
              <div class="toggle-row">
                <label class="apple-toggle-switch">
                  <span class="nowrap-text">單程</span>
                  <input type="checkbox" id="dailyMrtRoundTripToggle" />
                  <span class="slider"></span>
                  <span class="nowrap-text">來回</span>
                </label>
              </div>
            </div>
            <button class="mrt-btn" onclick="addMRTTrip()">新增行程</button>
          </div>

          <!-- 這裡一定要加上 id="mrtTripDisplay" -->
          <div class="template-wrapper mrt-trip-list-wrapper" id="mrtTripDisplay">
            <div class="trip-list"><!-- 這裡會塞 trip-item --></div>
            <button class="mrt-btn" onclick="removeMRTTrip()">刪除行程</button>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 5: 火車使用情況 -->
    <section id="scene-daily-2-5" class="scene scene-2">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>火車使用情況</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="daily-card" data-type="train">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="trStart">選擇起點</label>
              <div class="input-wrapper">
                <input list="trStationListStart" id="trainStart" />       
              </div>
              <datalist id="trStationListStart"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="trEnd">選擇訖點</label>
              <div class="input-wrapper">
                <input list="trStationListEnd" id="trainEnd" />
              </div>
              <datalist id="trStationListEnd"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="trainCount">每月趟數</label>
              <input id="trainCount" type="number" min="1" />
              <div class="toggle-row">
                <label class="apple-toggle-switch">
                  <span class="nowrap-text">單程</span>
                  <input type="checkbox" id="dailyTrainRoundTripToggle" />
                  <span class="slider"></span>
                  <span class="nowrap-text">來回</span>
                </label>
              </div>
            </div>
            <button class="mrt-btn" onclick="addTrainTrip()">新增行程</button>
          </div>
          <div class="template-wrapper mrt-trip-list-wrapper" id="trainTripList">
            <div class="trip-list" ></div>
            <button class="mrt-btn" onclick="removeTrainTrip()">刪除行程</button>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">›</button>
    </section>

    <!-- Scene 6: 高鐵使用情況 -->
    <section id="scene-daily-2-6" class="scene scene-2">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>高鐵使用情況</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="daily-card" data-type="hsr">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="hsrStart">選擇起點</label>
              <div class="input-wrapper">
                <input list="hsrStationListStart" id="hsrStart" />       
              </div>
              <datalist id="hsrStationListStart"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="hsrEnd">選擇訖點</label>
              <div class="input-wrapper">
                <input list="hsrStationListEnd" id="hsrEnd" />
              </div>
              <datalist id="hsrStationListEnd"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="hsrCount">每月趟數</label>
              <input id="hsrCount" type="number" min="1" />
              <div class="toggle-row">
                <label class="apple-toggle-switch">
                  <span class="nowrap-text">單程</span>
                  <input type="checkbox" id="dailyHsrRoundTripToggle" />
                  <span class="slider"></span>
                  <span class="nowrap-text">來回</span>
                </label>
              </div>
            </div>
            <button class="mrt-btn" onclick="addHsrTrip()">新增行程</button>
          </div>
          <div class="template-wrapper mrt-trip-list-wrapper" id="hsrTripList">
            <div class="trip-list" ></div>
            <button class="mrt-btn" onclick="removeHsrTrip()">刪除行程</button>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">‹</button>
      <button class="nav-btn next-btn nnn" onclick="goToNextScene()">›</button>
    </section>

    <div id="page-loader" class="loader-overlay" style="display:none;">
      <div class="loader"></div>
    </div>

    <script src="./js/all.js"></script>
    <script type="module">
      import { saveSectionData, loadSectionData } from './js/firebase.js';
      import { functions, httpsCallable } from './js/firebase.js';

      // 頁面載入時回填
      window.addEventListener('DOMContentLoaded', async () => {
        try {
          const data = await loadSectionData('traffic-daily');
          if (data) {
            // 汽車
            document.getElementById("daily-car-fuel-type-toggle").checked = data.dailyCarFuelTypeToggle ?? false;
            document.getElementById("daily-car-method-toggle").checked = data.dailyCarMethodToggle ?? false;

            // 油車
            document.getElementById("daily-car-fuel-type-value").value = data.dailyCarFuelTypeValue ?? "92無鉛";
            document.getElementById("daily-car-oil-value").value = data.dailyCarOilValue ?? 0;
            document.getElementById("oil-unit-toggle").checked = data.oilUnitToggle ?? false;
            document.getElementById("daily-oilcar-distance-value").value = data.dailyOilcarDistanceValue ?? 0;
            document.getElementById("daily-car-type-value").value = data.dailyCarTypeValue ?? "小型房車";

            // 電車 
            document.getElementById("daily-EV-distance-value").value = data.dailyEVDistanceValue ?? 0;
            document.getElementById("daily-EV-charge-value").value = data.dailyEVChargeValue ?? 0;

            // 機車 
            document.getElementById("daily-motorcycle-fuel-type-toggle").checked = data.dailyMotorcycleFuelTypeToggle ?? false;
            document.getElementById("daily-motorcycle-method-toggle").checked = data.dailyMotorcycleMethodToggle ?? false;

            // 汽油機車
            document.getElementById("daily-motorcycle-fuel-type-value").value = data.dailyMotorcycleFuelTypeValue ?? "92無鉛";
            document.getElementById("daily-motorcycle-oil-value").value = data.dailyMotorcycleOilValue ?? 0;
            document.getElementById("daily-oilmotorcycle-distance-value").value = data.dailyOilmotorcycleDistanceValue ?? 0;

            // 電動機車 
            document.getElementById("daily-electricmotorcycle-distance-value").value = data.dailyElectricmotorcycleDistanceValue ?? 0;
            document.getElementById("daily-electricmotorcycle-charge-value").value = data.dailyElectricmotorcycleChargeValue ?? 0

            // 公車
            document.getElementById("daily-bus-fuel-type-value").value = data.dailyBusFuelTypeValue ?? "燃油公車"
            document.getElementById("daily-bus-distance-value").value = data.dailyBusDistanceValue ?? 0;
          }
        } catch (err) {
          console.error("載入資料失敗：", err);
        }
      });

function getUserId() {
  let userId = localStorage.getItem("userId");
  if (!userId) {
    userId = `user_${Date.now()}`;
    localStorage.setItem("userId", userId);
  }
  return userId;
}

async function calculate() {
  const userId = getUserId();

  // 檢查當前儲存的資料
  try {
    const currentData = await loadSectionData('traffic-daily');
  } catch (err) {
    console.log("載入資料失敗:", err);
  }

  try {
    
    const calculateFunction = httpsCallable(functions, "calculateCarbonPage");
    
    const requestData = {
      userId: userId,
      pageName: "traffic-daily"
    };
    
    const result = await calculateFunction(requestData);
    
    if (result.data && result.data.total !== undefined) {
      const total = result.data.total;

      const resultElement = document.getElementById("calculation-result");
      if (resultElement) {
        resultElement.innerHTML = `
          <h3>計算結果</h3>
          <p>碳排放量: <strong>${total.toFixed(2)} kg CO2e</strong></p>
          <p>計算時間: ${new Date().toLocaleString()}</p>
        `;
      }
    } else {
      alert("計算完成，但回應格式異常");
    }
    
  } catch (err) {
    console.error("完整錯誤物件:", err);
    console.error("錯誤訊息:", err.message);
    console.error("錯誤代碼:", err.code);
    console.error("錯誤詳細資訊:", err.details);
    
    let errorMessage = "計算失敗，請稍後再試";
    if (err.message) {
      errorMessage += `\n錯誤訊息: ${err.message}`;
    }
    
    alert(errorMessage);
  }
}

    document.querySelectorAll(".next-btn").forEach(btn => {
      btn.addEventListener("click", calculate);
    });
    document.querySelectorAll(".chapter-button").forEach(btn => {
      btn.addEventListener("click", calculate);
    });

      // 儲存資料並跳轉
      // 檢查是否為最後一個選擇的交通工具場景
      function isLastSelectedScene() {
        const lastActivity = selectedActivities[selectedActivities.length - 1];
        return currentScene === activityScenes[lastActivity];
      }

      async function handleNext() {
        // 加總三種交通方式行程距離
      const mrtDistanceSum = sumTripDistance(mrtDistanceMap, "#mrtTripDisplay", "pair");
      const trainDistanceSum = sumTripDistance(trDistanceMap, "#trainTripList", "single");
      const hsrDistanceSum = sumTripDistance(hsrDistanceMap, "#hsrTripList", "pair");
              
        const data = {
          // 汽車
          dailyCarFuelTypeToggle: document.getElementById("daily-car-fuel-type-toggle")?.checked ?? false,
          dailyCarMethodToggle: document.getElementById("daily-car-method-toggle")?.checked ?? false,
          
          // 油車
          dailyCarFuelTypeValue: document.getElementById("daily-car-fuel-type-value")?.value ?? "92無鉛",
          dailyCarOilValue: parseFloat(document.getElementById("daily-car-oil-value")?.value || 0),
          oilUnitToggle: document.getElementById("oil-unit-toggle")?.checked ?? false,
          dailyOilcarDistanceValue: parseFloat(document.getElementById("daily-oilcar-distance-value")?.value || 0),
          dailyCarTypeValue: document.getElementById("daily-car-type-value")?.value ?? "小型房車",

          // 電車 
          dailyEVDistanceValue: parseFloat(document.getElementById("daily-EV-distance-value")?.value || 0),
          dailyEVChargeValue: parseFloat(document.getElementById("daily-EV-charge-value")?.value || 0),

          // 機車 
          dailyMotorcycleFuelTypeToggle: document.getElementById("daily-motorcycle-fuel-type-toggle")?.checked ?? false,
          dailyMotorcycleMethodToggle: document.getElementById("daily-motorcycle-method-toggle")?.checked ?? false,

          // 汽油機車
          dailyMotorcycleFuelTypeValue: document.getElementById("daily-motorcycle-fuel-type-value")?.value ?? "92無鉛",
          dailyMotorcycleOilValue: parseFloat(document.getElementById("daily-motorcycle-oil-value")?.value || 0),
          dailyOilmotorcycleDistanceValue: parseFloat(document.getElementById("daily-oilmotorcycle-distance-value")?.value || 0),

          // 電動機車 
          dailyElectricmotorcycleDistanceValue: parseFloat(document.getElementById("daily-electricmotorcycle-distance-value")?.value || 0),
          dailyElectricmotorcycleChargeValue: parseFloat(document.getElementById("daily-electricmotorcycle-charge-value")?.value || 0),

          // 公車
          dailyBusDistanceValue: parseFloat(document.getElementById("daily-bus-distance-value")?.value || 0),
          dailyBusFuelTypeValue: document.getElementById("daily-bus-fuel-type-value")?.value ?? "燃油公車",

          //捷運 火車 高鐵總距離
          dailyMRTDistanceTotal: mrtDistanceSum,
          dailyTrainDistanceTotal: trainDistanceSum,
          dailyHSRDistanceTotal: hsrDistanceSum,
        };

        try {
          await saveSectionData('traffic-daily', data);
        } catch (err) {
          alert("資料儲存失敗，請稍後再試。");
        }
      }
    
    document.querySelectorAll(".next-btn").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    document.querySelectorAll(".prev-btn").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    document.querySelectorAll(".chapter-button").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    </script>
    <script>
      const messages = [
        {
          type: "time",
          text: "上午 9:30",
          time: 1000,
        },
        {
          text: "我們現在在哪裡？發生了什麼事！",
          from: "user",
          time: 2000,
        },
        {
          text: "我們回到了19世紀初，也就是第一次工業革命的時代。你有沒有聽見？是蒸汽機轟隆轟隆的聲音！",
          from: "cat",
          time: 1500,
        },
        {
          text: "蒸汽機的改良徹底改變了人類社會！燒煤產生蒸汽，蒸汽推動機器，機器拉著人到處跑。",
          from: "cat",
          time: 2500,
        },
        {
          text: "所以這就是我們每天通勤的起點？",
          from: "user",
          time: 1700,
        },
        {
          text: "Bingo！",
          from: "cat",
        },
        {
          text: "交通變快，城市密集，朝九晚五成為日常。自此，碳排悄悄的跟上了科技進步的偉大航道。",
          from: "cat",
        },
        {
          text: "原來~從燒煤開始，人類正式踏入了大排碳時代！",
          from: "user",
        },
      ];

        let currentScene = "scene-daily-1";

        async function goToNextScene() {
          // 取得目前場景在使用者選取活動中的位置
          const currentIndex = selectedActivities.findIndex(
            (activity) => activityScenes[activity] === currentScene
          );

          // 是最後一個場景 → 導向結果頁
          if (currentIndex === selectedActivities.length - 1) {
            window.location.href = "home.html";
            return;
          }

          // 還有下一頁 → 取得下一個活動的 sceneId，跳轉
          const nextActivity = selectedActivities[currentIndex + 1];
          const nextSceneId = activityScenes[nextActivity];
          if (nextSceneId) {
            goToScene(nextSceneId);
          }
        }

        function goToPrevScene() {
          const currentIndex = selectedActivities.findIndex(
            (activity) => activityScenes[activity] === currentScene
          );

          // 是第一個選擇的活動 → 回到 scene-daily-1
          if (currentIndex === 0) {
            goToScene("scene-daily-1");
            return;
          }

          // 還有上一頁 → 跳到上一個活動頁面
          const prevActivity = selectedActivities[currentIndex - 1];
          const prevSceneId = activityScenes[prevActivity];
          if (prevSceneId) {
            goToScene(prevSceneId);
          }
        }

        function handleFirstSceneNext() {
          const fullOrder = [
            "汽車",
            "機車",
            "公車",
            "捷運",
            "火車",
            "高鐵",
          ];

          const sortedActivities = fullOrder.filter((activity) =>
            selectedActivities.includes(activity)
          );

          selectedActivities.length = 0;
          selectedActivities.push(...sortedActivities);

          if (selectedActivities.length === 0) {
            alert("請至少選擇一個交通工具！");
            return;
          }

          const firstScene = activityScenes[selectedActivities[0]];
          goToScene(firstScene);
        }

        const selectedActivities = []; // 儲存選取的項目
        const activityScenes = {
          汽車: "scene-daily-2-1",
          機車: "scene-daily-2-2",
          公車: "scene-daily-2-3",
          捷運: "scene-daily-2-4",
          火車: "scene-daily-2-5",
          高鐵: "scene-daily-2-6",
        };

        function toggleActivity(card, activity) {
          const index = selectedActivities.indexOf(activity);

          if (index === -1) {
            selectedActivities.push(activity);
            card.classList.add("selected");
          } else {
            selectedActivities.splice(index, 1);
            card.classList.remove("selected");
          }

          updatePageIndicators();
        }

        // bar跳轉頁面

        function goToScene(targetId) {
          document.getElementById(currentScene).classList.remove("active");
          document.getElementById(targetId).classList.add("active");
          currentScene = targetId;
          updatePageIndicators();
          updateNavButtonsVisibility();
        }

      function updatePageIndicators() {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");

        if (!container) return;
        container.innerHTML = "";

        const selectHitArea = document.createElement("div");
        selectHitArea.classList.add("bar-hit-area");

        const selectBar = document.createElement("span");
        selectBar.classList.add("bar");

        if (currentScene === "scene-daily-1") {
          selectBar.classList.add("active");
        }

        selectHitArea.appendChild(selectBar);
        selectHitArea.onclick = () => {
          goToScene("scene-daily-1");
          updateBarActive(0);
        };
        container.appendChild(selectHitArea);

        selectedActivities.forEach((activity, idx) => {
          const sceneId = activityScenes[activity];
          if (!sceneId) return;

          const hitArea = document.createElement("div");
          hitArea.classList.add("bar-hit-area");

          const bar = document.createElement("span");
          bar.classList.add("bar");

          if (currentScene === sceneId) {
            bar.classList.add("active");
          }

          hitArea.appendChild(bar);

          hitArea.onclick = () => {
            goToScene(sceneId);
            updateBarActive(idx + 1);
          };

          container.appendChild(hitArea);
        });
      }

      function updateNavButtonsVisibility() {
        const sceneEl = document.getElementById(currentScene);

        const prevBtn = sceneEl.querySelector(".prev-btn");
        const nextBtn = sceneEl.querySelector(".next-btn");

        document.querySelectorAll(".prev-btn, .next-btn").forEach(btn => {
          btn.style.display = "none";
        });

        if (prevBtn) prevBtn.style.display = "block";
        if (nextBtn) nextBtn.style.display = "block";
      }


      function updateBarActive(activeIndex) {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");
        if (!container) return;

        const bars = container.querySelectorAll(".bar-hit-area .bar");
        bars.forEach((bar, idx) => {
          if (idx === activeIndex) {
            bar.classList.add("active");
          } else {
            bar.classList.remove("active");
          }
        });
      }

      function goToScene(targetId) {
        document.getElementById(currentScene).classList.remove("active");
        document.getElementById(targetId).classList.add("active");
        currentScene = targetId;
        updatePageIndicators();
        updateNavButtonsVisibility();
      }

      function updateNavButtonsVisibility() {
        const sceneEl = document.getElementById(currentScene);

        const prevBtn = sceneEl.querySelector(".prev-btn");
        const nextBtn = sceneEl.querySelector(".next-btn");

        document.querySelectorAll(".prev-btn, .next-btn").forEach((btn) => {
          btn.style.display = "none";
        });

        if (prevBtn) prevBtn.style.display = "block";
        if (nextBtn) nextBtn.style.display = "block";
      }

      function updatePageIndicators() {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");

        if (!container) return;
        container.innerHTML = "";

        const selectHitArea = document.createElement("div");
        selectHitArea.classList.add("bar-hit-area");

        const selectBar = document.createElement("span");
        selectBar.classList.add("bar");

        if (currentScene === "scene-daily-1") {
          selectBar.classList.add("active");
        }

        selectHitArea.appendChild(selectBar);
        selectHitArea.onclick = () => {
          goToScene("scene-daily-1");
          updateBarActive(0);
        };
        container.appendChild(selectHitArea);
        selectedActivities.forEach((activity, idx) => {
          const sceneId = activityScenes[activity];
          if (!sceneId) return;

          const hitArea = document.createElement("div");
          hitArea.classList.add("bar-hit-area");

          const bar = document.createElement("span");
          bar.classList.add("bar");

          if (currentScene === sceneId) {
            bar.classList.add("active");
          }

          hitArea.appendChild(bar);

          hitArea.onclick = () => {
            goToScene(sceneId);
            updateBarActive(idx + 1);
          };

          container.appendChild(hitArea);
        });
      }

      function updateBarActive(activeIndex) {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");
        if (!container) return;

        const bars = container.querySelectorAll(".bar-hit-area .bar");
        bars.forEach((bar, idx) => {
          bar.classList.toggle("active", idx === activeIndex);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        currentScene = "scene-daily-1";
        updatePageIndicators();
        updateNavButtonsVisibility();
      });

// 汽車 & 機車：燃料切換 & 方法切換

function setupToggle(fuelId, methodId, oilLeftId, oilRightId, elecLeftId, elecRightId, paneLeftId, paneRightId) {
    const fuelToggle   = document.getElementById(fuelId);
    const methodToggle = document.getElementById(methodId);
    const oilLeft      = document.getElementById(oilLeftId);
    const oilRight     = document.getElementById(oilRightId);
    const elecLeft     = document.getElementById(elecLeftId);
    const elecRight    = document.getElementById(elecRightId);
    const paneLeft     = document.getElementById(paneLeftId);
    const paneRight    = document.getElementById(paneRightId);

    let methodLeftSpan = null;
    if (methodToggle) {
        const methodToggleCard = methodToggle.closest('.toggle-card');
        if (methodToggleCard) {
            methodLeftSpan = methodToggleCard.querySelector('.toggle-row .nowrap-text:first-child');
        }
    }

    function updateFuel() {
        const isElec = fuelToggle.checked;
        
        if (oilLeft) oilLeft.classList.toggle("hidden", isElec);
        if (oilRight) oilRight.classList.toggle("hidden", isElec);
        if (elecLeft) elecLeft.classList.toggle("hidden", !isElec);
        if (elecRight) elecRight.classList.toggle("hidden", !isElec);
        
        if (methodLeftSpan) {
            methodLeftSpan.textContent = isElec ? '電量' : '油量';
        }
    }
    
    function updateMethod() {
        const isVol = methodToggle.checked;
        
        if (paneLeft) paneLeft.classList.toggle("inactive", isVol);
        if (paneRight) paneRight.classList.toggle("inactive", !isVol);
    }
    
    if (fuelToggle && methodToggle) {
        fuelToggle.addEventListener("change", () => { 
            updateFuel(); 
            updateMethod(); 
        });
        methodToggle.addEventListener("change", updateMethod);
        
        updateFuel();
        updateMethod();
    }
}

// 距離資料容器
mrtDistanceMap = {}, trDistanceMap = {}, hsrDistanceMap = {};

document.addEventListener("DOMContentLoaded", () => {
  setupToggle("daily-car-fuel-type-toggle", "daily-car-method-toggle", "oil-left", "oil-right", "electric-left", "electric-right", "pane-left", "pane-right");
  setupToggle("daily-motorcycle-fuel-type-toggle", "daily-motorcycle-method-toggle", "oil-left4", "oil-right4", "electric-left4", "electric-right4", "pane-left4", "pane-right4");

// 優化的捷運、火車、高鐵站名搜索功能

// 通用的選項更新函數
function updateOptionsForDatalist(stationsArray, datalistId, searchTerm = '') {
    const dl = document.getElementById(datalistId);
    if (!dl) return;
    
    dl.innerHTML = '';
    
    let matchingStations = stationsArray;
    
    if (searchTerm.trim()) {
        // 分類匹配的站名
        const startsWithMatch = [];
        const containsMatch = [];
        
        stationsArray.forEach(station => {
            if (station.startsWith(searchTerm)) {
                startsWithMatch.push(station);
            } else if (station.includes(searchTerm)) {
                containsMatch.push(station);
            }
        });
        
        // 合併結果：優先顯示開頭匹配的
        matchingStations = [...startsWithMatch.sort(), ...containsMatch.sort()];
    } else {
        matchingStations = stationsArray.sort();
    }
    
    matchingStations.forEach(st => {
        const option = document.createElement("option");
        option.value = st;
        dl.appendChild(option);
    });
}

// 捷運數據載入與搜索功能
fetch("./data/mrtDistanceMap.json").then(r => r.json()).then(data => {
    mrtDistanceMap = data;
    
    const allStations = new Set(Object.keys(data).flatMap(k => k.split("_")));
    const stationsArray = Array.from(allStations);
    
    const mrtDatalistIds = ['mrtStationListStart', 'mrtStationListEnd'];

    mrtDatalistIds.forEach(datalistId => {
        updateOptionsForDatalist(stationsArray, datalistId);

        const input = document.querySelector(`input[list="${datalistId}"]`);
        if (input) {
            input.addEventListener('input', (e) => {
                updateOptionsForDatalist(stationsArray, datalistId, e.target.value);
            });
            
            input.addEventListener('focus', (e) => {
                if (!e.target.value.trim()) {
                    updateOptionsForDatalist(stationsArray, datalistId);
                }
            });
        }
    });
    
}).catch(err => console.log("MRT data not loaded:", err));

// 火車數據載入與搜索功能
fetch("./data/trDistanceMap.json").then(r => r.json()).then(data => {
    trDistanceMap = data;

    const stations = new Set();
    if (typeof data === 'object') {
        Object.keys(data).forEach(key => {
            stations.add(key);
            if (typeof data[key] === 'object') {
                Object.keys(data[key]).forEach(subKey => stations.add(subKey));
            }
        });
    }
    
    const stationsArray = Array.from(stations);

    const trDatalistIds = ['trStationListStart', 'trStationListEnd'];

    trDatalistIds.forEach(datalistId => {
        updateOptionsForDatalist(stationsArray, datalistId);

        const input = document.querySelector(`input[list="${datalistId}"]`);
        if (input) {
            input.addEventListener('input', (e) => {
                updateOptionsForDatalist(stationsArray, datalistId, e.target.value);
            });
            
            input.addEventListener('focus', (e) => {
                if (!e.target.value.trim()) {
                    updateOptionsForDatalist(stationsArray, datalistId);
                }
            });
        }
    });
    
}).catch(err => console.log("Train data not loaded:", err));

// 高鐵數據載入與搜索功能
fetch("./data/hsrDistanceMap.json").then(r => r.json()).then(data => {
    hsrDistanceMap = data;

    const allStations = new Set(Object.keys(data).flatMap(k => k.split("_")));
    const stationsArray = Array.from(allStations);

    const hsrDatalistIds = ['hsrStationListStart', 'hsrStationListEnd'];

    hsrDatalistIds.forEach(datalistId => {
        updateOptionsForDatalist(stationsArray, datalistId);

        const input = document.querySelector(`input[list="${datalistId}"]`);
        if (input) {
            input.addEventListener('input', (e) => {
                updateOptionsForDatalist(stationsArray, datalistId, e.target.value);
            });
            
            input.addEventListener('focus', (e) => {
                if (!e.target.value.trim()) {
                    updateOptionsForDatalist(stationsArray, datalistId);
                }
            });
        }
    });
    
}).catch(err => console.log("HSR data not loaded:", err));

setupTripListSelection();
});

// ===== 更新選取資訊 =====
function updateSelectionInfo(container) {
  // 移除選取資訊顯示功能，僅保留函數結構以維持兼容性
}

function setupTripListSelection() {
  const tripContainers = [
    "#mrtTripDisplay .trip-list", 
    "#trainTripList",
    "#hsrTripList"
  ];

  tripContainers.forEach(selector => {
    const container = document.querySelector(selector);
    if (container && !container.hasAttribute('data-selection-setup')) {
      container.addEventListener("click", e => {
        const item = e.target.closest(".trip-item");
        if (!item) return;
        
        e.stopPropagation();
        e.preventDefault();
        
        item.classList.toggle("selected");
      });
      
      container.setAttribute('data-selection-setup', 'true');
    }
  });
}

function makeSelectable(item) {
  item.classList.add("trip-item");
  
  item.style.cursor = "pointer";
  item.style.userSelect = "none";
  
  return item;
}

// ===== 通用行程新增函數 =====
function addTrip({ map, startId, endId, countId, displaySelector, distanceType = "pair", roundTripToggleId = null }) {
  const s = document.getElementById(startId).value.trim();
  const e = document.getElementById(endId).value.trim();
  const c = parseInt(document.getElementById(countId).value, 10) || 0;

  if (!s || !e || c <= 0 || s == e) return alert("請填寫完整的起訖點並輸入趟數");

  let dist;

  if (distanceType === "pair") {

    dist = map[`${s}_${e}`] ?? map[`${e}_${s}`];
  } else if (distanceType === "difference") {
    if (map[s] === undefined || map[e] === undefined) {
      const notFound = [s, e].filter(x => map[x] === undefined).join("、");
      return alert(`找不到車站: ${notFound}`);
    }
    dist = Math.abs(map[s] - map[e]);
  }

  if (dist === undefined) return alert("無法找到此起訖點的距離");

  // 檢查是否為來回行程
  const isRound = roundTripToggleId ? document.getElementById(roundTripToggleId).checked : false;
  const type = isRound ? "來回" : "單程";
  
  const item = document.createElement("div");
  item.className = "trip-item";
  item.dataset.start = s;
  item.dataset.end = e;
  item.dataset.count = c;
  item.dataset.dist = dist;
  item.dataset.isRound = isRound;

  item.innerHTML = `<span class="trip-item-text"><span class="trip-item-text-left">${s} → ${e}</span> <span class="trip-item-text-right">${c}趟 ${type}</span></span>`;
  makeSelectable(item);

  const list = document.querySelector(`${displaySelector} .trip-list`);
  list.appendChild(item);

  document.getElementById(startId).value = "";
  document.getElementById(endId).value = "";
  document.getElementById(countId).value = "";
}

// ===== 通用刪除函數 =====
function deleteTrip(displaySelector) {
  const list = document.querySelector(`${displaySelector} .trip-list`);
  if (!list) return alert("找不到行程列表");

  const selected = list.querySelectorAll(".trip-item.selected");
  if (selected.length > 0) {
    selected.forEach(item => item.remove());
  } else {
    const last = list.querySelector(".trip-item:last-child");
    if (last) last.remove();
    else alert("沒有行程可刪除");
  }
}

// ===== 捷運功能 =====
function addMRTTrip() {
  addTrip({
    map: mrtDistanceMap,
    startId: "mrtStart",
    endId: "mrtEnd",
    countId: "mrtCount",
    displaySelector: "#mrtTripDisplay",
    distanceType: "pair",
    roundTripToggleId: "dailyMrtRoundTripToggle"
  });
}
function removeMRTTrip() {
  deleteTrip("#mrtTripDisplay");
}

// ===== 火車功能 =====
function addTrainTrip() {
  addTrip({
    map: trDistanceMap,
    startId: "trainStart",
    endId: "trainEnd",
    countId: "trainCount",
    displaySelector: "#trainTripList",
    distanceType: "difference",
    roundTripToggleId: "dailyTrainRoundTripToggle"
  });
}
function removeTrainTrip() {
  deleteTrip("#trainTripList");
}

// ===== 高鐵功能 =====
function addHsrTrip() {
  addTrip({
    map: hsrDistanceMap,
    startId: "hsrStart",
    endId: "hsrEnd",
    countId: "hsrCount",
    displaySelector: "#hsrTripList",
    distanceType: "pair",
    roundTripToggleId: "dailyHsrRoundTripToggle"
  });
}
function removeHsrTrip() {
  deleteTrip("#hsrTripList");
}
function sumTripDistance(map, containerSelector, type = "pair") {
  const container = document.querySelector(containerSelector);
  if (!container) {
    return 0;
  }

  const list = container.querySelector(".trip-list");
  if (!list) {
    return 0;
  }

  let total = 0;

  list.querySelectorAll(".trip-item").forEach(item => {
    const text = item.innerText.replace(/\s+/g, ' ').trim();

    const match = text.match(/^(.+?) → (.+?) (\d+)趟 (來回|單程)$/);
    if (!match) return;

    const [_, start, end, countStr, tripType] = match;
    const count = parseInt(countStr);

    if (type === "pair") {
      const key = `${start}_${end}`;
      const reverseKey = `${end}_${start}`;
      const dist = map[key] ?? map[reverseKey];

      if (dist != null) {
        let distance = dist * count;
        if (tripType === "來回") {
          distance *= 2;
        }
        total += distance;
      } else {
        segmentDistance *= 1;
      }

    } else if (type === "single") {
      const startDist = map[start];
      const endDist = map[end];

      if (startDist != null && endDist != null) {
        let segmentDistance = Math.abs(endDist - startDist) * count;
        if (tripType === "來回") {
          segmentDistance *= 2;
        }
        total += segmentDistance;
      } else {
        segmentDistance *= 1;
      }
    }
  });

  return total;
}

const allInputs = document.querySelectorAll('input');

allInputs.forEach(input => {
  input.addEventListener('focus', () => {
    if(input.value !=="")
    input.placeholder = '';
  });
});

document.querySelectorAll(".daily-card").forEach(card => {
  const type = card.dataset.type;

  card.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (type === "mrt") {
        addMRTTrip();
      } else if (type === "train") {
        addTrainTrip();
      } else if (type === "hsr") {ㄋㄠ
        addHsrTrip();
      }
    }
  });
});

function bindNumberLimit(inputId) {
  const el = document.getElementById(inputId);

  el.addEventListener('input', () => {
    let val = el.value;

    val = val.replace(/\D/g, '');

    if (val.length > 2) {
      val = val.slice(0, 2);
    }

    if (val === '') {
      el.value = '';
      return;
    }

    let num = parseInt(val, 10);
    if (num < 1) num = 1;
    if (num > 99) num = 99;

    el.value = num;
  });
}

['mrtCount', 'trainCount', 'hsrCount'].forEach(bindNumberLimit);

    </script>
  </body>
</html>
