<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ—…éŠäº¤é€š</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/all.css" />
    <link rel="stylesheet" href="css/story.css" />
    <style>

      input[list="trDistanceMap"]:valid,
      input[list="hsrStationList"]:valid,
      input[list="mrtStationList"]:valid {
          background-color: white !important;
      }

      #pane-left, #pane-right {
        animation: none;
      }

      .hidden {
        display: none;
      }

      .inactive {
          opacity: 0.4;
          transition: opacity 0.3s ease;
          pointer-events: none;
      }

      /* ---------------------------------------
       4. äº¤é€šå·¥å…·é¸å–®
    --------------------------------------- */
      .transport-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(120px, 1fr));
        grid-template-rows: repeat(2, auto);
        gap: 1.5rem;
        width: 90%;
        max-width: 700px;
        margin: 0 auto;
      }
      .transport-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0);
        border-radius: 32px;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
      }
      .transport-card img {
        width: 120px;
        height: 120px;
        object-fit: contain;
        margin-bottom: -10px;
      }

      .transport-card .label {
        font-family: "GenSenRounded2TW-R", sans-serif;
        font-size: 1.2rem;
        color: #6d808f;
        text-align: center;
        white-space: nowrap;
        letter-spacing: 6px;
      }

      .transport-card:hover {
        transform: translateY(-2px);
      }
      
      .transport-card.selected {
      -webkit-box-shadow:
      inset -7.5px -4.75px 1px -6.5px rgb(255, 255, 255), 
      inset 7.5px 4.75px 1px -6.5px rgb(255, 255, 255),
      inset -1.75px -7.5px 1px -6.75px rgb(255, 255, 255), 
      inset 1.75px 7.5px 1px -6.75px rgb(255, 255, 255),
      2px 2px 8px 0px rgba(110, 110, 110, 0.275);
      box-shadow:
      inset -7px -4.75px 1px -6.5px rgb(255, 255, 255), 
      inset 7px 4.75px 1px -6.5px rgb(255, 255, 255),
      inset -1.75px -7px 1px -6.75px rgb(255, 255, 255), 
      inset 1.75px 7px 1px -6.75px rgb(255, 255, 255),
      2px 2px 8px 0px rgba(110, 110, 110, 0.275);
      }

      /* ---------------------------------------
       5. åˆ‡æ›é–‹é—œå€å¡Š (Scene 2 & 4)
    --------------------------------------- */
      .toggle-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.6rem;
      }
      
      .add-trip-wrapper .input-group-MRT label {
        margin: 0;
      }

      .add-trip-wrapper .input-group-MRT .toggle-row {
      gap: 4px;
      font-size: 0.85rem;
      }

      .travel-card {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 1.25rem;
      }

      .toggle-card {
        display: flex;
        align-items: center;
        width: 40%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 32px;
        padding: 1rem 1.25rem;
        gap: 0.75rem;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .toggle-card::before {
      content: "";
      position: absolute;
      inset: 0;
      -webkit-box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: -1;
      border-radius: 32px;
      }

      .toggle-card span.label {
        font-family: "GenSenRounded2TW-R", sans-serif;
        color: #9c7a5c;
        line-height: 1.2;
        white-space: nowrap;
      }

      .nowrap-text {
        color: #6c808f;
        white-space: nowrap;
        font-family: "GenSenRounded2TW-L", sans-serif;
        letter-spacing: 6px;
      }

    .simple-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: none;
      border: none;
      box-shadow: none;
      padding: 0;
    }

    .simple-toggle .nowrap-text {
      color: #9c7a5c;
    }

      /* ---------------------------------------
       6. å‹•æ…‹æ¨¡æ¿å€åŸŸ (Scene 2 & 4)
    --------------------------------------- */
      .template-wrapper {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      width: 40%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 32px;
      padding: 0.5rem 1.25rem;
      gap: 1rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      }

      .template-wrapper::before {
      content: "";
      position: absolute;
      inset: 0;
      -webkit-box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      0 0 0 0.2px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      box-shadow:
      inset -8.5px -2.25px 0 -6.75px rgb(255, 255, 255), 
      inset 8.5px 2.25px 0 -6.75px rgb(255, 255, 255),
      inset -2.75px -8.5px 0 -7px rgb(255, 255, 255), 
      inset 2.75px 8.5px 0 -7px rgb(255, 255, 255),
      0 0 0 0.2px rgb(255, 255, 255),
      2px 2px 12px 0px rgba(110, 110, 110, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: -1;
      border-radius: 32px;
      }
      
      .template-row {
        display: flex;
        justify-content: center;
        width: 100%;
        gap: 32px;
      }

      .flight-level .input-group{
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .fuel-group .input-group, .toggle-card .add-trip-wrapper .input-group, .flight-time .input-group{
        display: flex;
        align-items: center;
        padding: 1.25rem 0;
        gap: 0.5rem;
      }

      .fuel-group .input-group label, .toggle-card .add-trip-wrapper .input-group label, .flight-level .input-group label, .flight-time .input-group label{
        font-family: "GenSenRounded2TW-R", sans-serif;
        font-size: 1rem;
        color: #9c7a5c;
        line-height: 1.2;
        white-space: nowrap;
      }

      .fuel-group .input-group input, .toggle-card .add-trip-wrapper .input-group input, .flight-level .input-group input, .flight-time .input-group input{
        font-family: "GenSenRounded2TW-L", sans-serif;
        width: 90px;
        padding: 0.5rem 0.5rem 0.5rem 0.75rem;
        border: 0.25pt solid #b5c1c623;
        border-radius: 8px;
        box-shadow: inset 2pt 2pt 7pt #6d808f70;
        background: #fff;
        font-size: 16px;
        color: #4a4a4a;
        letter-spacing: 3px;
        outline: none;
      }

      #travel-car-type-value {
        width: 120px;
      }

      
      .fuel-group .input-group input[type='checkbox'] {
        width: 0;
      }

      .input-group-MRT input {
        width: 120px;
        padding: 0.375rem 0.5rem 0.375rem 0.75rem;
        border: 0.25pt solid #b5c1c623;
        border-radius: 6px;
        background: #fff;
        font-size: 16px;
        color: #4a4a4a;
        box-shadow: inset 2pt 2pt 7pt #6d808f70;
        font-family: "GenSenRounded2TW-L", sans-serif;
        letter-spacing: 2px;
        outline: none;
      }

      .fuel-group .input-group input[type="number"]::-webkit-outer-spin-button,
      .fuel-group .input-group input[type="number"]::-webkit-inner-spin-button,
      .input-group-MRT input[type="number"]::-webkit-outer-spin-button,
      .input-group-MRT input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .fuel-group .input-group .special-label {
      font-family: "GenSenRounded2TW-L", sans-serif;
      font-weight: normal;
      color: #6c808f;
      margin: 0;
      }

      .input-group-MRT {
        display: flex;
        align-items: center;
        flex-direction: row;
        gap: 0.5rem;
        margin: 0.15rem 0;
      }

      .input-group-MRT label {
        margin: 0.15rem 0.75rem;
        font-size: 0.85rem;
        color: #9c7a5c;
        white-space: nowrap;
        font-family: "GenSenRounded2TW-R", sans-serif;
        letter-spacing: 6px;
      }

      .input-group-MRT .special-label {
        font-family: "GenSenRounded2TW-L", sans-serif;
        font-weight: normal;
        color: #6c808f;
      }

      .input-group-MRT select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 100px;
        padding: 8px 30px 8px 12px;
        border: 1px solid rgba(208, 210, 214, 0.6);
        border-radius: 6px;
        background: #fff url("images/ä¸‹æ‹‰å¼ç®­é ­.webp") no-repeat right center;
        background-size: 30px;
        box-shadow: inset 2pt 2pt 7pt #6d808f70;
        font-size: 16px;
        color: #4a4a4a;
      }

      .input-group-MRT .toggle-row input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      #scene-travel-2-3 .hidden {
        display: none !important;
      }
      #scene-travel-2-3 #flight-time-wrapper {
        width: calc(90% - 1.25rem);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 1rem;
      }

      .mrt-trip-list-wrapper {
        display: flex;
        flex-direction: column;
        height: 200px;
      }

      .trip-list {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: start;
        align-items: center;
        max-width: 100%;
        min-width: 100%;
        width: 100%;
        max-height: 200px;
        overflow-x: hidden;
        overflow-y: auto;
      }
      
      /* trip-list */
      .trip-item {
        font-family: "GenSenRounded2TW-L", sans-serif;
        display: flex;
        justify-content: center;
        text-align: left;
        width: 100%;
        max-width: 400px;
        font-size: 0.85rem;
        color: #6c808f;
        margin: 0.1rem;
        padding: 0.35rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
        position: relative;
      }

    .trip-item:hover {
      border-color: #3b82f6;
      background-color: #f8fafc;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .trip-item.selected {
      border-color: #10b981;
      background-color: #ecfdf5;
      color: #047857;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    .trip-item.selected:hover {
      border-color: #ef4444;
      background-color: #fef2f2;
      color: #dc2626;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }
    
    .trip-item::before {
      content: '';
      width: 0.75rem;
      height: 0.75rem;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      margin: auto 0.75rem;
      flex-shrink: 0;
      transition: all 0.3s ease;
      position: relative;
      background-color: white;
    }
    
    .trip-item:hover::before {
      border-color: #3b82f6;
    }
    
    .trip-item.selected::before {
      border-color: #10b981;
      background-color: #10b981;
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='m13.854 3.646-7.5 7.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6 10.293l7.146-7.147a.5.5 0 0 1 .708.708z'/%3e%3c/svg%3e");
      background-size: 12px 12px;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .trip-item.selected:hover::before {
      border-color: #ef4444;
      background-color: #ef4444;
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }
    
    .trip-item.selected::after {
      content: 'é»æ“Šå–æ¶ˆé¸æ“‡';
      position: absolute;
      top: -4px;
      right: 12px;
      background-color: #ef4444;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 10;
    }
    
    .trip-item.selected:hover::after {
      opacity: 1;
      transform: translateY(0);
    }
    
    .trip-item-text {
      flex: 1;
      display: flex;
      justify-content: space-between;
    }

    .selection-info {
      margin: 8px 0;
      padding: 8px 12px;
      background-color: #f1f5f9;
      border-radius: 6px;
      font-size: 12px;
      color: #475569;
      border-left: 3px solid #3b82f6;
    }
    
    .selection-info.has-selection {
      background-color: #ecfdf5;
      border-left-color: #10b981;
      color: #047857;
    }

      .add-trip-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        align-content: center;
        flex-direction: column;
      }

      .mrt-btn {
        width: 50%;
        margin: auto 0 0.25rem;
        align-self: center;
        background: rgba(240, 244, 252, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-radius: 32px;
        font-size: 0.85rem;
        font-weight: bold;
        color: rgba(0, 0, 0, 0.2);
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        padding: 6px 12px;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
        font-family: "GenSenRounded2TW-R", sans-serif;
      }

      .mrt-btn:hover {
        background-color: #eee;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      }

      .flight-select {
        font-family: 'GenSenRounded2TW-R', sans-serif;
        margin-left: 20px;
        padding: 8px 12px;
        border-radius: 8px;
      }

      @media (min-width: 320px) and (max-width: 600px) {
        .scene-1 .transport-grid {
          grid-template-columns: repeat(2, minmax(80px, 1fr));
          grid-template-rows: repeat(3, minmax(120px, 1fr));
        }
      }

      @media (min-width: 600px) and (max-width: 900px) {
        .scene-1 .transport-grid {
          grid-template-columns: repeat(2, minmax(120px, 1fr));
          grid-template-rows: repeat(3, auto);
        }
      }

      @media (max-width: 600px) {
        .scene-1 .transport-card img {
          width: 80px;
          height: 80px;
        }

        .scene-2 .travel-card .toggle-card {
          flex-direction: column;
          justify-content: center;
          padding: 2rem 1rem;
        }

        .scene-2 .travel-card .toggle-card .input-group, .scene-2 .travel-card .template-wrapper .input-group{
          flex-direction: column;
          padding: 0.5rem;
        }
      }

      @media (max-width: 900px) {
      .scene-2 .travel-card .toggle-card, .scene-2 .travel-card .template-wrapper, #scene-travel-2-3 #flight-time-wrapper  {
        width: 80%;
        padding: 1rem;
        justify-content: center;
      }
      
      .scene-2 .add-trip-wrapper {
        align-items: center;
        }

      .input-group-MRT {
        flex-direction: column;
      }

      .trip-item {
        text-align: center;
      }
    }
    </style>
  </head>

  <body>
    <!-- æ•…äº‹åŠ‡æƒ… -->
    <story-chatroom></story-chatroom>
    
    <!-- Scene 1: é¸è»Šç¨® -->
    <section id="scene-travel-1" class="scene scene-1">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>æ—¥å¸¸é€šå‹¤ä½¿ç”¨çš„äº¤é€šå·¥å…·</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="transport-grid">
          <div class="transport-card" onclick="toggleActivity(this,'æ±½è»Š')">
            <img src="images/æ±½è»Š.webp" alt="æ±½è»Š" />
            <span class="label">æ±½è»Š</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'éƒµè¼ª')">
            <img src="images/éƒµè¼ª.webp" alt="éƒµè¼ª" />
            <span class="label">éƒµè¼ª</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'é£›æ©Ÿ')">
            <img src="images/é£›æ©Ÿ.webp" alt="é£›æ©Ÿ" />
            <span class="label">é£›æ©Ÿ</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'æ·é‹')">
            <img src="images/æ·é‹.webp" alt="æ·é‹" />
            <span class="label">æ·é‹</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'ç«è»Š')">
            <img src="images/ç«è»Š.webp" alt="ç«è»Š" />
            <span class="label">ç«è»Š</span>
          </div>
          <div class="transport-card" onclick="toggleActivity(this,'é«˜éµ')">
            <img src="images/é«˜éµ.webp" alt="é«˜éµ" />
            <span class="label">é«˜éµ</span>
          </div>
        </div>
      </div>
        <button
          class="nav-btn prev-btn"
          onclick="window.location.href='home.html'"
        >
          â€¹
        </button>
        <!-- ç¬¬ä¸€é ä¸‹ä¸€é æŒ‰éˆ• -->
        <button class="nav-btn next-btn" onclick="handleFirstSceneNext()">
          â€º
        </button>
    </section>

    <!-- Scene 1: æ±½è»Š -->
    <section id="scene-travel-2-1" class="scene scene-2 car">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>æ±½è»Šä½¿ç”¨ç‹€æ³</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="travel-card">
          <!-- ç‡ƒæ–™é–‹é—œ -->
          <div class="toggle-card">
            <span class="label">é¸æ“‡<br />è»Šç¨®ç‡ƒæ–™</span>
            <div class="toggle-row">
              <span class="nowrap-text">æ²¹è»Š</span>
              <label class="toggle-switch">
                <input type="checkbox" id="travel-car-fuel-type-toggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">é›»è»Š</span>
            </div>
          </div>
          <!-- æ–¹æ³•é–‹é—œ -->
          <div class="toggle-card">
            <span class="label">é¸æ“‡<br />è¨ˆç®—æ–¹æ³•</span>
            <div class="toggle-row">
              <span class="nowrap-text">æ²¹é‡</span>
              <label class="toggle-switch">
                <input type="checkbox" id="travel-car-method-toggle" />
                <span class="slider"></span>
              </label>
              <span class="nowrap-text">è·é›¢</span>
            </div>
          </div>

          <div id="pane-left" class="template-wrapper">
            <div id="oil-left" class="fuel-group">
              <div class="input-group">
                <label>é¸æ“‡<br />æ±½æ²¹é¡å‹</label>
                <input list="car-oilList" id="travel-car-fuel-type-value" placeholder="92ç„¡é‰›"/>
                <datalist id="car-oilList"></datalist>
              </div>
              <div class="input-group">
                <label>æ¯é€±åŠ æ²¹</label>
                <input type="number" min="0" id="travel-car-oil-value" value="0" />
                <div class="toggle-row">
                  <label class="apple-toggle-switch">
                    <span class="nowrap-text">å…¬å‡</span>
                    <input type="checkbox" id="water-unit-toggle" />
                    <span class="slider"></span>
                    <span class="nowrap-text">å…ƒ&nbsp;</span>
                  </label>
                </div>
              </div>
            </div>
            <div id="electric-left" class="fuel-group hidden">
              <div class="input-group">
                <label>è¡Œé§›é‡Œç¨‹</label>
                <input type="number" min="0" id="travel-oilcar-distance-value" value="0"/>
                <label class="special-label">å…¬é‡Œ/é€±</label>
              </div>
            </div>
          </div>

          <div id="pane-right" class="template-wrapper inactive">
            <div id="oil-right" class="fuel-group">
              <div class="input-group">
                <label>é¸æ“‡<br />æ±½è»Šé¡å‹</label>
                <input list="carList" id="travel-car-type-value" placeholder="å°å‹æˆ¿è»Š"/>
                <datalist id="carList"></datalist>
              </div>
              <div class="input-group">
                <label>æ¯é€±è¡Œé§›</label>
                <input type="number" min="0" id="travel-EV-distance-value" value="0" />
                <label class="special-label">å…¬é‡Œ/é€±</label>
              </div>
            </div>
            <div id="electric-right" class="fuel-group hidden">
              <div class="input-group">
                <label>å¤–å‡ºå……é›»</label>
                <input type="number" min="0" id="travel-EV-charge-value" value="0"/>
                <label class="special-label">kWh/é€±</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button class="nav-btn prev-btn" onclick="goToPrevScene()">â€¹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">â€º</button>
    </section>

    <!-- Scene 2: éƒµè¼ª -->
    <section id="scene-travel-2-2" class="scene scene-2 cruise">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>éƒµè¼ªæ­ä¹˜æƒ…æ³</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="travel-card" data-type="cruise">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="travel-cruise-day-value">èˆªè¡Œå¤©æ•¸</label>
              <input id="travel-cruise-day-value" type="number" min="1"/>
              <label>å¤©</label>
            </div>
            <div class="input-group-MRT">
              <label for="travel-cruise-stayday-value">åœç•™å¤©æ•¸</label>
              <input id="travel-cruise-stayday-value" type="number" min="0"/>
              <label>å¤©</label>
            </div>
            <button id="addCruiseBtn" class="mrt-btn">æ–°å¢è¡Œç¨‹</button>
          </div>

          <div class="template-wrapper mrt-trip-list-wrapper" id="cruiseTripDisplay">
            <div class="trip-list"></div>
            <button id="removeCruiseBtn" class="mrt-btn">åˆªé™¤è¡Œç¨‹</button>
          </div>
        </div>
      
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">â€¹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">â€º</button>
    </section>
    <!-- ç»ç’ƒå¡ç‰‡ -->

   <!-- Scene 3: é£›æ©Ÿ -->
  <section id="scene-travel-2-3" class="scene scene-2 airplane">
    <Chapter-Bar></Chapter-Bar>
    <div class="slideContainer">
      <h1>é£›æ©Ÿæ­ä¹˜æƒ…æ³</h1>
      <div class="page-indicator">
        <div class="bar-container dynamic-bar-container"></div>
      </div>
    <!-- åˆ‡æ›é–‹é—œ -->
      <div class="travel-card" data-type="flight">
        <div class="toggle-card">
          <span class="label">é¸æ“‡<br/>è¨ˆç®—æ–¹å¼</span>
          <div class="toggle-row">
            <span class="nowrap-text">æ™‚é–“</span>
            <label class="toggle-switch">
              <input type="checkbox" id="travel-flight-method-toggle" />
              <span class="slider"></span>
            </label>
            <span class="nowrap-text">ç«™é»</span>
          </div>
        </div>
        <div class="toggle-card flight-level">
          <div class="input-group">
            <label>é¸æ“‡<br/>è‰™ç­‰</label>
            <input list="flightList" id="travel-flight-level-value" placeholder="ç¶“æ¿Ÿè‰™" />
            <datalist id="flightList"></datalist>
          </div>
        </div>

        <!-- æ™‚é–“æ¨¡å¼ï¼šä¸€æ•´å¡Šæ¿å­ -->
        <div id="flight-time-wrapper" class="template-wrapper flight-time">
          <div class="input-group-MRT">
            <label for="travel-flight-time-value" style="font-size: 1rem;">è¼¸å…¥å¹´åº¦ç¸½é£›è¡Œæ™‚æ•¸</label>
            <input id="travel-flight-time-value" type="number" min="0" />
            <label class="special-label" style="font-size: 1rem;">å°æ™‚</label>
          </div>
        </div>

        <!-- ç«™é»æ¨¡å¼ï¼šä¿ç•™åŸæœ¬çš„å·¦å³å…©å¡Š + åˆ—è¡¨ -->
        <div id="flight-station-wrapper" class="travel-card hidden" data-type="flight">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="flightStart">èµ·é»</label>
              <input list="airportStationList" id="flightStart" />
            </div>
            <div class="input-group-MRT">
              <label for="flightEnd">è¨–é»</label>
              <input list="airportStationList" id="flightEnd" />
              <datalist id="airportStationList"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="flightCount">è¶Ÿæ•¸</label>
              <input id="flightCount" type="number" min="1" />
              <div class="toggle-row">
                <label class="apple-toggle-switch">
                  <span class="nowrap-text">å–®ç¨‹</span>
                  <input type="checkbox" id="travelFlightRoundTripToggle" />
                  <span class="slider"></span>
                  <span class="nowrap-text">ä¾†å›</span>
                </label>
              </div>
            </div>
            <button class="mrt-btn" id="addFlightBtn">æ–°å¢èˆªç­</button>
          </div>
          <div class="template-wrapper mrt-trip-list-wrapper" id="flightTripDisplay">
            <div class="trip-list"><!-- trip-item --></div>
            <button class="mrt-btn" id="removeFlightBtn">åˆªé™¤è¡Œç¨‹</button>
          </div>
        </div>
      </div>
    </div>

      <button class="nav-btn prev-btn" onclick="goToPrevScene()">â€¹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">â€º</button>
  </section>

    <!-- Scene 4: æ·é‹ -->
    <section id="scene-travel-2-4" class="scene scene-2 mrt">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>æ·é‹ä½¿ç”¨æƒ…æ³</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="travel-card" data-type="mrt">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="mrtStart">é¸æ“‡èµ·é»</label>
              <input list="mrtStationList" id="mrtStart" />
            </div>
            <div class="input-group-MRT">
              <label for="mrtEnd">é¸æ“‡è¨–é»</label>
              <input list="mrtStationList" id="mrtEnd" />
              <datalist id="mrtStationList"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="mrtCount">æ¯æœˆè¶Ÿæ•¸</label>
              <input id="mrtCount" type="number" min="1" />
              <div class="toggle-row">
                <label class="apple-toggle-switch">
                  <span class="nowrap-text">å–®ç¨‹</span>
                  <input type="checkbox" id="travelMrtRoundTripToggle" />
                  <span class="slider"></span>
                  <span class="nowrap-text">ä¾†å›</span>
                </label>
              </div>
            </div>
            <button class="mrt-btn" >æ–°å¢è¡Œç¨‹</button>
          </div>

          <!-- é€™è£¡ä¸€å®šè¦åŠ ä¸Š id="mrtTripDisplay" -->
          <div class="template-wrapper mrt-trip-list-wrapper" id="mrtTripDisplay">
            <div class="trip-list"><!-- é€™è£¡æœƒå¡ trip-item --></div>
            <button class="mrt-btn">åˆªé™¤è¡Œç¨‹</button>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">â€¹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">â€º</button>
    </section>

    <!-- Scene 5: ç«è»Š -->
    <section id="scene-travel-2-5" class="scene scene-2 train">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>ç«è»Šä½¿ç”¨æƒ…æ³</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="travel-card" data-type="train">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="trainStart">é¸æ“‡èµ·é»</label>
              <input list="trDistanceMap" id="trainStart" />
            </div>
            <div class="input-group-MRT">
              <label for="trainEnd">é¸æ“‡è¨–é»</label>
              <input list="trDistanceMap" id="trainEnd" />
              <datalist id="trDistanceMap"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="trainCount">æ¯æœˆè¶Ÿæ•¸</label>
              <input id="trainCount" type="number" min="1" />
              <div class="toggle-row">
                <label class="apple-toggle-switch">
                  <span class="nowrap-text">å–®ç¨‹</span>
                  <input type="checkbox" id="travelTrainRoundTripToggle" />
                  <span class="slider"></span>
                  <span class="nowrap-text">ä¾†å›</span>
                </label>
              </div>
            </div>
            <button class="mrt-btn">æ–°å¢è¡Œç¨‹</button>
          </div>
          <div class="template-wrapper mrt-trip-list-wrapper" id="trainTripList">
            <div class="trip-list" ></div>
            <button class="mrt-btn">åˆªé™¤è¡Œç¨‹</button>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">â€¹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">â€º</button>
    </section>

    <!-- Scene 6: é«˜éµ -->
    <section id="scene-travel-2-6" class="scene scene-2 hsr">
      <Chapter-Bar></Chapter-Bar>
      <div class="slideContainer">
        <h1>é«˜éµä½¿ç”¨æƒ…æ³</h1>
        <div class="page-indicator">
          <div class="bar-container dynamic-bar-container"></div>
        </div>
        <div class="travel-card" data-type="hsr">
          <div class="template-wrapper add-trip-wrapper">
            <div class="input-group-MRT">
              <label for="hsrStart">é¸æ“‡èµ·é»</label>
              <input list="hsrStationList" id="hsrStart" />          
            </div>
            <div class="input-group-MRT">
              <label for="hsrEnd">é¸æ“‡è¨–é»</label>
              <input list="hsrStationList" id="hsrEnd" />
              <datalist id="hsrStationList"></datalist>
            </div>
            <div class="input-group-MRT">
              <label for="hsrCount">æ¯æœˆè¶Ÿæ•¸</label>
              <input id="hsrCount" type="number" min="1" />
              <div class="toggle-row">
                <label class="apple-toggle-switch">
                  <span class="nowrap-text">å–®ç¨‹</span>
                  <input type="checkbox" id="travelHsrRoundTripToggle" />
                  <span class="slider"></span>
                  <span class="nowrap-text">ä¾†å›</span>
                </label>
              </div>
            </div>
            <button class="mrt-btn">æ–°å¢è¡Œç¨‹</button>
          </div>
          <div class="template-wrapper mrt-trip-list-wrapper" id="hsrTripList">
            <div class="trip-list"></div>
            <button class="mrt-btn">åˆªé™¤è¡Œç¨‹</button>
          </div>
        </div>
      </div>
      <button class="nav-btn prev-btn" onclick="goToPrevScene()">â€¹</button>
      <button class="nav-btn next-btn" onclick="goToNextScene()">â€º</button>
    </section>

    <script src="./js/all.js"></script>
    <script type="module">
      import { saveSectionData, loadSectionData } from './js/firebase.js';

      // é é¢è¼‰å…¥æ™‚å›å¡«
      window.addEventListener('DOMContentLoaded', async () => {
        try {
          const data = await loadSectionData('traffic-travel');
          if (data) {
            // æ±½è»Š
            document.getElementById("travel-car-fuel-type-toggle").checked = data.travelCarFuelTypeToggle ?? false;
            document.getElementById("travel-car-method-toggle").checked = data.travelCarMethodToggle ?? false;

            // æ²¹è»Š
            document.getElementById("travel-car-fuel-type-value").value = data.travelCarFuelTypeValue ?? "92ç„¡é‰›";
            document.getElementById("travel-car-oil-value").value = data.travelCarOilValue ?? 0;
            document.getElementById("travel-oilcar-distance-value").value = data.travelOilcarDistanceValue ?? 0;
            document.getElementById("travel-car-type-value").value = data.travelCarTypeValue ?? "å°å‹æˆ¿è»Š";

            // é›»è»Š 
            document.getElementById("travel-EV-distance-value").value = data.travelEVDistanceValue ?? 0;
            document.getElementById("travel-EV-charge-value").value = data.travelEVChargeValue ?? 0;

            // éƒµè¼ª 
            document.getElementById("travel-cruise-day-value").value = data.travelCruiseDayValue ?? 0;
            document.getElementById("travel-cruise-stayday-value").value = data.travelCruiseStaydayValue ?? 0;

            // é£›æ©Ÿ
            document.getElementById("travel-flight-method-toggle").value = data.travelFlightMethodToggle ?? 0;
            document.getElementById("travel-flight-time-value").value = data.travelFlightTimeValue ?? 0;
            document.getElementById("travel-flight-level-value").value = data.travelFlightLevelValue ?? "ç¶“æ¿Ÿè‰™";
          }
        } catch (err) {
          console.error("è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š", err);
        }
      });

      // å„²å­˜è³‡æ–™ä¸¦è·³è½‰
      async function handleNext() {
        const mrtDistanceSum = sumTripDistance(mrtDistanceMap, "#mrtTripDisplay", "pair");
        const trainDistanceSum = sumTripDistance(trDistanceMap, "#trainTripList", "single");
        const hsrDistanceSum = sumTripDistance(hsrDistanceMap, "#hsrTripList", "pair");
        const flightDistanceSum = sumFlightDistance();
        const { sailTotal, stayTotal } = sumCruiseDays();

        console.log("æ·é‹ç¸½è·é›¢:", mrtDistanceSum);
        console.log("ç«è»Šç¸½è·é›¢:", trainDistanceSum);
        console.log("é«˜éµç¸½è·é›¢:", hsrDistanceSum);
        console.log("é£›æ©Ÿç¸½è·é›¢:", flightDistanceSum);
        console.log("éƒµè¼ªèˆªè¡Œå¤©æ•¸:", sailTotal);
        console.log("éƒµè¼ªåœç•™å¤©æ•¸:", stayTotal);

        const data = {
          // æ±½è»Š
          travelCarFuelTypeToggle: document.getElementById("travel-car-fuel-type-toggle").checked,
          travelCarMethodToggle: document.getElementById("travel-car-method-toggle").checked,
          
          // æ²¹è»Š
          travelCarFuelTypeValue: document.getElementById("travel-car-fuel-type-value").value || "92ç„¡é‰›",
          travelCarOilValue: document.getElementById("travel-car-oil-value").value || 0,
          travelOilcarDistanceValue: document.getElementById("travel-oilcar-distance-value").value || 0,
          travelCarTypeValue: document.getElementById("travel-car-type-value").value || "å°å‹æˆ¿è»Š",

          // é›»è»Š 
          travelEVDistanceValue: document.getElementById("travel-EV-distance-value").value || 0,
          travelEVChargeValue: document.getElementById("travel-EV-charge-value").value || 0,

          // é£›æ©Ÿ
          travelFlightMethodToggle: document.getElementById("travel-flight-method-toggle").checked,
          travelFlightTimeValue: document.getElementById("travel-flight-time-value").value || 0,
          travelFlightLevelValue: document.getElementById("travel-flight-level-value").value || "ç¶“æ¿Ÿè‰™",

          travelMRTDistanceTotal: mrtDistanceSum,
          travelTrainDistanceTotal: trainDistanceSum,
          travelHSRDistanceTotal: hsrDistanceSum,
          travelFlightDistanceTotal:flightDistanceSum,
          travelSailDayTotal: sailTotal, 
          travelstayDayTotal: stayTotal,
        };

        try {
          await saveSectionData('traffic-travel', data);
        } catch (err) {
          console.error("å„²å­˜è³‡æ–™å¤±æ•—ï¼š", err);
          alert("è³‡æ–™å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        }
      }

    document.querySelectorAll(".next-btn").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    document.querySelectorAll(".prev-btn").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    document.querySelectorAll(".chapter-button").forEach((btn) => {
      btn.addEventListener("click", handleNext);
    });
    </script>
    <script>
    // æ˜Ÿéš›èŠå¤©å®¤
      const messages = [
        {
          type: "time",
          text: "ä¸Šåˆ 9:30",
          time: 1000,
        },
        {
          text: "æ­¡è¿æ­ä¹˜ç¢³æ’èˆªç©º707æ¬¡ç­æ©Ÿï¼Œæœ¬æ¬¡èˆªç¨‹å°‡å¸¶æ‚¨é€²å…¥å™´å°„æ©Ÿèˆ‡å…¨çƒåŒ–çš„å¹´ä»£ï¼Œè«‹ç¹«å¥½å®‰å…¨å¸¶â€¦â€¦æˆ–è€…ï¼Œç·ŠæŠ±æœ¬å–µä¹Ÿè¡Œï¼",
          from: "cat",
          time: 2500,
        },
        {
          text: "é€™æ˜¯å“ªä¸€å¹´ï¼Ÿé£›æ©Ÿå‰›å‡ºç¾ï¼Ÿ",
          from: "user",
          time: 1500,
        },
        {
          text: "1958å¹´ã€‚æ³¢éŸ³707é¦–èˆªï¼Œå¾æ­¤ä¸–ç•Œè®Šå°äº†ï¼Œäººå€‘èƒ½å¤ å¹¾å°æ™‚å…§é£›è¶Šå¤§æ´²ã€‚æ–¼æ˜¯å•†æ¥­æ´»å‹•ã€æ—…éŠã€ç”šè‡³åœ‹éš›æˆ€æ„›ï¼Œå…¨éƒ½è®Šå¾—ç¨€é¬†å¹³å¸¸ã€‚",
          from: "cat",
          time: 2500,
        },
        {
          text: "æ‰€ä»¥æˆ‘æ˜¨å¤©é‚„åœ¨å€«æ•¦åƒæ—©é¤ï¼Œä»Šå¤©å°±èƒ½åœ¨å°åŒ—åƒé¹½é…¥é›å›‰ï¼",
          from: "user",
          time: 1700,
        },
        {
          text: "æ²’éŒ¯ï¼å…¨çƒçš„å•†æ¥­æ´»å‹•ç¬é–“åŠ é€Ÿï¼Œä½†ä¹Ÿæ„å‘³è‘—åŒ–çŸ³ç‡ƒæ–™çš„éœ€æ±‚çˆ†ç‚¸æ€§æˆé•·ã€‚é£›æ©Ÿç•™ä¸‹çš„ç™½ç…™ï¼Œå°é«˜ç©ºå¤§æ°£å±¤çš„å½±éŸ¿æ¯”åœ°é¢é‚„è¦åš´é‡ã€‚",
          from: "cat",
        },
      ];

        let currentScene = "scene-travel-1";

        function goToNextScene() {
          // å–å¾—ç›®å‰å ´æ™¯åœ¨ä½¿ç”¨è€…é¸å–æ´»å‹•ä¸­çš„ä½ç½®
          const currentIndex = selectedActivities.findIndex(
            (activity) => activityScenes[activity] === currentScene
          );

          // æ˜¯æœ€å¾Œä¸€å€‹å ´æ™¯ â†’ å°å‘çµæœé 
          if (currentIndex === selectedActivities.length - 1) {
            window.location.href = "food.html";
            return;
          }

          // é‚„æœ‰ä¸‹ä¸€é  â†’ å–å¾—ä¸‹ä¸€å€‹æ´»å‹•çš„ sceneIdï¼Œè·³è½‰
          const nextActivity = selectedActivities[currentIndex + 1];
          const nextSceneId = activityScenes[nextActivity];
          if (nextSceneId) {
            goToScene(nextSceneId);
          }
        }

        function goToPrevScene() {
          const currentIndex = selectedActivities.findIndex(
            (activity) => activityScenes[activity] === currentScene
          );

          // æ˜¯ç¬¬ä¸€å€‹é¸æ“‡çš„æ´»å‹• â†’ å›åˆ° scene-travel-1
          if (currentIndex === 0) {
            goToScene("scene-travel-1");
            return;
          }

          // é‚„æœ‰ä¸Šä¸€é  â†’ è·³åˆ°ä¸Šä¸€å€‹æ´»å‹•é é¢
          const prevActivity = selectedActivities[currentIndex - 1];
          const prevSceneId = activityScenes[prevActivity];
          if (prevSceneId) {
            goToScene(prevSceneId);
          }
        }

        function handleFirstSceneNext() {
          // å›ºå®šé †åº
          const fullOrder = [
            "æ±½è»Š",
            "éƒµè¼ª",
            "é£›æ©Ÿ",
            "æ·é‹",
            "ç«è»Š",
            "é«˜éµ",
          ];

          // éæ¿¾é¸å–çš„é …ç›®ä¸¦ä¾ç…§å›ºå®šé †åºæ’åº
          const sortedActivities = fullOrder.filter((activity) =>
            selectedActivities.includes(activity)
          );

          // æ›´æ–°é™£åˆ—
          selectedActivities.length = 0;
          selectedActivities.push(...sortedActivities);

          if (selectedActivities.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹äº¤é€šå·¥å…·ï¼");
            return;
          }

          const firstScene = activityScenes[selectedActivities[0]];
          goToScene(firstScene);
        }

        const selectedActivities = []; // å„²å­˜é¸å–çš„é …ç›®
        const activityScenes = {
          æ±½è»Š: "scene-travel-2-1",
          éƒµè¼ª: "scene-travel-2-2",
          é£›æ©Ÿ: "scene-travel-2-3",
          æ·é‹: "scene-travel-2-4",
          ç«è»Š: "scene-travel-2-5",
          é«˜éµ: "scene-travel-2-6",
        };

        function toggleActivity(card, activity) {
          const index = selectedActivities.indexOf(activity);

          if (index === -1) {
            selectedActivities.push(activity);
            card.classList.add("selected");
          } else {
            selectedActivities.splice(index, 1);
            card.classList.remove("selected");
          }

          updatePageIndicators();
        }

        // barè·³è½‰é é¢

        function goToScene(targetId) {
          document.getElementById(currentScene).classList.remove("active");
          document.getElementById(targetId).classList.add("active");
          currentScene = targetId;
          updatePageIndicators();
          updateNavButtonsVisibility();
        }

      function updatePageIndicators() {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");

        if (!container) return;
        container.innerHTML = "";

        // ğŸ‘‰ 1. å…ˆåŠ ä¸Šã€Œé¸æ“‡é ã€çš„ barï¼ˆæ°¸é æ˜¯ç¬¬ä¸€å€‹ï¼‰
        const selectHitArea = document.createElement("div");
        selectHitArea.classList.add("bar-hit-area");

        const selectBar = document.createElement("span");
        selectBar.classList.add("bar");

        // å¦‚æœç¾åœ¨é é¢æ˜¯ scene-travel-1ï¼Œè¨­å®š active ç‹€æ…‹
        if (currentScene === "scene-travel-1") {
          selectBar.classList.add("active");
        }

        selectHitArea.appendChild(selectBar);
        selectHitArea.onclick = () => {
          goToScene("scene-travel-1");
          updateBarActive(0); // ç¬¬ä¸€å€‹ bar æ˜¯ index 0
        };
        container.appendChild(selectHitArea);

        // ğŸ‘‰ 2. ä¾æ“šé¸åˆ°çš„ activity åŠ ä¸Šå°æ‡‰ bar
        selectedActivities.forEach((activity, idx) => {
          const sceneId = activityScenes[activity];
          if (!sceneId) return;

          const hitArea = document.createElement("div");
          hitArea.classList.add("bar-hit-area");

          const bar = document.createElement("span");
          bar.classList.add("bar");

          // æ³¨æ„ï¼šå› ç‚ºç¬¬ä¸€å€‹ bar æ˜¯é¸æ“‡é ï¼Œé€™é‚Šæ˜¯ idx+1
          if (currentScene === sceneId) {
            bar.classList.add("active");
          }

          hitArea.appendChild(bar);

          hitArea.onclick = () => {
            goToScene(sceneId);
            updateBarActive(idx + 1);
          };

          container.appendChild(hitArea);
        });
      }

      function updateNavButtonsVisibility() {
        const sceneEl = document.getElementById(currentScene);

        // å–å¾—æŒ‰éˆ•ï¼ˆç”¨ querySelector æ‰¾ç•¶å‰ scene è£¡çš„æŒ‰éˆ•ï¼‰
        const prevBtn = sceneEl.querySelector(".prev-btn");
        const nextBtn = sceneEl.querySelector(".next-btn");

        // å…¨éƒ¨å…ˆéš±è—
        document.querySelectorAll(".prev-btn, .next-btn").forEach(btn => {
          btn.style.display = "none";
        });

        // é€™å€‹ scene æœ‰çš„æ‰é¡¯ç¤º
        if (prevBtn) prevBtn.style.display = "block";
        if (nextBtn) nextBtn.style.display = "block";
      }


      function updateBarActive(activeIndex) {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");
        if (!container) return;

        const bars = container.querySelectorAll(".bar-hit-area .bar");
        bars.forEach((bar, idx) => {
          if (idx === activeIndex) {
            bar.classList.add("active");
          } else {
            bar.classList.remove("active");
          }
        });
      }

      function goToScene(targetId) {
        document.getElementById(currentScene).classList.remove("active");
        document.getElementById(targetId).classList.add("active");
        currentScene = targetId;
        updatePageIndicators();
        updateNavButtonsVisibility();
      }

      function updateNavButtonsVisibility() {
        const sceneEl = document.getElementById(currentScene);

        const prevBtn = sceneEl.querySelector(".prev-btn");
        const nextBtn = sceneEl.querySelector(".next-btn");

        document.querySelectorAll(".prev-btn, .next-btn").forEach((btn) => {
          btn.style.display = "none";
        });

        if (prevBtn) prevBtn.style.display = "block";
        if (nextBtn) nextBtn.style.display = "block";
      }

      function updatePageIndicators() {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");

        if (!container) return;
        container.innerHTML = "";

        // â¤ ç¬¬ä¸€å€‹ barï¼šé¸æ“‡äº¤é€šå·¥å…·é é¢
        const selectHitArea = document.createElement("div");
        selectHitArea.classList.add("bar-hit-area");

        const selectBar = document.createElement("span");
        selectBar.classList.add("bar");

        if (currentScene === "scene-travel-1") {
          selectBar.classList.add("active");
        }

        selectHitArea.appendChild(selectBar);
        selectHitArea.onclick = () => {
          goToScene("scene-travel-1");
          updateBarActive(0);
        };
        container.appendChild(selectHitArea);
          // ğŸ‘‰ 2. ä¾æ“šé¸åˆ°çš„ activity åŠ ä¸Šå°æ‡‰ bar
        selectedActivities.forEach((activity, idx) => {
          const sceneId = activityScenes[activity];
          if (!sceneId) return;

          const hitArea = document.createElement("div");
          hitArea.classList.add("bar-hit-area");

          const bar = document.createElement("span");
          bar.classList.add("bar");

          // æ³¨æ„ï¼šå› ç‚ºç¬¬ä¸€å€‹ bar æ˜¯é¸æ“‡é ï¼Œé€™é‚Šæ˜¯ idx+1
          if (currentScene === sceneId) {
            bar.classList.add("active");
          }

          hitArea.appendChild(bar);

          hitArea.onclick = () => {
            goToScene(sceneId);
            updateBarActive(idx + 1);
          };

          container.appendChild(hitArea);
        });
      }

      function updateBarActive(activeIndex) {
        const scene = document.getElementById(currentScene);
        const container = scene.querySelector(".dynamic-bar-container");
        if (!container) return;

        const bars = container.querySelectorAll(".bar-hit-area .bar");
        bars.forEach((bar, idx) => {
          bar.classList.toggle("active", idx === activeIndex);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        currentScene = "scene-travel-1";
        updatePageIndicators();
        updateNavButtonsVisibility();
      });


// ä¿®æ”¹åŸæœ‰çš„ setupToggle å‡½æ•¸ï¼ŒåŠ å…¥å‹•æ…‹æ–‡å­—æ›´æ–°åŠŸèƒ½
function setupToggle(fuelId, methodId, oilLeftId, oilRightId, elecLeftId, elecRightId, paneLeftId, paneRightId) {
    const fuelToggle   = document.getElementById(fuelId);
    const methodToggle = document.getElementById(methodId);
    const oilLeft      = document.getElementById(oilLeftId);
    const oilRight     = document.getElementById(oilRightId);
    const elecLeft     = document.getElementById(elecLeftId);
    const elecRight    = document.getElementById(elecRightId);
    const paneLeft     = document.getElementById(paneLeftId);
    const paneRight    = document.getElementById(paneRightId);

    // æ–°å¢ï¼šæ‰¾åˆ°è¨ˆç®—æ–¹æ³•æ–‡å­—å…ƒç´ 
    let methodLeftSpan = null;
    if (methodToggle) {
        const methodToggleCard = methodToggle.closest('.toggle-card');
        if (methodToggleCard) {
            methodLeftSpan = methodToggleCard.querySelector('.toggle-row .nowrap-text:first-child');
        }
    }

    function updateFuel() {
        const isElec = fuelToggle.checked;
        
        // åŸæœ‰çš„ç‡ƒæ–™åˆ‡æ›é‚è¼¯
        if (oilLeft) oilLeft.classList.toggle("hidden", isElec);
        if (oilRight) oilRight.classList.toggle("hidden", isElec);
        if (elecLeft) elecLeft.classList.toggle("hidden", !isElec);
        if (elecRight) elecRight.classList.toggle("hidden", !isElec);
        
        // æ–°å¢ï¼šæ›´æ–°è¨ˆç®—æ–¹æ³•æ–‡å­—
        if (methodLeftSpan) {
            methodLeftSpan.textContent = isElec ? 'é›»é‡' : 'æ²¹é‡';
        }
    }
    
    function updateMethod() {
        const isVol = methodToggle.checked;
        
        // åŸæœ‰çš„æ–¹æ³•åˆ‡æ›é‚è¼¯
        if (paneLeft) paneLeft.classList.toggle("inactive", isVol);
        if (paneRight) paneRight.classList.toggle("inactive", !isVol);
    }
    
    if (fuelToggle && methodToggle) {
        fuelToggle.addEventListener("change", () => { 
            updateFuel(); 
            updateMethod(); 
        });
        methodToggle.addEventListener("change", updateMethod);
        
        // åˆå§‹åŒ–
        updateFuel();
        updateMethod();
    }
}
// ===== è·é›¢è¨ˆç®—å‡½æ•¸ =====
function haversine(a, b) {
  const toRad = x => x * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
  const h = Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1) * Math.cos(lat2);
  return 2 * R * Math.asin(Math.sqrt(h));
}

// ===== å…¨åŸŸè®Šæ•¸ =====
let airportCoords = {}, mrtDistanceMap = {}, trDistanceMap = {}, hsrDistanceMap = {};

document.addEventListener("DOMContentLoaded", () => {
  // è¨­ç½®æ±½è»Šçš„åˆ‡æ›åŠŸèƒ½
  setupToggle("travel-car-fuel-type-toggle", "travel-car-method-toggle", "oil-left", "oil-right", "electric-left", "electric-right", "pane-left", "pane-right");

//æ±½æ²¹é¸é …

let oilData = {
  "92ç„¡é‰›": "92ç„¡é‰›",
  "95ç„¡é‰›": "95ç„¡é‰›",
  "98ç„¡é‰›": "98ç„¡é‰›",
  "æŸ´æ²¹": "æŸ´æ²¹"
};

const carOilList = document.getElementById("car-oilList");

for (let key in oilData) {
  const option = document.createElement("option");
  option.value = oilData[key];
  carOilList.appendChild(option);
}

//æ±½è»Šé¸é …

let carData = {
  "å°å‹æˆ¿è»Š": "å°å‹æˆ¿è»Š", 
  "ä¸­å‹æˆ¿è»Š": "ä¸­å‹æˆ¿è»Š", 
  "å¤§å‹æˆ¿è»Š": "å¤§å‹æˆ¿è»Š", 
  "å°å‹ä¼‘æ—…è»Š": "å°å‹ä¼‘æ—…è»Š", 
  "ä¸­å‹ä¼‘æ—…è»Š": "ä¸­å‹ä¼‘æ—…è»Š", 
  "å¤§å‹ä¼‘æ—…è»Š": "å¤§å‹ä¼‘æ—…è»Š"
}

const carList = document.getElementById("carList");

for (let key in carData) {
  const option = document.createElement("option");
  option.value = carData[key];
  carList.appendChild(option);
}

//é£›æ©Ÿè‰™ç­‰é¸é …
let flightData = {
  "ç¶“æ¿Ÿè‰™": "ç¶“æ¿Ÿè‰™", 
  "è±ªè¯ç¶“æ¿Ÿè‰™": "è±ªè¯ç¶“æ¿Ÿè‰™", 
  "å•†å‹™è‰™": "å•†å‹™è‰™",
  "é ­ç­‰è‰™": "é ­ç­‰è‰™"
}

const flightList = document.getElementById("flightList");

for (let key in flightData) {
  const option = document.createElement("option");
  option.value = flightData[key];
  flightList.appendChild(option);
}


let flightStationArray = [];

fetch("./data/AirportDistanceMap.json")
  .then(r => r.json())
  .then(data => {
    // è¼‰å…¥åº§æ¨™æ•¸æ“šï¼ˆé€™å€‹å¾ˆé‡è¦ï¼Œæ‚¨çš„åŸä»£ç¢¼ç¼ºå°‘é€™éƒ¨åˆ†ï¼‰
    data.forEach(({ iata_code, latitude_deg, longitude_deg }) => {
      if (iata_code) {
        airportCoords[iata_code.toUpperCase()] = { 
          lat: latitude_deg, 
          lng: longitude_deg 
        };
      }
    });

    // ç”¨ Set æ”¶é›†æ‰€æœ‰ iata_codeï¼Œé¿å…é‡è¤‡ä¸”è½‰å¤§å¯«
    const airportSet = new Set();
    data.forEach(item => {
      if (item.iata_code) {
        airportSet.add(item.iata_code.toUpperCase());
      }
    });

    flightStationArray = Array.from(airportSet);

    // æ›´æ–°é¸é …çš„å‡½æ•¸
    function updateFlightOptions(searchTerm = '') {
      const dl = document.getElementById("airportStationList");
      if (!dl) return;
      
      dl.innerHTML = '';
      const query = searchTerm.toUpperCase();

      let filteredAirports;
      
      if (query.length === 0) {
        // æ²’æœ‰è¼¸å…¥æ™‚ï¼Œé¡¯ç¤ºæ‰€æœ‰æ©Ÿå ´æŒ‰å­—æ¯é †åº
        filteredAirports = [...flightStationArray].sort((a, b) => a.localeCompare(b));
      } else {
        // æœ‰è¼¸å…¥æ™‚ï¼Œé€²è¡Œæ™ºèƒ½æ’åº
        filteredAirports = flightStationArray
          .filter(code => code.includes(query))
          .sort((a, b) => {
            // 1. ä»£ç¢¼å®Œå…¨åŒ¹é…
            if (a === query) return -1;
            if (b === query) return 1;

            // 2. ä»£ç¢¼é–‹é ­åŒ¹é…
            const aStarts = a.startsWith(query);
            const bStarts = b.startsWith(query);
            if (aStarts && !bStarts) return -1;
            if (!aStarts && bStarts) return 1;

            // 3. å¦‚æœéƒ½æ˜¯é–‹é ­åŒ¹é…ï¼ŒæŒ‰å­—æ¯é †åºæ’åˆ—
            if (aStarts && bStarts) return a.localeCompare(b);

            // 4. å…¶ä»–æƒ…æ³æŒ‰åŒ…å«ä½ç½®æ’åº
            const aIndex = a.indexOf(query);
            const bIndex = b.indexOf(query);
            if (aIndex !== bIndex) return aIndex - bIndex;

            // 5. æœ€å¾ŒæŒ‰å­—æ¯é †åº
            return a.localeCompare(b);
          })
      }

      filteredAirports.forEach(code => {
        const o = document.createElement('option');
        o.value = code;
        dl.appendChild(o);
      });
    }

    // ç¶å®šè¼¸å…¥äº‹ä»¶
    const flightStartInput = document.getElementById("flightStart");
    const flightEndInput = document.getElementById("flightEnd");
    
    if (flightStartInput) {
      flightStartInput.addEventListener('input', function() {
        updateFlightOptions(this.value);
      });
      
      flightStartInput.addEventListener('focus', function() {
        updateFlightOptions(this.value);
      });
    }
    
    if (flightEndInput) {
      flightEndInput.addEventListener('input', function() {
        updateFlightOptions(this.value);
      });
      
      flightEndInput.addEventListener('focus', function() {
        updateFlightOptions(this.value);
      });
    }

    // åˆå§‹è¼‰å…¥æ‰€æœ‰é¸é …
    updateFlightOptions();
  })
  .catch(err => console.log("Flight data not loaded:", err));

// å„ªåŒ–çš„æ·é‹ã€ç«è»Šã€é«˜éµç«™åæœç´¢åŠŸèƒ½

// æ·é‹æ•¸æ“šè¼‰å…¥èˆ‡æœç´¢åŠŸèƒ½
fetch("./data/mrtDistanceMap.json").then(r => r.json()).then(data => {
    mrtDistanceMap = data;
    const dl = document.getElementById("mrtStationList");
    if (dl) {
        // æ”¶é›†æ‰€æœ‰æ·é‹ç«™å
        const allStations = new Set(Object.keys(data).flatMap(k => k.split("_")));
        const stationsArray = Array.from(allStations);
        
        // å‰µå»ºå„ªåŒ–çš„é¸é …é¡¯ç¤ºå‡½æ•¸
        function updateMrtOptions(searchTerm = '') {
            // æ¸…ç©ºç¾æœ‰é¸é …
            dl.innerHTML = '';
            
            let matchingStations = stationsArray;
            
            if (searchTerm) {
                // åˆ†é¡åŒ¹é…çš„ç«™å
                const startsWithMatch = [];
                const containsMatch = [];
                
                stationsArray.forEach(station => {
                    if (station.startsWith(searchTerm)) {
                        startsWithMatch.push(station);
                    } else if (station.includes(searchTerm)) {
                        containsMatch.push(station);
                    }
                });
                
                // åˆä½µçµæœï¼šå„ªå…ˆé¡¯ç¤ºé–‹é ­åŒ¹é…çš„
                matchingStations = [...startsWithMatch.sort(), ...containsMatch.sort()];
            }
            
            matchingStations.forEach(st => {
              const o = document.createElement("option");
              o.value = st;
              dl.appendChild(o);
            });
        }
        
        // åˆå§‹è¼‰å…¥æ‰€æœ‰é¸é …
        updateMrtOptions();

    }
}).catch(err => console.log("MRT data not loaded:", err));

// ç«è»Šæ•¸æ“šè¼‰å…¥èˆ‡æœç´¢åŠŸèƒ½
fetch("./data/trDistanceMap.json").then(r => r.json()).then(data => {
    trDistanceMap = data;
    const dl = document.getElementById("trDistanceMap");
    if (dl) {
        // æ”¶é›†æ‰€æœ‰ç«è»Šç«™å
        const stations = new Set();
        if (typeof data === 'object') {
            Object.keys(data).forEach(key => {
                stations.add(key);
                if (typeof data[key] === 'object') {
                    Object.keys(data[key]).forEach(subKey => stations.add(subKey));
                }
            });
        }
        
        const stationsArray = Array.from(stations);
        
        // å‰µå»ºå„ªåŒ–çš„é¸é …é¡¯ç¤ºå‡½æ•¸
        function updateTrOptions(searchTerm = '') {
            // æ¸…ç©ºç¾æœ‰é¸é …
            dl.innerHTML = '';
            
            let matchingStations = stationsArray;
            
            if (searchTerm) {
                // åˆ†é¡åŒ¹é…çš„ç«™å
                const startsWithMatch = [];
                const containsMatch = [];
                
                stationsArray.forEach(station => {
                    if (station.startsWith(searchTerm)) {
                        startsWithMatch.push(station);
                    } else if (station.includes(searchTerm)) {
                        containsMatch.push(station);
                    }
                });
                
                // åˆä½µçµæœï¼šå„ªå…ˆé¡¯ç¤ºé–‹é ­åŒ¹é…çš„
                matchingStations = [...startsWithMatch.sort(), ...containsMatch.sort()];
            }
            
            matchingStations.forEach(st => {
              const o = document.createElement("option");
              o.value = st;
              dl.appendChild(o);
            });
        }
        
        // åˆå§‹è¼‰å…¥æ‰€æœ‰é¸é …
        updateTrOptions();
        
    }
}).catch(err => console.log("Train data not loaded:", err));

// é«˜éµæ•¸æ“šè¼‰å…¥èˆ‡æœç´¢åŠŸèƒ½
fetch("./data/hsrDistanceMap.json").then(r => r.json()).then(data => {
    hsrDistanceMap = data;
    const dl = document.getElementById("hsrStationList");
    if (dl) {
        // æ”¶é›†æ‰€æœ‰é«˜éµç«™å
        const allStations = new Set(Object.keys(data).flatMap(k => k.split("_")));
        const stationsArray = Array.from(allStations);
        
        // å‰µå»ºå„ªåŒ–çš„é¸é …é¡¯ç¤ºå‡½æ•¸
        function updateHsrOptions(searchTerm = '') {
            // æ¸…ç©ºç¾æœ‰é¸é …
            dl.innerHTML = '';
            
            let matchingStations = stationsArray;
            
            if (searchTerm) {
                // åˆ†é¡åŒ¹é…çš„ç«™å
                const startsWithMatch = [];
                const containsMatch = [];
                
                stationsArray.forEach(station => {
                    if (station.startsWith(searchTerm)) {
                        startsWithMatch.push(station);
                    } else if (station.includes(searchTerm)) {
                        containsMatch.push(station);
                    }
                });
                
                // åˆä½µçµæœï¼šå„ªå…ˆé¡¯ç¤ºé–‹é ­åŒ¹é…çš„
                matchingStations = [...startsWithMatch.sort(), ...containsMatch.sort()];
            }
            matchingStations.forEach(st => {
              const o = document.createElement("option");
              o.value = st;
              dl.appendChild(o);
            });
        }
        
        // åˆå§‹è¼‰å…¥æ‰€æœ‰é¸é …
        updateHsrOptions();
        

    }
}).catch(err => console.log("HSR data not loaded:", err));

  // 4. é£›æ©Ÿæ¨¡å¼åˆ‡æ›
  const modeToggle = document.getElementById("travel-flight-method-toggle");
  const timeWrap = document.getElementById("flight-time-wrapper");
  const stationWrap = document.getElementById("flight-station-wrapper");
  
  if (modeToggle && timeWrap && stationWrap) {
    modeToggle.addEventListener("change", () => {
      const isStation = modeToggle.checked;
      timeWrap.classList.toggle("hidden", isStation);
      stationWrap.classList.toggle("hidden", !isStation);
    });
    timeWrap.classList.remove("hidden");
    stationWrap.classList.add("hidden");
  }

  // 5. ç¶å®šæ‰€æœ‰æŒ‰éˆ•
  const buttons = [
    { id: "addCruiseBtn", fn: addCruiseTrip },
    { id: "removeCruiseBtn", fn: removeCruiseTrip },
    { id: "addFlightBtn", fn: addFlightTrip },
    { id: "removeFlightBtn", fn: removeFlightTrip }
  ];

  buttons.forEach(({ id, fn }) => {
    const btn = document.getElementById(id);
    if (btn) btn.addEventListener("click", fn);
  });

  // æ·é‹æŒ‰éˆ•
  const mrtAddBtn = document.querySelector("#scene-travel-2-4 .add-trip-wrapper .mrt-btn");
  const mrtRemoveBtn = document.querySelector("#scene-travel-2-4 .mrt-trip-list-wrapper .mrt-btn");
  if (mrtAddBtn) mrtAddBtn.addEventListener("click", addMRTTrip);
  if (mrtRemoveBtn) mrtRemoveBtn.addEventListener("click", removeMRTTrip);
  
  // ç«è»ŠæŒ‰éˆ•
  const trainAddBtn = document.querySelector("#scene-travel-2-5 .add-trip-wrapper .mrt-btn");
  const trainRemoveBtn = document.querySelector("#scene-travel-2-5 .mrt-trip-list-wrapper .mrt-btn");
  if (trainAddBtn) trainAddBtn.addEventListener("click", addTrainTrip);
  if (trainRemoveBtn) trainRemoveBtn.addEventListener("click", removeTrainTrip);
  
  // é«˜éµæŒ‰éˆ•
  const hsrAddBtn = document.querySelector("#scene-travel-2-6 .add-trip-wrapper .mrt-btn");
  const hsrRemoveBtn = document.querySelector("#scene-travel-2-6 .mrt-trip-list-wrapper .mrt-btn");
  if (hsrAddBtn) hsrAddBtn.addEventListener("click", addHsrTrip);
  if (hsrRemoveBtn) hsrRemoveBtn.addEventListener("click", removeHsrTrip);

  // è¨­ç½®é¸å–åŠŸèƒ½ - åœ¨æŒ‰éˆ•ç¶å®šä¹‹å¾Œ
  setupTripListSelection();
});

// ===== æ›´æ–°é¸å–è³‡è¨Š =====
function updateSelectionInfo(container) {
  // ç§»é™¤é¸å–è³‡è¨Šé¡¯ç¤ºåŠŸèƒ½ï¼Œåƒ…ä¿ç•™å‡½æ•¸çµæ§‹ä»¥ç¶­æŒå…¼å®¹æ€§
}

// ===== é¸å–åŠŸèƒ½è¨­å®š =====
function setupTripListSelection() {
  const tripContainers = [
    "#cruiseTripDisplay .trip-list",
    "#mrtTripDisplay .trip-list", 
    "#flightTripDisplay .trip-list",
    "#trainTripList",
    "#hsrTripList"
  ];

  tripContainers.forEach(selector => {
    const container = document.querySelector(selector);
    if (container && !container.hasAttribute('data-selection-setup')) {
      // ç¶å®šé»æ“Šäº‹ä»¶
      container.addEventListener("click", e => {
        const item = e.target.closest(".trip-item");
        if (!item) return;
        
        // é˜»æ­¢äº‹ä»¶å†’æ³¡
        e.stopPropagation();
        e.preventDefault();
        
        // åˆ‡æ›é¸å–ç‹€æ…‹ï¼ˆå¤šé¸æ¨¡å¼ï¼‰
        item.classList.toggle("selected");
      });
      
      // æ¨™è¨˜å·²è¨­ç½®
      container.setAttribute('data-selection-setup', 'true');
    }
  });
}

// ===== è£½ä½œå¯é¸å–é …ç›® =====
function makeSelectable(item) {
  item.classList.add("trip-item");
  
  // ç¢ºä¿é …ç›®å¯ä»¥è¢«é»æ“Š
  item.style.cursor = "pointer";
  item.style.userSelect = "none";
  
  return item;
}

// ===== é€šç”¨è¡Œç¨‹æ–°å¢å‡½æ•¸ =====
function addTrip({ map, startId, endId, countId, displaySelector, distanceType = "pair", roundTripToggleId = null }) {
  const s = document.getElementById(startId).value.trim();
  const e = document.getElementById(endId).value.trim();
  const c = parseInt(document.getElementById(countId).value, 10) || 0;

  let dist;

  if (distanceType === "pair") {
    // ç”¨ "A_B" æˆ– "B_A" æŸ¥æ‰¾è·é›¢
    dist = map[`${s}_${e}`] ?? map[`${e}_${s}`];
  } else if (distanceType === "difference") {
    if (map[s] === undefined || map[e] === undefined) {
      const notFound = [s, e].filter(x => map[x] === undefined).join("ã€");
      return alert(`æ‰¾ä¸åˆ°è»Šç«™: ${notFound}`);
    }
    dist = Math.abs(map[s] - map[e]);
  }

  if (dist === undefined) return alert("ç„¡æ³•æ‰¾åˆ°æ­¤èµ·è¨–é»çš„è·é›¢");

  // æª¢æŸ¥æ˜¯å¦ç‚ºä¾†å›è¡Œç¨‹
  const isRound = roundTripToggleId ? document.getElementById(roundTripToggleId).checked : false;
  const type = isRound ? "ä¾†å›" : "å–®ç¨‹";
  
  const item = document.createElement("div");
  item.className = "trip-item";
  item.dataset.start = s;
  item.dataset.end = e;
  item.dataset.count = c;
  item.dataset.dist = dist;
  item.dataset.isRound = isRound;

  item.innerHTML = `<span class="trip-item-text"><span class="trip-item-text-left">${s} â†’ ${e}</span> <span class="trip-item-text-right">${c}è¶Ÿ ${type}</span></span>`;
  makeSelectable(item);

  const list = document.querySelector(`${displaySelector} .trip-list`);
  list.appendChild(item);

  // æ¸…ç©ºæ¬„ä½
  document.getElementById(startId).value = "";
  document.getElementById(endId).value = "";
  document.getElementById(countId).value = "";
}

// ===== é€šç”¨åˆªé™¤å‡½æ•¸ =====
function deleteTrip(displaySelector) {
  const list = document.querySelector(`${displaySelector} .trip-list`);
  if (!list) return alert("æ‰¾ä¸åˆ°è¡Œç¨‹åˆ—è¡¨");

  const selected = list.querySelectorAll(".trip-item.selected");
  if (selected.length > 0) {
    selected.forEach(item => item.remove());
  } else {
    const last = list.querySelector(".trip-item:last-child");
    if (last) last.remove();
    else alert("æ²’æœ‰è¡Œç¨‹å¯åˆªé™¤");
  }
}

// ===== æ·é‹åŠŸèƒ½ =====
function addMRTTrip() {
  addTrip({
    map: mrtDistanceMap,
    startId: "mrtStart",
    endId: "mrtEnd",
    countId: "mrtCount",
    displaySelector: "#mrtTripDisplay",
    distanceType: "pair",
    roundTripToggleId: "travelMrtRoundTripToggle"
  });
}
function removeMRTTrip() {
  deleteTrip("#mrtTripDisplay");
}

// ===== ç«è»ŠåŠŸèƒ½ =====
function addTrainTrip() {
  addTrip({
    map: trDistanceMap,
    startId: "trainStart",
    endId: "trainEnd",
    countId: "trainCount",
    displaySelector: "#trainTripList",
    distanceType: "difference",
    roundTripToggleId: "travelTrainRoundTripToggle"
  });
}
function removeTrainTrip() {
  deleteTrip("#trainTripList");
}

// ===== é«˜éµåŠŸèƒ½ =====
function addHsrTrip() {
  addTrip({
    map: hsrDistanceMap,
    startId: "hsrStart",
    endId: "hsrEnd",
    countId: "hsrCount",
    displaySelector: "#hsrTripList",
    distanceType: "pair",
    roundTripToggleId: "travelHsrRoundTripToggle"
  });
}
function removeHsrTrip() {
  deleteTrip("#hsrTripList");
}

// ===== éƒµè¼ªåŠŸèƒ½ï¼ˆèˆªè¡Œå¤©æ•¸ï¼‹åœç•™å¤©æ•¸ï¼‰ =====
function addCruiseTrip() {
  const sail = parseInt(document.getElementById("travel-cruise-day-value").value, 10) || 0;
  const stay = parseInt(document.getElementById("travel-cruise-stayday-value").value, 10) || 0;
  if (sail < 0 || stay < 0) return alert("å¤©æ•¸ä¸èƒ½æ˜¯è² æ•¸");
  if (sail === 0 && stay === 0) return alert("è«‹è¼¸å…¥èˆªè¡Œå¤©æ•¸æˆ–åœç•™å¤©æ•¸");

  const item = document.createElement("div");
  item.className = "trip-item";
  item.dataset.count = 1;
  item.dataset.sail = sail;
  item.dataset.stay = stay;

  item.innerHTML = `<span class="trip-item-text">èˆªè¡Œ${sail}å¤©ï¼Œåœç•™${stay}å¤©ï¼ˆå…±${sail + stay}å¤©ï¼‰</span>`;
  makeSelectable(item);

  const list = document.querySelector("#cruiseTripDisplay .trip-list");
  list.appendChild(item);

  document.getElementById("travel-cruise-day-value").value = "";
  document.getElementById("travel-cruise-stayday-value").value = "";
}
function removeCruiseTrip() {
  deleteTrip("#cruiseTripDisplay");
}

// ===== é£›æ©Ÿè¡Œç¨‹åŠŸèƒ½ =====
function addFlightTrip() {
  const list = document.querySelector("#flightTripDisplay .trip-list");
  if (!list) return alert("æ‰¾ä¸åˆ°èˆªç­åˆ—è¡¨");
  
  const item = document.createElement("div");
  
  if (document.getElementById("travel-flight-method-toggle").checked) {
    // ç«™é»æ¨¡å¼
    const s = document.getElementById("flightStart").value.trim();
    const e = document.getElementById("flightEnd").value.trim();
    const c = parseInt(document.getElementById("flightCount").value, 10) || 0;

    const dist = parseFloat(haversine(airportCoords[s], airportCoords[e]).toFixed(2));
    const isRound = document.getElementById("travelFlightRoundTripToggle").checked;
    const type = isRound ? "ä¾†å›" : "å–®ç¨‹";
    
    item.innerHTML = `<span class="trip-item-text"><span class="trip-item-text-left">${s} â†’ ${e}</span> <span class="trip-item-text-right">${c}è¶Ÿ ${type}</span></span>`;
    
    document.getElementById("flightStart").value = "";
    document.getElementById("flightEnd").value = "";
    document.getElementById("flightCount").value = "";
  } else {
    // æ™‚é–“æ¨¡å¼
    const h = parseFloat(document.getElementById("travel-flight-time-value").value) || 0;
    if (h <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé£›è¡Œæ™‚æ•¸");
    
    item.innerHTML = `<span class="trip-item-text">é£›è¡Œæ™‚æ•¸ï¼š${h} å°æ™‚</span>`;
    
    document.getElementById("travel-flight-time-value").value = "";
  }
  
  makeSelectable(item);
  list.appendChild(item);
  updateSelectionInfo(list);
}

function removeFlightTrip() {
  deleteTrip("#flightTripDisplay");
}

// ===== æ›´æ–°è·é›¢è¨ˆç®—å‡½æ•¸ä»¥æ”¯æ´å–®ç¨‹/ä¾†å› =====
function sumTripDistance(map, containerSelector, type = "pair") {
  const container = document.querySelector(containerSelector);
  if (!container) {
    console.warn(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerSelector}`);
    return 0;
  }

  const list = container.querySelector(".trip-list");
  if (!list) {
    console.warn(`æ‰¾ä¸åˆ° .trip-list æ–¼ ${containerSelector}`);
    return 0;
  }

  let total = 0;

  list.querySelectorAll(".trip-item").forEach(item => {
    const text = item.innerText.replace(/\s+/g, ' ').trim();
    // æ›´æ–°æ­£å‰‡è¡¨é”å¼ä»¥åŒ¹é…å–®ç¨‹/ä¾†å›
    const match = text.match(/^(.+?) â†’ (.+?) (\d+)è¶Ÿ (ä¾†å›|å–®ç¨‹)$/);
    if (!match) return;

    const [_, start, end, countStr, tripType] = match;
    const count = parseInt(countStr);

    if (type === "pair") {
      const key = `${start}_${end}`;
      const reverseKey = `${end}_${start}`;
      const dist = map[key] ?? map[reverseKey];

      if (dist != null) {
        let distance = dist * count;
        // å¦‚æœæ˜¯ä¾†å›ï¼Œè·é›¢è¦ä¹˜ä»¥2
        if (tripType === "ä¾†å›") {
          distance *= 2;
        }
        total += distance;
      } else {
        console.warn(`æ‰¾ä¸åˆ°é…å°è·é›¢: ${key}`);
      }

    } else if (type === "single") {
      const startDist = map[start];
      const endDist = map[end];

      if (startDist != null && endDist != null) {
        let segmentDistance = Math.abs(endDist - startDist) * count;
        // å¦‚æœæ˜¯ä¾†å›ï¼Œè·é›¢è¦ä¹˜ä»¥2
        if (tripType === "ä¾†å›") {
          segmentDistance *= 2;
        }
        total += segmentDistance;
      } else {
        console.warn(`æ‰¾ä¸åˆ°å–®ç«™è·é›¢: ${start} æˆ– ${end}`);
      }
    }
  });

  return total;
}

function sumFlightDistance() {
  const container = document.querySelector("#flightTripDisplay");
  if (!container) {
    console.warn("æ‰¾ä¸åˆ° flightTripDisplay å®¹å™¨");
    return 0;
  }

  const list = container.querySelector(".trip-list");
  if (!list) {
    console.warn("æ‰¾ä¸åˆ° .trip-list æ–¼ #flightTripDisplay");
    return 0;
  }

  let total = 0;

  list.querySelectorAll(".trip-item").forEach(item => {
    const text = item.innerText.replace(/\s+/g, ' ').trim();

    // é£›è¡Œæ™‚æ•¸æ¨¡å¼ï¼šé£›è¡Œæ™‚æ•¸ï¼š5 å°æ™‚
    const timeMatch = text.match(/^é£›è¡Œæ™‚æ•¸ï¼š(\d+(?:\.\d+)?) å°æ™‚$/);
    if (timeMatch) {
      const hours = parseFloat(timeMatch[1]);
      // å¹³å‡æ¯å°æ™‚é£›è¡Œè·é›¢ï¼šç´„ 900 å…¬é‡Œï¼ˆè¦–èˆªç©ºæ©Ÿå‹è€Œç•°ï¼‰
      total += hours * 900;
      return;
    }

    // ç«™é»æ¨¡å¼ï¼šTPE â†’ LAX 2è¶Ÿ ä¾†å›
    const pairMatch = text.match(/^(.+?) â†’ (.+?) (\d+)è¶Ÿ (ä¾†å›|å–®ç¨‹)$/);
    if (pairMatch) {
      const [_, start, end, countStr, type] = pairMatch;
      const count = parseInt(countStr);
      const coordStart = airportCoords[start];
      const coordEnd = airportCoords[end];

      if (!coordStart || !coordEnd) {
        console.warn(`æ‰¾ä¸åˆ°åº§æ¨™ï¼š${start} æˆ– ${end}`);
        return;
      }

      let distance = haversine(coordStart, coordEnd); // å–®ç¨‹è·é›¢
      if (type === "ä¾†å›") distance *= 2;

      total += distance * count;
    }
  });

  return parseFloat(total.toFixed(2));
}

function sumCruiseDays() {
  let sailTotal = 0;
  let stayTotal = 0;
  document.querySelectorAll("#cruiseTripDisplay .trip-item").forEach(item => {
    sailTotal += parseInt(item.dataset.sail || 0, 10);
    stayTotal += parseInt(item.dataset.stay || 0, 10);
  });
  return { sailTotal, stayTotal };
}

const allInputs = document.querySelectorAll('input');

allInputs.forEach(input => {
  input.addEventListener('focus', () => {
    input.placeholder = '';
    input.value = '';
  });

    input.addEventListener('change', () => {
    input.blur(); // è‡ªå‹•å¤±ç„¦
  });
});

document.querySelectorAll(".travel-card").forEach(card => {
  const type = card.dataset.type;

  card.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (type === "mrt") {
        addMRTTrip();
      } else if (type === "train") {
        addTrainTrip();
      } else if (type === "hsr") {
        addHSRTrip();
      } else if (type === "flight") {
        addFlightTrip();
      } else if (type === "cruise") {
        addCruiseTrip();
      }
    }
  });
});
  </script>

  </body>
</html>


